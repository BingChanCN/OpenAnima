---
phase: 13-visual-drag-and-drop-editor
plan: 02
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - src/OpenAnima.Core/Components/Shared/NodeCard.razor
  - src/OpenAnima.Core/Components/Shared/ConnectionLine.razor
  - src/OpenAnima.Core/Components/Shared/EditorCanvas.razor
  - src/OpenAnima.Core/Services/EditorStateService.cs
autonomous: true
requirements:
  - EDIT-03

must_haves:
  truths:
    - "User can see nodes on canvas as styled cards with title bar, port dots, and port names"
    - "User can drag from an output port circle to an input port circle and see a dashed bezier preview"
    - "Dropping on a compatible input port creates a solid bezier connection colored by source port type"
    - "User can move nodes by dragging their title bar and connections follow"
  artifacts:
    - path: "src/OpenAnima.Core/Components/Shared/NodeCard.razor"
      provides: "SVG node card with title bar, input ports on left, output ports on right"
      min_lines: 60
    - path: "src/OpenAnima.Core/Components/Shared/ConnectionLine.razor"
      provides: "SVG bezier curve connection between two ports"
      min_lines: 30
  key_links:
    - from: "NodeCard.razor"
      to: "IPortRegistry"
      via: "Gets port metadata for the module to render port circles"
      pattern: "IPortRegistry.*GetPorts"
    - from: "NodeCard.razor"
      to: "EditorStateService"
      via: "Port mousedown starts connection drag, node mousedown starts node drag"
      pattern: "StartConnectionDrag|StartNodeDrag"
    - from: "ConnectionLine.razor"
      to: "EditorStateService"
      via: "Reads source/target port positions to compute bezier path"
      pattern: "GetBezierPath|GetPortPosition"
    - from: "EditorCanvas.razor"
      to: "NodeCard.razor + ConnectionLine.razor"
      via: "Renders NodeCard for each node and ConnectionLine for each connection"
      pattern: "<NodeCard|<ConnectionLine"
---

<objective>
Build node card visuals and port-to-port connection drawing with bezier curves. Nodes display as Unreal Blueprint-style cards with colored port circles. Users can drag from output ports to input ports to create connections with a live bezier preview.

Purpose: This is the core visual interaction — seeing modules as cards and wiring them together with curves.
Output: NodeCard and ConnectionLine components, connection drag-to-create flow.
</objective>

<execution_context>
@/home/user/.claude/get-shit-done/workflows/execute-plan.md
@/home/user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-visual-drag-and-drop-editor/13-CONTEXT.md
@.planning/phases/13-visual-drag-and-drop-editor/13-RESEARCH.md
@.planning/phases/13-visual-drag-and-drop-editor/13-01-SUMMARY.md

@src/OpenAnima.Core/Services/EditorStateService.cs
@src/OpenAnima.Core/Components/Shared/EditorCanvas.razor

<interfaces>
<!-- Contracts from Plan 01 that this plan builds on -->

From EditorStateService.cs (created in Plan 01):
- WiringConfiguration Configuration (nodes + connections)
- double Scale, PanX, PanY (canvas transform)
- Point ScreenToCanvas(double screenX, double screenY)
- void AddNode(string moduleName, double canvasX, double canvasY)
- event Action? OnStateChanged

From WiringConfiguration.cs:
```csharp
public record ModuleNode { string ModuleId, string ModuleName, VisualPosition Position, VisualSize Size }
public record PortConnection { string SourceModuleId, SourcePortName, TargetModuleId, TargetPortName }
public record VisualPosition { double X, double Y }
public record VisualSize(double Width, double Height);
```

From PortMetadata.cs:
```csharp
public record PortMetadata(string Name, PortType Type, PortDirection Direction, string ModuleName);
public enum PortType { Text = 0, Trigger = 1 }
public enum PortDirection { Input = 0, Output = 1 }
```

From PortColors.cs:
```csharp
PortColors.GetHex(PortType.Text) => "#4A90D9" (blue)
PortColors.GetHex(PortType.Trigger) => "#E8943A" (orange)
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create NodeCard component with port rendering and node dragging</name>
  <files>
    src/OpenAnima.Core/Components/Shared/NodeCard.razor
    src/OpenAnima.Core/Services/EditorStateService.cs
    src/OpenAnima.Core/Components/Shared/EditorCanvas.razor
  </files>
  <action>
1. Create `NodeCard.razor` as an SVG group component (`<g>` element, not HTML div — it lives inside the SVG canvas):
   - Parameters: `[Parameter] ModuleNode Node`, `[Parameter] bool IsSelected`
   - Inject `IPortRegistry` to get ports for `Node.ModuleName`
   - Layout (all SVG elements positioned relative to Node.Position):
     - Outer `<g transform="translate(@Node.Position.X, @Node.Position.Y)">`
     - Background: `<rect>` with rounded corners (rx=8), fill=#1c1e2e (surface-card), stroke=#2a2d3e (border-color). When IsSelected, stroke=#6c8cff (accent-color), stroke-width=2.
     - Title bar: `<rect>` at top (height ~28px), slightly darker fill (#161822), rounded top corners. `<text>` with module name, fill=#e4e6f0, font-size 13px.
     - Input ports (left side): For each port where Direction==Input, render at x=0, y=(titleHeight + index*24 + 12):
       - `<circle cx="0" cy="{portY}" r="6" fill="{PortColors.GetHex(port.Type)}" />` — the colored dot
       - `<text x="14" y="{portY+4}">{port.Name}</text>` — port label, fill=#8b8fa3
     - Output ports (right side): For each port where Direction==Output, render at x=nodeWidth, y=(titleHeight + index*24 + 12):
       - `<circle cx="{nodeWidth}" cy="{portY}" r="6" fill="{PortColors.GetHex(port.Type)}" />`
       - `<text x="{nodeWidth-14}" y="{portY+4}" text-anchor="end">{port.Name}</text>`
     - Status placeholder: small circle in title bar corner (gray, for Phase 14 runtime status)
     - Compute node height dynamically: titleHeight + max(inputPorts.Count, outputPorts.Count) * 24 + padding
     - Node width: fixed 200px (from VisualSize default)

2. Add node dragging to EditorStateService:
   - `void StartNodeDrag(string moduleId, double mouseCanvasX, double mouseCanvasY)` — sets IsDraggingNode=true, DraggingNodeId, computes offset from node position
   - `void UpdateNodeDrag(double mouseCanvasX, double mouseCanvasY)` — updates node position (Position = new VisualPosition with offset applied)
   - `void EndNodeDrag()` — clears drag state, fires OnStateChanged

3. Wire node dragging in NodeCard: `@onmousedown="HandleNodeMouseDown"` on the title bar rect. This calls `_editorState.StartNodeDrag(Node.ModuleId, canvasX, canvasY)`. The EditorCanvas mousemove handler (already throttled from Plan 01) calls `_editorState.UpdateNodeDrag()` when IsDraggingNode is true. Mouseup calls `EndNodeDrag()`.

4. Add port position calculation to EditorStateService:
   - `Point GetPortPosition(string moduleId, string portName, PortDirection direction)` — computes absolute canvas position of a port circle based on node position + port index offset. This is needed by ConnectionLine to know where to draw curves.

5. Update EditorCanvas to render `<NodeCard>` for each node instead of placeholder rectangles. Also add port mousedown handling: when user mousedowns on a port circle, start connection drag (see Task 2).

6. Add `@onmousedown:stopPropagation` on NodeCard's outer group to prevent canvas pan when clicking on nodes.
  </action>
  <verify>
    <automated>cd /home/user/OpenAnima && dotnet build src/OpenAnima.Core/OpenAnima.Core.csproj --no-restore 2>&1 | tail -5</automated>
  </verify>
  <done>Nodes render as styled cards with title bar, colored port circles on left (input) and right (output), port names visible. Nodes can be dragged by title bar. Port positions are calculable for connection drawing.</done>
</task>

<task type="auto">
  <name>Task 2: Create ConnectionLine component and port-to-port drag-to-connect</name>
  <files>
    src/OpenAnima.Core/Components/Shared/ConnectionLine.razor
    src/OpenAnima.Core/Services/EditorStateService.cs
    src/OpenAnima.Core/Components/Shared/EditorCanvas.razor
  </files>
  <action>
1. Create `ConnectionLine.razor` — SVG path component for bezier curves:
   - Parameters: `[Parameter] Point Start`, `[Parameter] Point End`, `[Parameter] string Color`, `[Parameter] bool IsPreview`, `[Parameter] bool IsSelected`
   - Render cubic bezier using SVG path C command:
     ```
     var dx = Math.Abs(End.X - Start.X) * 0.5;
     var cp1 = (Start.X + dx, Start.Y);
     var cp2 = (End.X - dx, End.Y);
     path d="M {Start.X} {Start.Y} C {cp1.X} {cp1.Y}, {cp2.X} {cp2.Y}, {End.X} {End.Y}"
     ```
   - Stroke color = Color parameter (from PortColors.GetHex of source port type)
   - If IsPreview: stroke-dasharray="8 4", stroke-opacity=0.7 (dashed preview line)
   - If IsSelected: stroke-width=3, brighter color (add filter or use lighter shade)
   - If not preview and not selected: stroke-width=2, solid line
   - Hit area: render an invisible wider path underneath (`stroke="transparent" stroke-width="12" pointer-events="stroke"`) for click detection. Add `@onclick` on this invisible path to select the connection.

2. Add connection drag state to EditorStateService:
   - `bool IsDraggingConnection`
   - `string? DragSourceModuleId`, `string? DragSourcePortName`, `PortType? DragSourcePortType`
   - `double DragCurrentX`, `double DragCurrentY` (current mouse position in canvas coords for preview)
   - `void StartConnectionDrag(string moduleId, string portName, PortType portType, double canvasX, double canvasY)` — sets drag state, only allowed from Output ports
   - `void UpdateConnectionDrag(double canvasX, double canvasY)` — updates preview endpoint
   - `void EndConnectionDrag(string? targetModuleId, string? targetPortName, PortType? targetPortType)`:
     - If target is valid Input port with compatible type (same PortType as source), create PortConnection and add to Configuration.Connections
     - If target is null or incompatible, cancel (no connection created)
     - Clear drag state, fire OnStateChanged

3. Wire connection drag in EditorCanvas:
   - During mousemove, if IsDraggingConnection, call UpdateConnectionDrag with canvas coordinates
   - Render existing connections: for each PortConnection in Configuration.Connections, compute start/end positions using GetPortPosition, render `<ConnectionLine Start=start End=end Color=portColor IsPreview=false />`
   - Render preview connection: if IsDraggingConnection, render `<ConnectionLine Start=sourcePortPos End=(DragCurrentX,DragCurrentY) Color=sourcePortColor IsPreview=true />`
   - On mouseup over a port circle (in NodeCard), call EndConnectionDrag with target port info
   - On mouseup over empty space, call EndConnectionDrag(null, null, null) to cancel

4. Wire port interaction in NodeCard:
   - Output port circles: `@onmousedown="@(() => StartConnectionDrag(port))"` — starts connection drag from this output port
   - Input port circles: `@onmouseup="@(() => EndConnectionOnPort(port))"` — completes connection on this input port
   - Add visual feedback: when IsDraggingConnection and hovering over a compatible input port, highlight the port circle (brighter color or glow effect). When incompatible, show red tint.
   - Port type validation: only allow connections where source PortType == target PortType (per PORT-02 requirement)
  </action>
  <verify>
    <automated>cd /home/user/OpenAnima && dotnet build src/OpenAnima.Core/OpenAnima.Core.csproj --no-restore 2>&1 | tail -5</automated>
  </verify>
  <done>Connections render as colored bezier curves between ports. Dragging from output port shows dashed preview curve following mouse. Dropping on compatible input port creates solid connection. Incompatible ports rejected. Connections have invisible wider hit area for click selection.</done>
</task>

</tasks>

<verification>
1. `dotnet build` succeeds with no errors
2. `dotnet test` — all existing tests still pass
3. Nodes display as styled cards with title bar, colored port dots, port names
4. Dragging from output port to input port creates bezier connection
5. Preview curve follows mouse during connection drag (dashed line)
6. Incompatible port types are rejected
7. Connections colored by source port type
</verification>

<success_criteria>
- Nodes render as Unreal Blueprint-style cards with title bar, input ports on left, output ports on right
- Port circles colored by type (Text=blue, Trigger=orange)
- Nodes draggable by title bar, connections follow
- Dragging from output port shows dashed bezier preview
- Dropping on compatible input port creates solid bezier connection
- Connection color matches source port type
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/13-visual-drag-and-drop-editor/13-02-SUMMARY.md`
</output>

---
phase: 13-visual-drag-and-drop-editor
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/OpenAnima.Core/Components/Pages/Editor.razor
  - src/OpenAnima.Core/Components/Pages/Editor.razor.cs
  - src/OpenAnima.Core/Components/Pages/Editor.razor.css
  - src/OpenAnima.Core/Components/Shared/EditorCanvas.razor
  - src/OpenAnima.Core/Components/Shared/ModulePalette.razor
  - src/OpenAnima.Core/Services/EditorStateService.cs
  - src/OpenAnima.Core/Components/Layout/MainLayout.razor
autonomous: true
requirements:
  - EDIT-01
  - EDIT-02

must_haves:
  truths:
    - "User can see the Editor page with SVG canvas and module palette sidebar"
    - "User can pan the canvas by dragging the background"
    - "User can zoom the canvas with mouse wheel centered on cursor"
    - "User can drag a module from the palette onto the canvas and a node appears at drop location"
  artifacts:
    - path: "src/OpenAnima.Core/Services/EditorStateService.cs"
      provides: "Central editor state: nodes, connections, selection, pan/zoom, drag tracking"
      min_lines: 80
    - path: "src/OpenAnima.Core/Components/Pages/Editor.razor"
      provides: "Editor page with canvas and palette layout"
    - path: "src/OpenAnima.Core/Components/Shared/EditorCanvas.razor"
      provides: "SVG canvas with pan/zoom transform matrix"
      min_lines: 40
    - path: "src/OpenAnima.Core/Components/Shared/ModulePalette.razor"
      provides: "Right sidebar with draggable module list and search filter"
      min_lines: 30
  key_links:
    - from: "ModulePalette.razor"
      to: "EditorStateService"
      via: "ondragstart sets dragged module name"
      pattern: "_editorState\\.DraggedModuleName"
    - from: "EditorCanvas.razor"
      to: "EditorStateService"
      via: "ondrop adds node at canvas coordinates"
      pattern: "AddNode|ScreenToCanvas"
    - from: "Editor.razor"
      to: "IPortRegistry"
      via: "DI injection to get available modules and their ports"
      pattern: "IPortRegistry"
---

<objective>
Create the Editor page with SVG canvas (pan/zoom), module palette sidebar, and EditorStateService. Users can navigate to /editor, see available modules in a right-side palette, drag modules onto the canvas, and pan/zoom the canvas.

Purpose: Establishes the visual editor foundation that all subsequent plans build on — canvas rendering, state management, and module placement.
Output: Working editor page with draggable palette and interactive SVG canvas.
</objective>

<execution_context>
@/home/user/.claude/get-shit-done/workflows/execute-plan.md
@/home/user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-visual-drag-and-drop-editor/13-CONTEXT.md
@.planning/phases/13-visual-drag-and-drop-editor/13-RESEARCH.md

@src/OpenAnima.Core/Components/Layout/MainLayout.razor
@src/OpenAnima.Core/Components/Shared/PortIndicator.razor
@src/OpenAnima.Core/wwwroot/css/app.css

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From src/OpenAnima.Core/Wiring/WiringConfiguration.cs:
```csharp
public record WiringConfiguration
{
    public string Name { get; init; } = string.Empty;
    public string Version { get; init; } = "1.0";
    public List<ModuleNode> Nodes { get; init; } = new();
    public List<PortConnection> Connections { get; init; } = new();
}

public record ModuleNode
{
    public string ModuleId { get; init; } = string.Empty;
    public string ModuleName { get; init; } = string.Empty;
    public VisualPosition Position { get; init; } = new();
    public VisualSize Size { get; init; } = new(200, 100);
}

public record VisualPosition { public double X { get; init; } public double Y { get; init; } }
public record VisualSize(double Width, double Height);
```

From src/OpenAnima.Core/Ports/IPortRegistry.cs:
```csharp
public interface IPortRegistry
{
    void RegisterPorts(string moduleName, List<PortMetadata> ports);
    List<PortMetadata> GetPorts(string moduleName);
    List<PortMetadata> GetAllPorts();
    void UnregisterPorts(string moduleName);
}
```

From src/OpenAnima.Contracts/Ports/PortMetadata.cs:
```csharp
public record PortMetadata(string Name, PortType Type, PortDirection Direction, string ModuleName)
{
    public string Id => $"{ModuleName}.{Direction}.{Name}";
}
```

From src/OpenAnima.Contracts/Ports/PortColors.cs:
```csharp
public static class PortColors
{
    public static string GetHex(PortType type) => type switch
    {
        PortType.Text => "#4A90D9",
        PortType.Trigger => "#E8943A",
        _ => "#888888"
    };
}
```

CSS variables from app.css:
```css
--bg-primary: #0f1117; --surface-dark: #161822; --surface-card: #1c1e2e;
--text-primary: #e4e6f0; --text-secondary: #8b8fa3; --accent-color: #6c8cff;
--border-color: #2a2d3e; --hover-bg: rgba(108, 140, 255, 0.08);
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create EditorStateService and Editor page with SVG canvas pan/zoom</name>
  <files>
    src/OpenAnima.Core/Services/EditorStateService.cs
    src/OpenAnima.Core/Components/Pages/Editor.razor
    src/OpenAnima.Core/Components/Pages/Editor.razor.cs
    src/OpenAnima.Core/Components/Pages/Editor.razor.css
    src/OpenAnima.Core/Components/Shared/EditorCanvas.razor
    src/OpenAnima.Core/Components/Layout/MainLayout.razor
  </files>
  <action>
1. Create `EditorStateService.cs` as a scoped service (register in DI alongside wiring services in WiringServiceExtensions.cs or a new EditorServiceExtensions.cs). This service holds:
   - `WiringConfiguration Configuration` (the current graph — nodes + connections)
   - `double Scale = 1.0`, `double PanX = 0`, `double PanY = 0` (canvas transform)
   - `string? DraggedModuleName` (palette drag tracking)
   - `HashSet<string> SelectedNodeIds`, `HashSet<string> SelectedConnectionIds`
   - `bool IsDraggingNode`, `string? DraggingNodeId`, `double DragOffsetX/Y` (node move tracking)
   - `bool IsDraggingConnection`, connection drag state (source port info + current mouse position)
   - `event Action? OnStateChanged` for notifying components
   - `Point ScreenToCanvas(double screenX, double screenY)` — inverse transform: `((screenX - panX) / scale, (screenY - panY) / scale)`
   - `void AddNode(string moduleName, double canvasX, double canvasY)` — creates ModuleNode with Guid.NewGuid() moduleId, sets Position
   - `void RemoveNode(string moduleId)` — removes node and all its connections
   - `void RemoveConnection(string sourceModuleId, string sourcePortName, string targetModuleId, string targetPortName)`
   - `void SelectNode(string moduleId, bool addToSelection = false)` / `void SelectConnection(...)` / `void ClearSelection()`
   - `void DeleteSelected()` — removes all selected nodes and connections

2. Create `EditorCanvas.razor` — SVG element filling available space:
   - `<svg>` with `@onwheel="HandleWheel"`, `@onmousedown="HandleMouseDown"`, `@onmousemove="HandleMouseMove"`, `@onmouseup="HandleMouseUp"`
   - Inner `<g transform="matrix(@_state.Scale 0 0 @_state.Scale @_state.PanX @_state.PanY)">` wrapping all content
   - Grid background pattern (subtle dots or lines at 20px intervals, rendered via SVG `<pattern>`)
   - Pan: on mousedown on background (not on a node), set isPanning=true, track offset. On mousemove while panning, update PanX/PanY. On mouseup, stop panning.
   - Zoom: on wheel, multiply scale by 0.9 (zoom out) or 1.1 (zoom in), clamp to 0.1-3.0 range. Adjust PanX/PanY to keep mouse position fixed: `panX = mouseX - scale * (mouseX - panX) / oldScale`, same for Y.
   - CRITICAL: Throttle StateHasChanged during mousemove to 50ms using DateTime comparison (see research Pattern 2). Update internal state immediately, only call StateHasChanged if 50ms elapsed since last render.
   - Render placeholder rectangles for each node in `_state.Configuration.Nodes` (Plan 02 replaces with NodeCard component).
   - Use `@ondragover:preventDefault` and `@ondrop="HandleDrop"` for palette drops. On drop, call `_state.ScreenToCanvas()` to convert drop coordinates, then `_state.AddNode()`.

3. Create `Editor.razor` page at `@page "/editor"`:
   - Inject `EditorStateService`, `IPortRegistry`, `IConfigurationLoader`, `IWiringEngine`
   - Layout: flex row with canvas taking remaining space, palette on right (~220px fixed width)
   - Subscribe to `_state.OnStateChanged` in OnInitialized, call StateHasChanged. Unsubscribe in Dispose (implement IDisposable).
   - On initialization, check if WiringEngine has a loaded configuration (`IWiringEngine.GetCurrentConfiguration()`). If so, load it into EditorStateService. Otherwise start with empty configuration.
   - Editor.razor.css: Full-height layout, dark theme using CSS variables from app.css. Canvas area should have `overflow: hidden` and fill available space.

4. Add "Editor" NavLink to `MainLayout.razor` nav section, after Monitor link:
   ```razor
   <NavLink href="/editor" class="nav-item">
       <span class="nav-icon">&#x25C8;</span>
       @if (!SidebarCollapsed)
       {
           <span class="nav-label">Editor</span>
       }
   </NavLink>
   ```

5. Register EditorStateService as scoped in DI (add to WiringServiceExtensions.cs or create new extension method).
  </action>
  <verify>
    <automated>cd /home/user/OpenAnima && dotnet build src/OpenAnima.Core/OpenAnima.Core.csproj --no-restore 2>&1 | tail -5</automated>
  </verify>
  <done>Editor page accessible at /editor, SVG canvas renders with pan (drag background) and zoom (mouse wheel), grid background visible, EditorStateService registered in DI, Editor link appears in sidebar navigation.</done>
</task>

<task type="auto">
  <name>Task 2: Create ModulePalette with drag-to-canvas functionality</name>
  <files>
    src/OpenAnima.Core/Components/Shared/ModulePalette.razor
  </files>
  <action>
1. Create `ModulePalette.razor` — right-side fixed sidebar (~220px):
   - Inject `IPortRegistry` and `EditorStateService`
   - Get available modules: group `IPortRegistry.GetAllPorts()` by `ModuleName` to get distinct module names
   - Search/filter: text input at top that filters module list by name (case-insensitive Contains)
   - Each module item: `<div draggable="true" @ondragstart="@(() => HandleDragStart(moduleName))">`
     - Show module name in bold
     - Show port count summary (e.g., "2 in, 1 out") in smaller text below
     - Style: compact card with dark surface background, subtle border, hover highlight
   - `HandleDragStart`: set `_editorState.DraggedModuleName = moduleName`
   - Use `@ondragend` to clear `_editorState.DraggedModuleName = null` (cleanup if drop cancelled)
   - Scoped CSS: dark theme matching app variables, scrollable list area, sticky search box at top
   - If no modules registered (IPortRegistry returns empty), show "No modules loaded" message

2. The drop handling is already in EditorCanvas (Task 1). Verify the full flow works:
   - Palette sets DraggedModuleName on dragstart
   - Canvas prevents default on dragover
   - Canvas reads DraggedModuleName on drop, converts coordinates, creates node
   - Node appears as placeholder rectangle on canvas at drop position
  </action>
  <verify>
    <automated>cd /home/user/OpenAnima && dotnet build src/OpenAnima.Core/OpenAnima.Core.csproj --no-restore 2>&1 | tail -5</automated>
  </verify>
  <done>Module palette shows available modules from IPortRegistry with search filter, dragging a module from palette to canvas creates a node at the drop position, palette follows dark theme with ~220px fixed width on right side.</done>
</task>

</tasks>

<verification>
1. `dotnet build` succeeds with no errors
2. `dotnet test` — all existing tests still pass (no regressions)
3. Editor page loads at /editor route
4. Canvas pan/zoom works smoothly (throttled to 50ms)
5. Module palette shows registered modules
6. Drag from palette to canvas creates node at correct position
</verification>

<success_criteria>
- Editor page accessible via /editor with sidebar nav link
- SVG canvas supports pan (drag background) and zoom (mouse wheel, centered on cursor)
- Module palette on right side shows available modules with search filter
- Dragging module from palette to canvas places a node at drop coordinates
- All existing tests pass (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/13-visual-drag-and-drop-editor/13-01-SUMMARY.md`
</output>

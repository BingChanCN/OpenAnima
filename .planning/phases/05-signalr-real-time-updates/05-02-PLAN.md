---
phase: 05-signalr-real-time-updates
plan: 02
type: execute
wave: 2
depends_on:
  - "05-01"
files_modified:
  - src/OpenAnima.Core/Components/Pages/Monitor.razor
  - src/OpenAnima.Core/Components/Pages/Monitor.razor.css
  - src/OpenAnima.Core/Components/Shared/Sparkline.razor
  - src/OpenAnima.Core/Components/Shared/Sparkline.razor.css
  - src/OpenAnima.Core/Components/Layout/MainLayout.razor
  - src/OpenAnima.Core/Components/_Imports.razor
autonomous: true
requirements:
  - BEAT-01
  - BEAT-03
  - BEAT-04

must_haves:
  truths:
    - "User sees a dedicated Monitor page with real-time heartbeat data updating without manual refresh"
    - "User sees live tick counter updating in real-time with rolling animation effect"
    - "User sees per-tick latency with three-tier color coding (green <50ms, yellow 50-100ms, red >100ms)"
    - "User sees sparkline charts showing recent tick latency trends with 100ms baseline"
    - "User sees heartbeat running state (Running/Stopped) updating in real-time"
    - "User sees connection status indicator dot (green=connected, red=disconnected)"
    - "Connection auto-reconnects on disconnect with 'Reconnecting...' status"
    - "Monitor page is accessible via sidebar navigation"
  artifacts:
    - path: "src/OpenAnima.Core/Components/Pages/Monitor.razor"
      provides: "Real-time monitoring page with SignalR connection"
      contains: "HubConnection"
    - path: "src/OpenAnima.Core/Components/Pages/Monitor.razor.css"
      provides: "Monitoring page styling with metric cards and animations"
      contains: "metric-card"
    - path: "src/OpenAnima.Core/Components/Shared/Sparkline.razor"
      provides: "SVG sparkline component for trend visualization"
      contains: "polyline"
    - path: "src/OpenAnima.Core/Components/Layout/MainLayout.razor"
      provides: "Updated navigation with Monitor link"
      contains: "/monitor"
  key_links:
    - from: "Monitor.razor"
      to: "RuntimeHub"
      via: "HubConnection to /hubs/runtime"
      pattern: "/hubs/runtime"
    - from: "Monitor.razor"
      to: "Sparkline.razor"
      via: "Component reference with Values parameter"
      pattern: "Sparkline"
    - from: "MainLayout.razor"
      to: "Monitor.razor"
      via: "NavLink href routing"
      pattern: "href=\"/monitor\""
---

<objective>
Create the real-time monitoring page with card-based layout, sparkline charts, connection status indicator, and rolling number animations. Wire up SignalR HubConnection to receive live data from RuntimeHub.

Purpose: Delivers the user-facing real-time dashboard — the primary deliverable of Phase 5. Users can now monitor heartbeat tick count, per-tick latency with warnings, and heartbeat state without refreshing the page.

Output: Monitor.razor page at /monitor with live-updating metric cards, SVG sparkline for latency trends, connection status dot, auto-reconnect behavior, and navigation link in sidebar.
</objective>

<execution_context>
@/home/user/.claude/get-shit-done/workflows/execute-plan.md
@/home/user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-signalr-real-time-updates/05-CONTEXT.md
@.planning/phases/05-signalr-real-time-updates/05-RESEARCH.md
@.planning/phases/05-signalr-real-time-updates/05-01-SUMMARY.md
@src/OpenAnima.Core/Hubs/IRuntimeClient.cs
@src/OpenAnima.Core/Components/Layout/MainLayout.razor
@src/OpenAnima.Core/Components/Layout/MainLayout.razor.css
@src/OpenAnima.Core/Components/Pages/Heartbeat.razor
@src/OpenAnima.Core/Components/Pages/Heartbeat.razor.css
@src/OpenAnima.Core/wwwroot/css/app.css
@src/OpenAnima.Core/Components/_Imports.razor
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Sparkline component and Monitor page with SignalR connection</name>
  <files>
    src/OpenAnima.Core/Components/Shared/Sparkline.razor
    src/OpenAnima.Core/Components/Shared/Sparkline.razor.css
    src/OpenAnima.Core/Components/Pages/Monitor.razor
    src/OpenAnima.Core/Components/Pages/Monitor.razor.css
    src/OpenAnima.Core/Components/_Imports.razor
  </files>
  <action>
**Update `src/OpenAnima.Core/Components/_Imports.razor`:**

Add `@using Microsoft.AspNetCore.SignalR.Client` to the imports list (needed for HubConnection, HubConnectionState, HubConnectionBuilder in Monitor.razor).

**Create `src/OpenAnima.Core/Components/Shared/Sparkline.razor`:**

A lightweight SVG sparkline component:

```razor
@if (Values.Count > 1)
{
    <svg class="sparkline" viewBox="0 0 @Width @Height" preserveAspectRatio="none">
        @if (BaselineValue.HasValue && MaxValue > 0)
        {
            var baseY = Height - (BaselineValue.Value / MaxValue) * Height;
            <line x1="0" y1="@F(baseY)" x2="@Width" y2="@F(baseY)"
                  class="sparkline-baseline" />
        }
        <polyline points="@GetPoints()" class="sparkline-line" fill="none" />
    </svg>
}

@code {
    [Parameter] public List<double> Values { get; set; } = new();
    [Parameter] public int Width { get; set; } = 120;
    [Parameter] public int Height { get; set; } = 40;
    [Parameter] public double? BaselineValue { get; set; }

    private double MaxValue => Values.Count > 0 ? Math.Max(Values.Max(), BaselineValue ?? 0) : 1;

    private string GetPoints()
    {
        if (Values.Count < 2) return "";
        var max = MaxValue;
        if (max == 0) max = 1;
        var step = (double)Width / (Values.Count - 1);
        return string.Join(" ", Values.Select((v, i) =>
            $"{F(i * step)},{F(Height - (v / max) * Height)}"));
    }

    private static string F(double value) => value.ToString("F1", System.Globalization.CultureInfo.InvariantCulture);
}
```

Note: `F()` helper formats doubles with invariant culture to avoid comma decimal separators in SVG attributes.

**Create `src/OpenAnima.Core/Components/Shared/Sparkline.razor.css`:**

```css
.sparkline {
    width: 100%;
    height: 100%;
}

.sparkline-line {
    stroke: var(--accent-color);
    stroke-width: 1.5;
    vector-effect: non-scaling-stroke;
}

.sparkline-baseline {
    stroke: var(--error-color);
    stroke-width: 1;
    stroke-dasharray: 3 2;
    opacity: 0.5;
    vector-effect: non-scaling-stroke;
}
```

**Create `src/OpenAnima.Core/Components/Pages/Monitor.razor`:**

Page at `@page "/monitor"` with SignalR HubConnection.

Structure per user decisions — card-based layout with one card per metric:

```razor
@page "/monitor"
@inject NavigationManager Navigation
@implements IAsyncDisposable

<h1 class="page-title">
    Monitor
    <span class="connection-dot @ConnectionClass"
          title="@ConnectionTitle"></span>
</h1>

@if (connectionState == HubConnectionState.Reconnecting)
{
    <div class="reconnecting-banner">Reconnecting...</div>
}

<div class="monitor-grid">
    <!-- Heartbeat Status Card -->
    <div class="metric-card card">
        <div class="metric-header">
            <span class="metric-label">Heartbeat</span>
        </div>
        <div class="metric-value status-text @(isRunning ? "running" : "stopped")">
            @(isRunning ? "Running" : "Stopped")
        </div>
    </div>

    <!-- Tick Count Card -->
    <div class="metric-card card">
        <div class="metric-header">
            <span class="metric-label">Tick Count</span>
        </div>
        <div class="metric-value mono tick-value">
            @tickCount.ToString("N0")
        </div>
    </div>

    <!-- Latency Card -->
    <div class="metric-card card">
        <div class="metric-header">
            <span class="metric-label">Tick Latency</span>
        </div>
        <div class="metric-value mono @LatencyClass">
            @latencyMs.ToString("F1") ms
        </div>
    </div>

    <!-- Latency Trend Card -->
    <div class="metric-card card trend-card">
        <div class="metric-header">
            <span class="metric-label">Latency Trend</span>
            <span class="metric-sublabel">last @latencyHistory.Count points</span>
        </div>
        <div class="sparkline-container">
            <Sparkline Values="@latencyHistory"
                       Width="200" Height="60"
                       BaselineValue="100" />
        </div>
    </div>
</div>
```

Component code section (`@code { ... }`):

State fields:
- `private HubConnection? hubConnection;`
- `private HubConnectionState connectionState = HubConnectionState.Disconnected;`
- `private bool isRunning;`
- `private long tickCount;`
- `private double latencyMs;`
- `private List<double> latencyHistory = new();`
- `private const int MaxHistoryPoints = 60;`
- `private bool _disposed;`
- `private int _ticksSinceLastRender;`
- `private const int RenderEveryNTicks = 5;` (throttle: render every 5th tick = ~500ms)

Computed properties:
- `private string LatencyClass` — returns `"latency-normal"` if latencyMs < 50, `"latency-caution"` if 50-100, `"latency-warning"` if > 100
- `private string ConnectionClass` — returns `"connected"` if Connected, `"reconnecting"` if Reconnecting, `"disconnected"` otherwise
- `private string ConnectionTitle` — returns human-readable connection state text

`OnInitializedAsync`:
1. Build HubConnection:
   ```csharp
   hubConnection = new HubConnectionBuilder()
       .WithUrl(Navigation.ToAbsoluteUri("/hubs/runtime"))
       .WithAutomaticReconnect()
       .Build();
   ```
2. Register handlers:
   - `hubConnection.On<long, double>("ReceiveHeartbeatTick", ...)` — updates tickCount, latencyMs, adds to latencyHistory (trim to MaxHistoryPoints), increments _ticksSinceLastRender. Only call `InvokeAsync(StateHasChanged)` when `_ticksSinceLastRender >= RenderEveryNTicks` (throttle). Reset counter after render.
   - `hubConnection.On<bool>("ReceiveHeartbeatStateChanged", ...)` — updates isRunning, calls `InvokeAsync(StateHasChanged)` immediately (state changes are infrequent).
   - `hubConnection.On<int>("ReceiveModuleCountChanged", ...)` — no display on this page, but could be used later. Just ignore for now or store if needed.
3. Register connection state handlers:
   - `hubConnection.Reconnecting += ...` — set connectionState = Reconnecting, `InvokeAsync(StateHasChanged)`
   - `hubConnection.Reconnected += ...` — set connectionState = Connected, `InvokeAsync(StateHasChanged)`
   - `hubConnection.Closed += ...` — set connectionState = Disconnected, `InvokeAsync(StateHasChanged)`
4. Start connection:
   ```csharp
   await hubConnection.StartAsync();
   connectionState = HubConnectionState.Connected;
   ```
   Wrap in try/catch — if connection fails on init, set connectionState = Disconnected.

All hub callbacks MUST check `if (!_disposed)` before calling `InvokeAsync(StateHasChanged)`.

`DisposeAsync`:
```csharp
_disposed = true;
if (hubConnection is not null)
    await hubConnection.DisposeAsync();
```

**Create `src/OpenAnima.Core/Components/Pages/Monitor.razor.css`:**

Styles for the monitoring page:

- `.page-title`: `font-size: 1.5rem; font-weight: 600; margin-bottom: 24px; color: var(--text-primary); display: flex; align-items: center; gap: 12px;`
- `.connection-dot`: `width: 8px; height: 8px; border-radius: 50%; display: inline-block; flex-shrink: 0;`
- `.connection-dot.connected`: `background-color: var(--success-color);`
- `.connection-dot.disconnected`: `background-color: var(--error-color);`
- `.connection-dot.reconnecting`: `background-color: var(--warning-color); animation: pulse 1s infinite;`
- `@keyframes pulse`: `0%, 100% { opacity: 1; } 50% { opacity: 0.4; }`
- `.reconnecting-banner`: `background: rgba(251, 191, 36, 0.1); border: 1px solid var(--warning-color); border-radius: 8px; padding: 8px 16px; margin-bottom: 16px; color: var(--warning-color); font-size: 0.85rem; text-align: center;`
- `.monitor-grid`: `display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px;`
- `.metric-card`: `padding: 24px;` (extends .card base from app.css)
- `.metric-header`: `margin-bottom: 12px;`
- `.metric-label`: `font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-secondary);`
- `.metric-sublabel`: `font-size: 0.7rem; color: var(--text-muted); margin-left: 8px;`
- `.metric-value`: `font-size: 1.8rem; font-weight: 700; color: var(--text-primary); transition: color 0.2s ease;`
- `.tick-value`: `font-variant-numeric: tabular-nums;` (prevents layout shift as numbers change)
- `.status-text.running`: `color: var(--success-color);`
- `.status-text.stopped`: `color: var(--error-color);`
- `.latency-normal`: `color: var(--success-color);`
- `.latency-caution`: `color: var(--warning-color);`
- `.latency-warning`: `color: var(--error-color);`
- `.sparkline-container`: `height: 60px; margin-top: 8px;`
- `.trend-card`: `grid-column: span 2;` (wider card for sparkline)
- `@media (max-width: 768px)`: `.monitor-grid { grid-template-columns: 1fr; }` and `.trend-card { grid-column: span 1; }`
  </action>
  <verify>
Run `dotnet build src/OpenAnima.Core/` — must compile without errors. Verify Monitor.razor has @page "/monitor", HubConnection setup with WithAutomaticReconnect, handlers for ReceiveHeartbeatTick and ReceiveHeartbeatStateChanged, IAsyncDisposable implementation. Verify Sparkline.razor has SVG polyline with BaselineValue support. Verify CSS has latency color classes and connection dot styles.
  </verify>
  <done>
Monitor page renders at /monitor with four metric cards: heartbeat status, tick count, tick latency, and latency trend sparkline. Data updates in real-time via SignalR HubConnection. Latency uses three-tier color coding. Connection status dot shows green/red/yellow. Auto-reconnect with "Reconnecting..." banner. UI updates throttled to ~500ms for smooth rendering.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Monitor to sidebar navigation</name>
  <files>
    src/OpenAnima.Core/Components/Layout/MainLayout.razor
  </files>
  <action>
**Update `src/OpenAnima.Core/Components/Layout/MainLayout.razor`:**

Add a fourth NavLink for the Monitor page in the `<nav class="sidebar-nav">` section, after the Heartbeat NavLink:

```razor
<NavLink href="/monitor" class="nav-item">
    <span class="nav-icon">&#x25CE;</span>
    @if (!SidebarCollapsed)
    {
        <span class="nav-label">Monitor</span>
    }
</NavLink>
```

Use Unicode character &#x25CE; (BULLSEYE) for the Monitor icon — visually suggests a live target/monitoring concept. Place it after Heartbeat in the nav order: Dashboard, Modules, Heartbeat, Monitor.
  </action>
  <verify>
Run `dotnet build src/OpenAnima.Core/` — must compile without errors. Verify MainLayout.razor has four NavLink components including one with href="/monitor". Verify the Monitor NavLink has the same structure as existing nav items (icon + conditional label).
  </verify>
  <done>
Monitor page is accessible via sidebar navigation. Four navigation items: Dashboard, Modules, Heartbeat, Monitor. Active state highlighting works via NavLink component.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build src/OpenAnima.Core/` compiles without errors
2. Navigate to /monitor — shows four metric cards (heartbeat status, tick count, latency, latency trend)
3. Tick count updates in real-time without page refresh
4. Latency value changes color based on threshold (green <50ms, yellow 50-100ms, red >100ms)
5. Sparkline shows latency trend with 100ms baseline marker
6. Connection dot is green when connected
7. Sidebar shows four navigation items including Monitor
8. Monitor grid collapses to single column on narrow viewport
9. Disconnecting network shows reconnecting state and auto-reconnects
</verification>

<success_criteria>
- Monitor page displays real-time heartbeat data via SignalR
- Tick count updates live without manual refresh
- Per-tick latency shows three-tier color coding
- Sparkline chart shows latency trend with 100ms baseline
- Connection status indicator dot works (green/red/yellow)
- Auto-reconnect with "Reconnecting..." banner
- Navigation includes Monitor link
- Responsive layout at 768px breakpoint
- Clean build with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-signalr-real-time-updates/05-02-SUMMARY.md`
</output>

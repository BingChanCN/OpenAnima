---
phase: 11-port-type-system-testing-foundation
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/OpenAnima.Contracts/Ports/PortType.cs
  - src/OpenAnima.Contracts/Ports/PortDirection.cs
  - src/OpenAnima.Contracts/Ports/PortMetadata.cs
  - src/OpenAnima.Contracts/Ports/InputPortAttribute.cs
  - src/OpenAnima.Contracts/Ports/OutputPortAttribute.cs
  - src/OpenAnima.Core/Ports/PortDiscovery.cs
  - src/OpenAnima.Core/Ports/PortRegistry.cs
  - src/OpenAnima.Core/Ports/PortTypeValidator.cs
  - tests/OpenAnima.Tests/Unit/PortTypeValidatorTests.cs
  - tests/OpenAnima.Tests/Unit/PortDiscoveryTests.cs
autonomous: true
requirements:
  - PORT-01
  - PORT-02
  - PORT-03
  - PORT-04

must_haves:
  truths:
    - "PortType enum defines Text and Trigger with associated color hex values in XML doc comments"
    - "PortTypeValidator rejects connections between different port types with descriptive error message"
    - "PortTypeValidator rejects same-direction connections (output-to-output, input-to-input)"
    - "PortTypeValidator allows fan-out (one output to multiple inputs of same type)"
    - "PortDiscovery extracts InputPort and OutputPort attributes from a decorated class via reflection"
    - "PortRegistry stores and retrieves port metadata by module name"
  artifacts:
    - path: "src/OpenAnima.Contracts/Ports/PortType.cs"
      provides: "PortType enum (Text=0, Trigger=1) with color doc comments"
      contains: "public enum PortType"
    - path: "src/OpenAnima.Contracts/Ports/PortMetadata.cs"
      provides: "Immutable port metadata record"
      contains: "public record PortMetadata"
    - path: "src/OpenAnima.Contracts/Ports/InputPortAttribute.cs"
      provides: "Attribute for declaring input ports on module classes"
      contains: "public class InputPortAttribute"
    - path: "src/OpenAnima.Core/Ports/PortTypeValidator.cs"
      provides: "Connection validation logic"
      contains: "public class PortTypeValidator"
    - path: "src/OpenAnima.Core/Ports/PortDiscovery.cs"
      provides: "Reflection-based attribute scanner"
      contains: "public class PortDiscovery"
    - path: "tests/OpenAnima.Tests/Unit/PortTypeValidatorTests.cs"
      provides: "Unit tests for connection validation"
      contains: "public class PortTypeValidatorTests"
  key_links:
    - from: "src/OpenAnima.Core/Ports/PortDiscovery.cs"
      to: "src/OpenAnima.Contracts/Ports/InputPortAttribute.cs"
      via: "Reflection GetCustomAttributes"
      pattern: "GetCustomAttributes"
    - from: "src/OpenAnima.Core/Ports/PortTypeValidator.cs"
      to: "src/OpenAnima.Contracts/Ports/PortMetadata.cs"
      via: "Validates PortMetadata pairs"
      pattern: "PortMetadata"
---

<objective>
Create the port type system foundation: type enums, metadata records, declaration attributes, discovery service, registry, and type validator — all driven by TDD.

Purpose: Establish the typed port contracts that all subsequent phases (wiring engine, visual editor, module refactoring) build upon. Without correct type validation and discovery, connections cannot be validated and modules cannot declare their interfaces.

Output: Port contracts in OpenAnima.Contracts/Ports/, core services in OpenAnima.Core/Ports/, unit tests proving all validation and discovery behavior.
</objective>

<execution_context>
@/home/user/.claude/get-shit-done/workflows/execute-plan.md
@/home/user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-port-type-system-testing-foundation/11-RESEARCH.md

<interfaces>
<!-- Existing contracts the executor needs -->

From src/OpenAnima.Contracts/IModule.cs:
```csharp
public interface IModule
{
    IModuleMetadata Metadata { get; }
    Task InitializeAsync(CancellationToken cancellationToken = default);
    Task ShutdownAsync(CancellationToken cancellationToken = default);
}
```

From src/OpenAnima.Contracts/IModuleMetadata.cs — module identity interface (attributes will be placed on classes implementing IModule).

From src/OpenAnima.Core/Plugins/PluginLoader.cs — loads modules via reflection, uses AssemblyLoadContext. Port discovery will follow the same reflection pattern but scan for InputPortAttribute/OutputPortAttribute instead of IModule.
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create port type contracts in OpenAnima.Contracts</name>
  <files>
    src/OpenAnima.Contracts/Ports/PortType.cs
    src/OpenAnima.Contracts/Ports/PortDirection.cs
    src/OpenAnima.Contracts/Ports/PortMetadata.cs
    src/OpenAnima.Contracts/Ports/InputPortAttribute.cs
    src/OpenAnima.Contracts/Ports/OutputPortAttribute.cs
  </files>
  <action>
    Create `src/OpenAnima.Contracts/Ports/` directory and add these files:

    1. **PortType.cs** — Enum with two values:
       - `Text = 0` with XML doc comment including visual color `#2563EB` (blue)
       - `Trigger = 1` with XML doc comment including visual color `#EA580C` (orange)
       - Namespace: `OpenAnima.Contracts.Ports`

    2. **PortDirection.cs** — Enum with two values:
       - `Input = 0`, `Output = 1`
       - Namespace: `OpenAnima.Contracts.Ports`

    3. **PortMetadata.cs** — Immutable record:
       - `public record PortMetadata(string Name, PortType Type, PortDirection Direction, string ModuleName)`
       - Add computed property `Id` returning `$"{ModuleName}.{Direction}.{Name}"`
       - Namespace: `OpenAnima.Contracts.Ports`

    4. **InputPortAttribute.cs** — Custom attribute:
       - `[AttributeUsage(AttributeTargets.Class, AllowMultiple = true)]`
       - Properties: `string Name`, `PortType Type` (both set in constructor)
       - Namespace: `OpenAnima.Contracts.Ports`

    5. **OutputPortAttribute.cs** — Custom attribute:
       - Same structure as InputPortAttribute
       - Namespace: `OpenAnima.Contracts.Ports`

    Per user decision: port metadata minimum set is name + type + direction. Port types are fixed enum (Text, Trigger). Attributes are declarative style like Unity's [SerializeField].
  </action>
  <verify>
    <automated>dotnet build src/OpenAnima.Contracts/OpenAnima.Contracts.csproj</automated>
  </verify>
  <done>All five files compile. PortType has Text and Trigger. PortMetadata is an immutable record. Both attributes support AllowMultiple=true on classes.</done>
</task>

<task type="auto">
  <name>Task 2: TDD — PortTypeValidator, PortDiscovery, PortRegistry with unit tests</name>
  <files>
    src/OpenAnima.Core/Ports/PortTypeValidator.cs
    src/OpenAnima.Core/Ports/PortDiscovery.cs
    src/OpenAnima.Core/Ports/PortRegistry.cs
    tests/OpenAnima.Tests/Unit/PortTypeValidatorTests.cs
    tests/OpenAnima.Tests/Unit/PortDiscoveryTests.cs
  </files>
  <action>
    Follow RED → GREEN → REFACTOR for each service.

    **PortTypeValidator (TDD):**

    RED — Write `tests/OpenAnima.Tests/Unit/PortTypeValidatorTests.cs` first:
    - `ValidConnection_SameType_ReturnsSuccess` — Text output → Text input = valid
    - `InvalidConnection_DifferentTypes_ReturnsFail` — Text output → Trigger input = fail with message "Text port cannot connect to Trigger port"
    - `InvalidConnection_OutputToOutput_ReturnsFail` — both outputs = fail
    - `InvalidConnection_InputToInput_ReturnsFail` — both inputs = fail
    - `InvalidConnection_SelfConnection_ReturnsFail` — same module name = fail
    - `ValidConnection_FanOut_AllowsMultipleFromSameOutput` — validate same output to two different inputs both succeed (PORT-03)
    - Run tests, confirm all FAIL.

    GREEN — Create `src/OpenAnima.Core/Ports/PortTypeValidator.cs`:
    - `public ValidationResult ValidateConnection(PortMetadata source, PortMetadata target)`
    - Check direction (source must be Output, target must be Input)
    - Check type match (`source.Type != target.Type` → fail with specific type names in message)
    - Check self-connection (`source.ModuleName == target.ModuleName` → fail)
    - Return `ValidationResult.Success()` if all pass
    - `public record ValidationResult(bool IsValid, string? ErrorMessage)` with static factory methods
    - Use `source.Type == target.Type` comparison (NOT switch statements — per research pitfall #3, this stays extensible)
    - Run tests, confirm all PASS.

    **PortDiscovery (TDD):**

    RED — Write `tests/OpenAnima.Tests/Unit/PortDiscoveryTests.cs`:
    - Create a test-only decorated class inside the test file:
      ```csharp
      [InputPort("text_in", PortType.Text)]
      [OutputPort("text_out", PortType.Text)]
      [OutputPort("trigger_out", PortType.Trigger)]
      private class TestModule { }
      ```
    - `DiscoverPorts_FindsAllAttributes` — discovers 3 ports from TestModule
    - `DiscoverPorts_CorrectDirection` — input ports have Direction.Input, output ports have Direction.Output
    - `DiscoverPorts_CorrectTypes` — text ports have PortType.Text, trigger ports have PortType.Trigger
    - `DiscoverPorts_NoAttributes_ReturnsEmpty` — plain class returns empty list
    - `DiscoverPorts_SetsModuleName` — ModuleName matches the type name
    - Run tests, confirm all FAIL.

    GREEN — Create `src/OpenAnima.Core/Ports/PortDiscovery.cs`:
    - `public List<PortMetadata> DiscoverPorts(Type moduleType)`
    - Use `Attribute.GetCustomAttributes(moduleType)` to scan
    - For each `InputPortAttribute` → create `PortMetadata(attr.Name, attr.Type, PortDirection.Input, moduleType.Name)`
    - For each `OutputPortAttribute` → create `PortMetadata(attr.Name, attr.Type, PortDirection.Output, moduleType.Name)`
    - Return collected list
    - Run tests, confirm all PASS.

    **PortRegistry (no TDD — simple container):**

    Create `src/OpenAnima.Core/Ports/PortRegistry.cs`:
    - `ConcurrentDictionary<string, List<PortMetadata>>` keyed by module name
    - `RegisterPorts(string moduleName, List<PortMetadata> ports)`
    - `GetPorts(string moduleName)` → returns ports or empty list
    - `GetAllPorts()` → flattens all values
    - `UnregisterPorts(string moduleName)` → removes entry
    - Thread-safe via ConcurrentDictionary

    Namespace for all core services: `OpenAnima.Core.Ports`
  </action>
  <verify>
    <automated>dotnet test tests/OpenAnima.Tests/ --filter "FullyQualifiedName~PortTypeValidator|FullyQualifiedName~PortDiscovery" --logger "console;verbosity=detailed"</automated>
  </verify>
  <done>All PortTypeValidator tests pass: type mismatch rejected with descriptive message, direction enforced, self-connection blocked, fan-out allowed. All PortDiscovery tests pass: attributes discovered via reflection, correct types and directions, empty class returns empty list. PortRegistry compiles and stores/retrieves metadata.</done>
</task>

</tasks>

<verification>
1. `dotnet build` — entire solution compiles with no errors
2. `dotnet test tests/OpenAnima.Tests/ --filter "FullyQualifiedName~PortTypeValidator|FullyQualifiedName~PortDiscovery"` — all unit tests green
3. Port contracts exist in `src/OpenAnima.Contracts/Ports/` with correct namespaces
4. Core services exist in `src/OpenAnima.Core/Ports/` with correct namespaces
5. PortType enum has exactly Text and Trigger values
6. Attributes support AllowMultiple=true
</verification>

<success_criteria>
- PortType.Text and PortType.Trigger defined with color hex in doc comments
- PortTypeValidator rejects cross-type connections with message containing both type names
- PortTypeValidator allows fan-out (same output → multiple inputs)
- PortDiscovery extracts all InputPort/OutputPort attributes from a class
- PortRegistry stores and retrieves port metadata by module name
- All unit tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/11-port-type-system-testing-foundation/11-01-SUMMARY.md`
</output>

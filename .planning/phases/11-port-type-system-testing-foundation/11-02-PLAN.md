---
phase: 11-port-type-system-testing-foundation
plan: 02
type: execute
wave: 2
depends_on:
  - "11-01"
files_modified:
  - tests/OpenAnima.Tests/Integration/Fixtures/IntegrationTestFixture.cs
  - tests/OpenAnima.Tests/Integration/ChatWorkflowTests.cs
  - tests/OpenAnima.Tests/Integration/PortSystemIntegrationTests.cs
autonomous: true
requirements:
  - PORT-03
  - PORT-04

must_haves:
  truths:
    - "v1.2 chat workflow test verifies MessageSent event triggers ResponseReceived event through EventBus"
    - "Port discovery integration test verifies attributes are found on a multi-port decorated class and stored in PortRegistry"
    - "Fan-out integration test verifies one output port metadata validates against multiple input port metadata of same type"
  artifacts:
    - path: "tests/OpenAnima.Tests/Integration/Fixtures/IntegrationTestFixture.cs"
      provides: "Shared test context with EventBus and PortRegistry"
      contains: "public class IntegrationTestFixture"
    - path: "tests/OpenAnima.Tests/Integration/ChatWorkflowTests.cs"
      provides: "v1.2 regression protection tests"
      contains: "public class ChatWorkflowTests"
    - path: "tests/OpenAnima.Tests/Integration/PortSystemIntegrationTests.cs"
      provides: "Port discovery and fan-out integration tests"
      contains: "public class PortSystemIntegrationTests"
  key_links:
    - from: "tests/OpenAnima.Tests/Integration/ChatWorkflowTests.cs"
      to: "src/OpenAnima.Core/Events/EventBus.cs"
      via: "PublishAsync and Subscribe for MessageSent/ResponseReceived"
      pattern: "PublishAsync.*MessageSentPayload"
    - from: "tests/OpenAnima.Tests/Integration/PortSystemIntegrationTests.cs"
      to: "src/OpenAnima.Core/Ports/PortDiscovery.cs"
      via: "DiscoverPorts then RegisterPorts in PortRegistry"
      pattern: "DiscoverPorts.*RegisterPorts"
---

<objective>
Create integration tests that protect the existing v1.2 chat workflow from regression and verify the port system works end-to-end (discovery → registry → validation).

Purpose: Integration tests are the safety net before any refactoring in Phase 14. The chat workflow test ensures MessageSent → LLM processing → ResponseReceived still works. Port system integration tests verify that discovery, registry, and validation work together correctly, including fan-out scenarios.

Output: Integration test fixture, chat workflow regression tests, port system integration tests.
</objective>

<execution_context>
@/home/user/.claude/get-shit-done/workflows/execute-plan.md
@/home/user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-port-type-system-testing-foundation/11-01-SUMMARY.md

<interfaces>
<!-- From Plan 01 outputs -->

From src/OpenAnima.Contracts/Ports/:
```csharp
public enum PortType { Text = 0, Trigger = 1 }
public enum PortDirection { Input = 0, Output = 1 }
public record PortMetadata(string Name, PortType Type, PortDirection Direction, string ModuleName);

[AttributeUsage(AttributeTargets.Class, AllowMultiple = true)]
public class InputPortAttribute : Attribute { public string Name { get; } public PortType Type { get; } }

[AttributeUsage(AttributeTargets.Class, AllowMultiple = true)]
public class OutputPortAttribute : Attribute { public string Name { get; } public PortType Type { get; } }
```

From src/OpenAnima.Core/Ports/:
```csharp
public class PortDiscovery { public List<PortMetadata> DiscoverPorts(Type moduleType); }
public class PortRegistry { public void RegisterPorts(string moduleName, List<PortMetadata> ports); public List<PortMetadata> GetPorts(string moduleName); }
public class PortTypeValidator { public ValidationResult ValidateConnection(PortMetadata source, PortMetadata target); }
public record ValidationResult(bool IsValid, string? ErrorMessage);
```

<!-- Existing code for chat workflow tests -->

From src/OpenAnima.Core/Events/EventBus.cs:
```csharp
public class EventBus : IEventBus
{
    public EventBus(ILogger<EventBus> logger);
    public async Task PublishAsync<TPayload>(ModuleEvent<TPayload> evt, CancellationToken ct = default);
    public IDisposable Subscribe<TPayload>(string eventName, Func<ModuleEvent<TPayload>, CancellationToken, Task> handler, ...);
    public IDisposable Subscribe<TPayload>(Func<ModuleEvent<TPayload>, CancellationToken, Task> handler, ...);
}
```

From src/OpenAnima.Core/Events/ChatEvents.cs:
```csharp
public record MessageSentPayload(string UserMessage, int TokenCount, DateTime Timestamp);
public record ResponseReceivedPayload(string AssistantResponse, int InputTokens, int OutputTokens, DateTime Timestamp);
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integration test fixture and v1.2 chat workflow regression tests</name>
  <files>
    tests/OpenAnima.Tests/Integration/Fixtures/IntegrationTestFixture.cs
    tests/OpenAnima.Tests/Integration/ChatWorkflowTests.cs
  </files>
  <action>
    Create `tests/OpenAnima.Tests/Integration/Fixtures/` and `tests/OpenAnima.Tests/Integration/` directories.

    **IntegrationTestFixture.cs:**
    - Implements `IDisposable`
    - Creates a fresh `EventBus` instance using `NullLogger<EventBus>.Instance` (from `Microsoft.Extensions.Logging.Abstractions` — add package reference to test project if not present)
    - Creates a fresh `PortRegistry` and `PortDiscovery` instance
    - Creates a fresh `PortTypeValidator` instance
    - Dispose cleans up (no-op for now, but establishes pattern)
    - Namespace: `OpenAnima.Tests.Integration.Fixtures`

    **ChatWorkflowTests.cs:**
    - Implements `IClassFixture<IntegrationTestFixture>`
    - Uses `[Trait("Category", "Integration")]` on all test methods
    - Test: `EventBus_PublishMessageSent_SubscriberReceivesEvent` — publish MessageSentPayload, verify subscriber receives it via TaskCompletionSource (not Task.Delay). Use 5-second timeout.
    - Test: `EventBus_PublishResponseReceived_SubscriberReceivesEvent` — publish ResponseReceivedPayload, verify subscriber receives it.
    - Test: `EventBus_MultipleSubscribers_AllReceiveEvent` — subscribe two handlers to same event, verify both fire (validates broadcast pattern used by chat).
    - Test: `EventBus_SubscriptionDispose_StopsReceiving` — subscribe, dispose, publish again, verify handler NOT called.

    Important: Create a NEW EventBus per test method to avoid test isolation issues (per research pitfall #5). Do NOT reuse the fixture's EventBus — create fresh instances in each test using `new EventBus(NullLogger<EventBus>.Instance)`.

    Add `Microsoft.Extensions.Logging.Abstractions` package to test project if not already referenced (needed for NullLogger).
  </action>
  <verify>
    <automated>dotnet test tests/OpenAnima.Tests/ --filter "Category=Integration&FullyQualifiedName~ChatWorkflow" --logger "console;verbosity=detailed"</automated>
  </verify>
  <done>All chat workflow integration tests pass. EventBus correctly broadcasts to multiple subscribers, subscription disposal works, MessageSent and ResponseReceived payloads flow correctly.</done>
</task>

<task type="auto">
  <name>Task 2: Port system integration tests — discovery pipeline and fan-out validation</name>
  <files>
    tests/OpenAnima.Tests/Integration/PortSystemIntegrationTests.cs
  </files>
  <action>
    Create `tests/OpenAnima.Tests/Integration/PortSystemIntegrationTests.cs`:

    Define test-only decorated classes inside the test file:
    ```csharp
    [InputPort("text_in", PortType.Text)]
    [OutputPort("text_out", PortType.Text)]
    private class TextProcessorModule { }

    [InputPort("trigger_in", PortType.Trigger)]
    [OutputPort("trigger_out", PortType.Trigger)]
    private class TriggerModule { }

    [InputPort("text_in", PortType.Text)]
    private class TextConsumerA { }

    [InputPort("text_in", PortType.Text)]
    private class TextConsumerB { }
    ```

    All tests use `[Trait("Category", "Integration")]`.

    **Discovery → Registry pipeline tests:**
    - `DiscoverAndRegister_PortsAvailableInRegistry` — use PortDiscovery to discover ports from TextProcessorModule, register in PortRegistry, then GetPorts returns correct count and metadata.
    - `DiscoverAndRegister_MultipleModules_AllTracked` — register TextProcessorModule and TriggerModule, GetAllPorts returns all 4 ports.

    **Fan-out validation tests (PORT-03):**
    - `FanOut_OneOutputToMultipleInputs_AllValid` — create PortMetadata for TextProcessorModule's text_out, then validate connection to TextConsumerA's text_in AND TextConsumerB's text_in. Both must return IsValid=true.
    - `FanOut_MixedTypes_RejectsIncompatible` — TextProcessorModule's text_out → TriggerModule's trigger_in must return IsValid=false with descriptive message.

    **End-to-end validation test:**
    - `FullPipeline_DiscoverValidateConnect` — discover ports from two modules, register both, get output port from first module, get input port from second module, validate connection, assert valid.

    Create fresh PortDiscovery, PortRegistry, and PortTypeValidator per test method for isolation.
  </action>
  <verify>
    <automated>dotnet test tests/OpenAnima.Tests/ --filter "Category=Integration&FullyQualifiedName~PortSystem" --logger "console;verbosity=detailed"</automated>
  </verify>
  <done>All port system integration tests pass. Discovery → Registry pipeline works end-to-end. Fan-out validation allows one output to multiple inputs of same type. Mixed-type connections rejected. Full pipeline (discover → register → validate) works correctly.</done>
</task>

</tasks>

<verification>
1. `dotnet test tests/OpenAnima.Tests/ --filter "Category=Integration"` — all integration tests green
2. Chat workflow tests verify EventBus broadcast pattern (foundation for v1.2 regression protection)
3. Port system integration tests verify discovery → registry → validation pipeline
4. Fan-out scenario explicitly tested (one output → multiple inputs)
5. No test isolation issues (fresh instances per test method)
</verification>

<success_criteria>
- ChatWorkflowTests verify EventBus publish/subscribe for MessageSent and ResponseReceived payloads
- PortSystemIntegrationTests verify full discovery → registry → validation pipeline
- Fan-out (one output to multiple inputs of same type) validated as allowed
- Cross-type connections validated as rejected
- All integration tests pass with `dotnet test --filter "Category=Integration"`
</success_criteria>

<output>
After completion, create `.planning/phases/11-port-type-system-testing-foundation/11-02-SUMMARY.md`
</output>

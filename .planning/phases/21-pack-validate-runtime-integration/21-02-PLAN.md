---
phase: 21-pack-validate-runtime-integration
plan: 02
type: execute
wave: 2
depends_on: [21-01]
files_modified:
  - src/OpenAnima.Cli/Services/PackService.cs
  - src/OpenAnima.Cli/Commands/PackCommand.cs
  - src/OpenAnima.Cli/Models/ModuleManifest.cs
  - src/OpenAnima.Cli/Program.cs
  - tests/OpenAnima.Cli.Tests/CliFoundationTests.cs
autonomous: true
requirements: [PACK-01, PACK-02, PACK-03, PACK-04, PACK-05]

must_haves:
  truths:
    - "Developer can run `oani pack <path>` to pack a module"
    - "Pack produces a .oamod file containing module.json and the DLL"
    - "Pack builds the project with dotnet build before packing (unless --no-build)"
    - "Developer can specify output directory with -o option"
    - "Packed .oamod contains MD5 checksum in manifest"
    - "Packed .oamod manifest includes targetFramework metadata"
  artifacts:
    - path: "src/OpenAnima.Cli/Services/PackService.cs"
      provides: "Pack logic: build, checksum, ZIP creation"
      contains: "class PackService"
    - path: "src/OpenAnima.Cli/Commands/PackCommand.cs"
      provides: "Pack command CLI definition"
      contains: "class PackCommand"
    - path: "src/OpenAnima.Cli/Models/ModuleManifest.cs"
      provides: "Checksum and targetFramework fields on manifest model"
      contains: "Checksum"
    - path: "src/OpenAnima.Cli/Program.cs"
      provides: "Pack command registration"
      contains: "PackCommand"
    - path: "tests/OpenAnima.Cli.Tests/CliFoundationTests.cs"
      provides: "Unit tests for pack command and service"
      contains: "PackService"
  key_links:
    - from: "src/OpenAnima.Cli/Commands/PackCommand.cs"
      to: "src/OpenAnima.Cli/Services/PackService.cs"
      via: "PackService.Pack() call"
      pattern: "PackService.*Pack"
    - from: "src/OpenAnima.Cli/Services/PackService.cs"
      to: "System.IO.Compression.ZipFile"
      via: "ZIP archive creation for .oamod"
      pattern: "ZipFile\\.Open|ZipArchive"
    - from: "src/OpenAnima.Cli/Services/PackService.cs"
      to: "System.Security.Cryptography.MD5"
      via: "MD5 checksum computation"
      pattern: "MD5\\.Create|ComputeHash"
    - from: "src/OpenAnima.Cli/Program.cs"
      to: "src/OpenAnima.Cli/Commands/PackCommand.cs"
      via: "rootCommand.AddCommand"
      pattern: "AddCommand.*[Pp]ack"
---

<objective>
Add the `oani pack <path>` command that builds and packages modules into distributable .oamod files.

Purpose: Developers need to package their validated modules into a single distributable file (.oamod) that contains the manifest and compiled DLL with an integrity checksum. This completes the develop-validate-pack workflow.

Output: PackService.cs + PackCommand.cs registered in Program.cs with passing unit tests.
</objective>

<execution_context>
@/home/user/.claude/get-shit-done/workflows/execute-plan.md
@/home/user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-pack-validate-runtime-integration/21-RESEARCH.md
@.planning/phases/21-pack-validate-runtime-integration/21-01-SUMMARY.md

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From src/OpenAnima.Cli/Services/ManifestValidator.cs:
```csharp
public static class ManifestValidator
{
    public static List<string> Validate(ModuleManifest manifest);
    public static (ModuleManifest? Manifest, List<string> Errors) ValidateJson(string json);
}
```

From src/OpenAnima.Cli/Models/ModuleManifest.cs:
```csharp
public class ModuleManifest
{
    [JsonPropertyName("schemaVersion")] public string SchemaVersion { get; set; } = "1.0";
    [JsonPropertyName("id")] public string? Id { get; set; }
    [JsonPropertyName("name")] public string? Name { get; set; }
    [JsonPropertyName("version")] public string Version { get; set; } = "1.0.0";
    [JsonPropertyName("description")] public string Description { get; set; } = string.Empty;
    [JsonPropertyName("author")] public string Author { get; set; } = string.Empty;
    [JsonPropertyName("entryAssembly")] public string? EntryAssembly { get; set; }
    [JsonPropertyName("openanima")] public OpenAnimaCompatibility? OpenAnima { get; set; }
    [JsonPropertyName("ports")] public PortDeclarations Ports { get; set; } = new();
    // targetFramework and checksum will be added by Plan 21-02 Task 1
    public string GetEntryAssembly() => EntryAssembly ?? $"{Name ?? "Module"}.dll";
}
```

From src/OpenAnima.Cli/ExitCodes.cs:
```csharp
public static class ExitCodes
{
    public const int Success = 0;
    public const int GeneralError = 1;
    public const int ValidationError = 2;
}
```

From src/OpenAnima.Cli/Commands/NewCommand.cs (pattern to follow):
```csharp
public class NewCommand : Command
{
    public NewCommand(TemplateEngine templateEngine) : base("new", "Create a new module project")
    {
        var moduleNameArgument = new Argument<string>("name", "...");
        var outputOption = new Option<DirectoryInfo?>(
            aliases: new[] { "--output", "-o" }, getDefaultValue: () => null, description: "...");
        // this.SetHandler(context => { context.ExitCode = HandleCommand(...); });
    }
}
```

From src/OpenAnima.Cli/Program.cs (registration pattern after Plan 21-01):
```csharp
rootCommand.AddCommand(newCommand);
rootCommand.AddCommand(new ValidateCommand());
// Pack command will be added here
```
</interfaces>
</context>

<tasks>

<task type="auto" tdd="true">
  <name>Task 1: Create PackService with build, checksum, and ZIP creation</name>
  <files>src/OpenAnima.Cli/Services/PackService.cs, src/OpenAnima.Cli/Models/ModuleManifest.cs, tests/OpenAnima.Cli.Tests/CliFoundationTests.cs</files>
  <behavior>
    - Test: PackService.ComputeMd5 returns correct hex string for known content
    - Test: PackService.Pack with valid module directory produces .oamod file
    - Test: Created .oamod is a valid ZIP containing module.json and the DLL
    - Test: module.json inside .oamod contains a "checksum" field with algorithm "md5" and a non-empty value
    - Test: module.json inside .oamod contains a "targetFramework" field (defaults to "net8.0")
    - Test: PackService.Pack with --no-build=true skips the build step
    - Test: PackService.Pack with missing module.json returns GeneralError
  </behavior>
  <action>
1. **Add checksum and targetFramework fields to ModuleManifest** (`src/OpenAnima.Cli/Models/ModuleManifest.cs`):
   Add new properties:
   ```csharp
   [JsonPropertyName("checksum")]
   public ChecksumInfo? Checksum { get; set; }

   [JsonPropertyName("targetFramework")]
   public string TargetFramework { get; set; } = "net8.0";
   ```
   Add a new class in the same file:
   ```csharp
   public class ChecksumInfo
   {
       [JsonPropertyName("algorithm")]
       public string Algorithm { get; set; } = "md5";
       [JsonPropertyName("value")]
       public string Value { get; set; } = string.Empty;
   }
   ```

2. **Create `src/OpenAnima.Cli/Services/PackService.cs`**:

   Public API:
   ```csharp
   public class PackService
   {
       public int Pack(string modulePath, string? outputPath, bool noBuild);
   }
   ```

   Implementation of `Pack()`:
   - Validate `modulePath` exists as a directory. If not, write error to stderr, return `ExitCodes.GeneralError`.
   - Check `module.json` exists in `modulePath`. If not, write error to stderr, return `ExitCodes.GeneralError`.
   - Parse manifest with `ManifestValidator.ValidateJson()`. If errors, report all to stderr and return `ExitCodes.ValidationError`.
   - **PACK-03:** If `!noBuild`, invoke `dotnet build "<modulePath>" --configuration Release` using `System.Diagnostics.Process`. Redirect stdout/stderr. If exit code != 0, report build failure to stderr and return `ExitCodes.GeneralError`. Handle `dotnet` not found gracefully: catch `System.ComponentModel.Win32Exception` and report "dotnet CLI not found."
   - **Find compiled DLL:** Search `bin/Release/net8.0/` and `bin/Debug/net8.0/` for a DLL matching manifest's `GetEntryAssembly()` name (e.g., `MyModule.dll`). Search Release first (since we build Release). If not found, report error.
   - **PACK-05:** Compute MD5 checksum of the DLL using `System.Security.Cryptography.MD5`. Create a `ChecksumInfo` with algorithm "md5" and the hex value (lowercase).
   - **Create enriched manifest in memory** (do NOT modify source module.json): Clone the manifest data, set the `Checksum` property, ensure `TargetFramework` is populated (default "net8.0" if not already set in source manifest), serialize to JSON string.
   - **PACK-02:** Create .oamod (ZIP) using `System.IO.Compression.ZipFile`:
     - Output path: `outputPath ?? Directory.GetCurrentDirectory()`
     - Filename: `{manifest.Id}.oamod`
     - Add `module.json` entry from the enriched manifest string (NOT from source file -- the source file should not have checksum).
     - Add DLL entry using `zip.CreateEntryFromFile(dllPath, Path.GetFileName(dllPath))`. CRITICAL: Use just the filename as entry name, NOT the full path.
   - Output `Console.WriteLine($"Packed: {oamodPath}")` and return `ExitCodes.Success`.

   Private helper method:
   ```csharp
   private static string ComputeMd5(string filePath)
   {
       using var md5 = System.Security.Cryptography.MD5.Create();
       using var stream = File.OpenRead(filePath);
       var hash = md5.ComputeHash(stream);
       return Convert.ToHexString(hash).ToLowerInvariant();
   }
   ```

   Private helper for build:
   ```csharp
   private int BuildProject(string modulePath)
   ```
   Uses `Process` with `FileName = "dotnet"`, `Arguments = $"build \"{modulePath}\" --configuration Release"`, `RedirectStandardOutput = true`, `RedirectStandardError = true`, `UseShellExecute = false`, `CreateNoWindow = true`. Start, WaitForExit, return ExitCode.

3. **Add unit tests** in `tests/OpenAnima.Cli.Tests/CliFoundationTests.cs`:
   New test class `PackServiceTests`:
   - Test `ComputeMd5` by making it internal and using `[InternalsVisibleTo]`, OR test indirectly through Pack. Alternatively, create a small temp file with known content and verify the checksum.
   - Test that Pack with a prepared temp directory (containing a module.json and a fake DLL file) produces a .oamod. Use `--no-build=true` (so no actual dotnet build needed). Verify the .oamod exists, is a valid ZIP, and contains `module.json` and the DLL filename.
   - Test that the embedded module.json in the .oamod has a checksum field.
   - Test that the embedded module.json in the .oamod has a "targetFramework" field.
   - Test that Pack with missing module.json returns GeneralError.
   - Use temp directories and clean up in finally blocks.

**CRITICAL: Anti-patterns to avoid:**
- Do NOT modify the source `module.json` on disk during pack. Only the in-ZIP copy gets the checksum.
- Do NOT bundle OpenAnima.Contracts.dll in the .oamod (out of scope per REQUIREMENTS.md).
- Do NOT use SHA256 -- user decision in CONTEXT.md is MD5 for integrity verification.
- Do NOT omit targetFramework from the packed manifest -- user decision in CONTEXT.md requires "module version, target platform version, target framework" metadata.
  </action>
  <verify>
    <automated>cd /home/user/OpenAnima && dotnet test tests/OpenAnima.Cli.Tests/ --filter "PackService" --no-restore --verbosity normal 2>&1 | tail -20</automated>
  </verify>
  <done>
    - PackService.cs exists with Pack method handling build, checksum, and ZIP creation
    - ModuleManifest.cs has ChecksumInfo class, Checksum property, and TargetFramework property
    - .oamod files are valid ZIPs containing module.json (with checksum and targetFramework) and the DLL
    - MD5 checksum is computed and embedded per user decision
    - All PackService tests pass
  </done>
</task>

<task type="auto" tdd="true">
  <name>Task 2: Create PackCommand and register in Program.cs</name>
  <files>src/OpenAnima.Cli/Commands/PackCommand.cs, src/OpenAnima.Cli/Program.cs, tests/OpenAnima.Cli.Tests/CliFoundationTests.cs</files>
  <behavior>
    - Test: `oani pack <valid-path>` delegates to PackService and returns correct exit code
    - Test: `oani pack <path> -o <output-dir>` passes output directory to PackService
    - Test: `oani pack <path> --no-build` passes noBuild=true to PackService
    - Test: `oani --help` output includes "pack" command description
  </behavior>
  <action>
1. **Create `src/OpenAnima.Cli/Commands/PackCommand.cs`** following NewCommand pattern:

   ```csharp
   public class PackCommand : Command
   {
       public PackCommand(PackService packService) : base("pack", "Pack module into a .oamod file")
   ```

   Arguments and options:
   - `Argument<string>("path", "Path to the module project directory")` -- use string not DirectoryInfo for graceful handling of nonexistent paths.
   - `Option<DirectoryInfo?>(["--output", "-o"], ...)` -- output directory, default null (current directory).
   - `Option<bool>(["--no-build"], ...)` -- skip building, default false.

   Handler: `this.SetHandler(context => { ... context.ExitCode = packService.Pack(path, output?.FullName, noBuild); })`

2. **Register in `src/OpenAnima.Cli/Program.cs`**:
   After the existing validate command registration, add:
   ```csharp
   var packService = new PackService();
   rootCommand.AddCommand(new PackCommand(packService));
   ```

   Update `PrintHelp()` to include:
   ```
   pack <path>       Pack module into a .oamod file
   ```

3. **Add tests** in `tests/OpenAnima.Cli.Tests/CliFoundationTests.cs`:
   New test class `PackCommandTests`:
   - Test: `oani pack /nonexistent` returns GeneralError (directory doesn't exist).
   - Test: `oani --help` output contains "pack".
   - Integration test: Create a temp module directory with module.json + fake DLL in bin/Release/net8.0/, run `Program.Main(new[] { "pack", tempDir, "--no-build", "-o", outputDir })`, verify .oamod file created in outputDir.

4. Run the full test suite to verify no regressions.
  </action>
  <verify>
    <automated>cd /home/user/OpenAnima && dotnet test tests/OpenAnima.Cli.Tests/ --filter "PackCommand" --no-restore --verbosity normal 2>&1 | tail -20</automated>
  </verify>
  <done>
    - PackCommand.cs exists with path argument, -o option, --no-build flag (PACK-01, PACK-04)
    - Pack command registered in Program.cs
    - `oani --help` lists pack command
    - Integration test confirms .oamod creation via CLI
    - All PackCommand tests pass, no regressions
  </done>
</task>

</tasks>

<verification>
- `dotnet build src/OpenAnima.Cli/` succeeds with no errors
- `dotnet test tests/OpenAnima.Cli.Tests/` shows all tests passing (validate + pack + existing)
- `dotnet run --project src/OpenAnima.Cli/ -- --help` output includes both "validate" and "pack" commands
- Created .oamod file can be opened as a ZIP and contains module.json + DLL
- module.json inside .oamod has checksum field with algorithm "md5"
- module.json inside .oamod has targetFramework field (default "net8.0")
</verification>

<success_criteria>
1. PackService.cs implements build + checksum + ZIP creation
2. PackCommand.cs provides `oani pack <path>` with -o and --no-build options
3. Pack builds project before packing unless --no-build (PACK-03)
4. .oamod contains module.json and DLL (PACK-02)
5. MD5 checksum embedded in manifest inside .oamod (PACK-05)
6. Target framework metadata embedded in manifest inside .oamod (per CONTEXT.md locked decision)
7. Output directory configurable with -o (PACK-04)
8. All tests pass with no regressions
</success_criteria>

<output>
After completion, create `.planning/phases/21-pack-validate-runtime-integration/21-02-SUMMARY.md`
</output>

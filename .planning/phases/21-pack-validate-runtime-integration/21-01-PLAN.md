---
phase: 21-pack-validate-runtime-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/OpenAnima.Cli/Commands/ValidateCommand.cs
  - src/OpenAnima.Cli/Program.cs
  - tests/OpenAnima.Cli.Tests/CliFoundationTests.cs
autonomous: true
requirements: [VAL-01, VAL-02, VAL-03, VAL-04, VAL-05]

must_haves:
  truths:
    - "Developer can run `oani validate <path>` and see validation results"
    - "Validate checks module.json exists and is valid JSON"
    - "Validate checks required manifest fields (id, version, name)"
    - "Validate verifies IModule implementation via assembly reflection"
    - "Validate reports ALL errors, not just the first one"
  artifacts:
    - path: "src/OpenAnima.Cli/Commands/ValidateCommand.cs"
      provides: "Validate command implementation"
      contains: "class ValidateCommand"
    - path: "src/OpenAnima.Cli/Program.cs"
      provides: "Command registration"
      contains: "ValidateCommand"
    - path: "tests/OpenAnima.Cli.Tests/CliFoundationTests.cs"
      provides: "Unit tests for validate command"
      contains: "ValidateCommand"
  key_links:
    - from: "src/OpenAnima.Cli/Commands/ValidateCommand.cs"
      to: "src/OpenAnima.Cli/Services/ManifestValidator.cs"
      via: "ManifestValidator.ValidateJson() call"
      pattern: "ManifestValidator\\.ValidateJson"
    - from: "src/OpenAnima.Cli/Commands/ValidateCommand.cs"
      to: "OpenAnima.Contracts.IModule"
      via: "Assembly reflection name-based check"
      pattern: "OpenAnima\\.Contracts\\.IModule"
    - from: "src/OpenAnima.Cli/Program.cs"
      to: "src/OpenAnima.Cli/Commands/ValidateCommand.cs"
      via: "rootCommand.AddCommand"
      pattern: "AddCommand.*[Vv]alidate"
---

<objective>
Add the `oani validate <path>` command that checks module projects for correctness.

Purpose: Developers need to validate their module projects before packing to catch errors early. The validate command checks manifest JSON validity, required fields, and IModule implementation in the compiled assembly.

Output: ValidateCommand.cs registered in Program.cs with passing unit tests.
</objective>

<execution_context>
@/home/user/.claude/get-shit-done/workflows/execute-plan.md
@/home/user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-pack-validate-runtime-integration/21-RESEARCH.md

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From src/OpenAnima.Cli/Services/ManifestValidator.cs:
```csharp
public static class ManifestValidator
{
    public static List<string> Validate(ModuleManifest manifest);
    public static (ModuleManifest? Manifest, List<string> Errors) ValidateJson(string json);
}
```

From src/OpenAnima.Cli/ExitCodes.cs:
```csharp
public static class ExitCodes
{
    public const int Success = 0;
    public const int GeneralError = 1;
    public const int ValidationError = 2;
}
```

From src/OpenAnima.Cli/Commands/NewCommand.cs (pattern to follow):
```csharp
public class NewCommand : Command
{
    // Constructor: base("new", "Create a new module project")
    // Argument<string> name, Option<DirectoryInfo?> output, Option<bool> dryRun
    // this.SetHandler(context => { context.ExitCode = HandleCommand(...); });
}
```

From src/OpenAnima.Cli/Program.cs (registration pattern):
```csharp
var templateEngine = new TemplateEngine();
var newCommand = new NewCommand(templateEngine);
rootCommand.AddCommand(newCommand);
```

From src/OpenAnima.Core/Plugins/PluginLoader.cs (IModule type scanning pattern):
```csharp
// Name-based comparison to handle cross-context type identity issues
var implementsIModule = type.GetInterfaces()
    .Any(i => i.FullName == "OpenAnima.Contracts.IModule");
```

From src/OpenAnima.Core/Plugins/PluginLoadContext.cs:
```csharp
public class PluginLoadContext : AssemblyLoadContext
{
    public PluginLoadContext(string pluginPath) : base(isCollectible: true)
}
```

From tests/OpenAnima.Cli.Tests/CliFoundationTests.cs (test helper pattern):
```csharp
private static int RunCliWithArgs(string[] args)
{
    var originalOut = Console.Out;
    var originalError = Console.Error;
    try {
        using var outWriter = new StringWriter();
        using var errorWriter = new StringWriter();
        Console.SetOut(outWriter);
        Console.SetError(errorWriter);
        return Program.Main(args);
    } finally {
        Console.SetOut(originalOut);
        Console.SetError(originalError);
    }
}
```
</interfaces>
</context>

<tasks>

<task type="auto" tdd="true">
  <name>Task 1: Create ValidateCommand with manifest and assembly validation</name>
  <files>src/OpenAnima.Cli/Commands/ValidateCommand.cs, src/OpenAnima.Cli/Program.cs, tests/OpenAnima.Cli.Tests/CliFoundationTests.cs</files>
  <behavior>
    - Test: `oani validate` with no path argument returns non-zero exit code (missing required argument)
    - Test: `oani validate <path-to-valid-module>` returns ExitCodes.Success
    - Test: `oani validate <path-with-no-module-json>` returns ExitCodes.ValidationError and stderr contains "module.json not found"
    - Test: `oani validate <path-with-invalid-json>` returns ExitCodes.ValidationError and stderr contains error about JSON
    - Test: `oani validate <path-with-missing-required-fields>` returns ExitCodes.ValidationError and stderr contains errors for EACH missing field (not just first)
  </behavior>
  <action>
Create `src/OpenAnima.Cli/Commands/ValidateCommand.cs` following the exact pattern of `NewCommand`:

1. Class `ValidateCommand` inheriting from `Command` with constructor `base("validate", "Validate a module project")`.

2. Add a required positional `Argument<string>("path", "Path to the module project directory")`.

3. Use `this.SetHandler(context => { ... context.ExitCode = HandleCommand(...); })` pattern.

4. In `HandleCommand(string modulePath)`:
   - Accumulate ALL errors in `List<string> errors` (VAL-05: report all, not just first).
   - VAL-02: Check `module.json` exists at `Path.Combine(modulePath, "module.json")`. If not, add error "module.json not found in '{modulePath}'."
   - If exists, read and call `ManifestValidator.ValidateJson(json)` to get manifest + errors (covers VAL-02 JSON validity and VAL-03 required fields).
   - VAL-04: If manifest parsed successfully, look for compiled DLL. Search `bin/` subdirectory tree for `*.dll` files matching the manifest's `GetEntryAssembly()` name. If DLL found, load it in an isolated `AssemblyLoadContext("validation", isCollectible: true)`, scan types for `IModule` by name-based comparison (`type.GetInterfaces().Any(i => i.FullName == "OpenAnima.Contracts.IModule")`). If no IModule found, add error. Always `context.Unload()` in finally block. If no DLL found, add informational warning (not error) -- module may not be built yet.
   - VAL-05: After collecting all errors, output each to stderr with `Console.Error.WriteLine($"error: {error}")`. If any errors, return `ExitCodes.ValidationError`. If clean, output `Console.WriteLine("Module is valid.")` and return `ExitCodes.Success`.

5. Register in `src/OpenAnima.Cli/Program.cs`:
   - After the existing `rootCommand.AddCommand(newCommand)` line, add: `rootCommand.AddCommand(new ValidateCommand());`
   - Update `PrintHelp()` to include `validate <path>  Validate a module project` in the Commands section.

6. Add unit tests in `tests/OpenAnima.Cli.Tests/CliFoundationTests.cs`:
   - New test class `ValidateCommandTests` with tests for: missing path errors, valid module directory returns success, missing module.json returns validation error, invalid JSON returns validation error, multiple errors reported (create module.json with empty id AND empty name, verify both errors appear). Use temp directories with `Path.GetTempPath()` and cleanup in `finally` blocks.

**CRITICAL pitfall to avoid:** Do NOT use `typeof(IModule).IsAssignableFrom(type)` for VAL-04 -- this causes type identity issues across load contexts. Use the name-based comparison pattern from PluginLoader: `i.FullName == "OpenAnima.Contracts.IModule"`.

**CRITICAL:** The validate path argument should accept a string path (not DirectoryInfo) to handle cases where the directory doesn't exist yet gracefully -- the command should report a clear error rather than System.CommandLine throwing.
  </action>
  <verify>
    <automated>cd /home/user/OpenAnima && dotnet test tests/OpenAnima.Cli.Tests/ --filter "ValidateCommand" --no-restore --verbosity normal 2>&1 | tail -20</automated>
  </verify>
  <done>
    - `oani validate <path>` command is registered and functional
    - Validates module.json existence and JSON validity (VAL-02)
    - Validates required manifest fields id, version, name (VAL-03)
    - Validates IModule implementation via assembly reflection when DLL exists (VAL-04)
    - Reports ALL validation errors, not just first (VAL-05)
    - All ValidateCommand tests pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify full validate command integration</name>
  <files>tests/OpenAnima.Cli.Tests/CliFoundationTests.cs</files>
  <action>
Run the full test suite to ensure no regressions from the validate command addition:

1. Run `dotnet build src/OpenAnima.Cli/` to verify the CLI project compiles cleanly.
2. Run `dotnet test tests/OpenAnima.Cli.Tests/` to verify all existing tests still pass plus the new validate tests.
3. Run `dotnet run --project src/OpenAnima.Cli/ -- validate --help` to verify the validate command appears in help and accepts the `--help` flag (sanity check for System.CommandLine registration).
4. Run `dotnet run --project src/OpenAnima.Cli/ -- --help` to verify the root help text now lists the `validate` command.

If any test failures or build errors, fix them before marking complete. The validate command must coexist with the existing `new` command without breaking anything.
  </action>
  <verify>
    <automated>cd /home/user/OpenAnima && dotnet test tests/OpenAnima.Cli.Tests/ --no-restore --verbosity normal 2>&1 | tail -20</automated>
  </verify>
  <done>
    - CLI project builds without errors
    - All existing CLI tests pass (no regressions)
    - All new ValidateCommand tests pass
    - `oani --help` lists the validate command
    - `oani validate` is accessible from command line
  </done>
</task>

</tasks>

<verification>
- `dotnet build src/OpenAnima.Cli/` succeeds with no errors
- `dotnet test tests/OpenAnima.Cli.Tests/` shows all tests passing
- `dotnet run --project src/OpenAnima.Cli/ -- --help` output includes "validate" command
- `dotnet run --project src/OpenAnima.Cli/ -- validate /nonexistent` outputs error to stderr and returns non-zero exit code
</verification>

<success_criteria>
1. ValidateCommand.cs exists and follows NewCommand pattern
2. `oani validate <path>` is registered and callable
3. Validates manifest JSON existence/validity (VAL-02)
4. Validates required fields id, version, name (VAL-03)
5. Validates IModule implementation by reflection when DLL present (VAL-04)
6. Reports ALL errors at once (VAL-05)
7. All tests pass with no regressions
</success_criteria>

<output>
After completion, create `.planning/phases/21-pack-validate-runtime-integration/21-01-SUMMARY.md`
</output>

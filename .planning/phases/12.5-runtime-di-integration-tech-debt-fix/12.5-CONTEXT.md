# Phase 12.5: Runtime DI Integration & Tech Debt Fix - Context

**Gathered:** 2026-02-26
**Status:** Ready for planning

<domain>
## Phase Boundary

Register WiringEngine, ConfigurationLoader, and PortRegistry in DI container; persist port discovery results at runtime. Closes 3 integration gaps and 2 broken flows from v1.3 audit. Module Load → Port Registration and Configuration Save/Load → Execution flows must work end-to-end at runtime (not just in tests).

</domain>

<decisions>
## Implementation Decisions

### Port Persistence Strategy
- In-memory storage with dynamic register/unregister support
- Ports registered immediately on module load (eager registration)
- Ports automatically cleared when module is unloaded or stopped
- If a module's port registration fails (type conflict, corrupt module), skip that module and log warning — don't block other modules
- PortRegistry interface should support dynamic registration/unregistration to prepare for future dynamic module loading

### Configuration Lifecycle
- Wiring configurations saved as JSON files
- Support multiple configuration files — users can save and switch between different Wiring schemes
- Auto-load last used configuration on application startup
- If configuration file is corrupt or incompatible, start with empty configuration + log warning
- No backup/rollback mechanism needed for now

### DI Registration Pattern
- Use extension methods (e.g., `AddWiringServices()`) to organize registration — one-line call in Program.cs
- Scoped lifetime for all core services (WiringEngine, PortRegistry, ConfigurationLoader) — prepares for future multi-Anima instances
- Register via interfaces (IWiringEngine, IPortRegistry, IConfigurationLoader), not concrete classes

### Claude's Discretion
- Internal implementation details of the extension method
- Exact JSON schema for configuration files
- Error logging format and verbosity levels
- Initialization order of services during startup

</decisions>

<specifics>
## Specific Ideas

- User plans to build a Marketplace for dynamic module download and loading — PortRegistry must support dynamic registration to accommodate this future need
- User plans to support multiple Anima instances in the same Dashboard with inter-instance communication — Scoped lifetime chosen specifically to prepare for this
- Multiple configuration files support enables users to experiment with different Wiring topologies

</specifics>

<deferred>
## Deferred Ideas

- Module Marketplace — dynamic download and loading of modules at runtime (new capability, own phase)
- Multi-Anima instances — multiple Anima instances in same Dashboard with inter-instance messaging (new capability, own phase)

</deferred>

---

*Phase: 12.5-runtime-di-integration-tech-debt-fix*
*Context gathered: 2026-02-26*

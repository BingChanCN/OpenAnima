---
phase: 12.5-runtime-di-integration-tech-debt-fix
plan: 02
type: execute
wave: 2
depends_on: ["12.5-01"]
files_modified:
  - src/OpenAnima.Core/Services/ModuleService.cs
  - src/OpenAnima.Core/Wiring/ConfigurationLoader.cs
  - src/OpenAnima.Core/Hosting/WiringInitializationService.cs
  - src/OpenAnima.Core/DependencyInjection/WiringServiceExtensions.cs
autonomous: true
requirements:
  - PORT-04
  - EDIT-06
  - E2E-01

must_haves:
  truths:
    - "Ports are discovered and registered in PortRegistry immediately when a module loads"
    - "Port registration failure for one module does not block other modules from loading"
    - "Last used wiring configuration auto-loads on application startup"
    - "Corrupt or missing configuration starts empty with warning log"
    - "ConfigurationLoader tracks last-saved config name in .lastconfig file"
  artifacts:
    - path: "src/OpenAnima.Core/Services/ModuleService.cs"
      provides: "Port discovery integration in LoadModule and ScanAndLoadAll"
      contains: "PortDiscovery"
    - path: "src/OpenAnima.Core/Hosting/WiringInitializationService.cs"
      provides: "IHostedService for config auto-load on startup"
      exports: ["WiringInitializationService"]
    - path: "src/OpenAnima.Core/Wiring/ConfigurationLoader.cs"
      provides: "Last-config tracking after save"
      contains: ".lastconfig"
  key_links:
    - from: "src/OpenAnima.Core/Services/ModuleService.cs"
      to: "src/OpenAnima.Core/Ports/PortDiscovery.cs"
      via: "PortDiscovery.DiscoverPorts() called after module registration"
      pattern: "_portDiscovery.DiscoverPorts"
    - from: "src/OpenAnima.Core/Services/ModuleService.cs"
      to: "src/OpenAnima.Core/Ports/IPortRegistry.cs"
      via: "IPortRegistry.RegisterPorts() called with discovered ports"
      pattern: "_portRegistry.RegisterPorts"
    - from: "src/OpenAnima.Core/Hosting/WiringInitializationService.cs"
      to: "src/OpenAnima.Core/Wiring/IConfigurationLoader.cs"
      via: "IConfigurationLoader.LoadAsync() for auto-load"
      pattern: "configLoader.LoadAsync"
---

<objective>
Integrate port discovery into module load flow and add configuration auto-load on startup.

Purpose: Close the two broken flows from audit: (1) Module Load → Port Registration must persist ports at runtime, (2) Configuration Save/Load → Execution must auto-load last config on startup.
Output: Updated ModuleService with port registration, WiringInitializationService for startup, ConfigurationLoader with last-config tracking.
</objective>

<execution_context>
@/home/user/.claude/get-shit-done/workflows/execute-plan.md
@/home/user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12.5-runtime-di-integration-tech-debt-fix/12.5-01-SUMMARY.md

<interfaces>
<!-- Interfaces created in Plan 01 — executor should use these directly -->

From src/OpenAnima.Core/Ports/IPortRegistry.cs (created in Plan 01):
```csharp
public interface IPortRegistry
{
    void RegisterPorts(string moduleName, List<PortMetadata> ports);
    List<PortMetadata> GetPorts(string moduleName);
    List<PortMetadata> GetAllPorts();
    void UnregisterPorts(string moduleName);
}
```

From src/OpenAnima.Core/Wiring/IConfigurationLoader.cs (created in Plan 01):
```csharp
public interface IConfigurationLoader
{
    Task SaveAsync(WiringConfiguration config, CancellationToken ct = default);
    Task<WiringConfiguration> LoadAsync(string configName, CancellationToken ct = default);
    ValidationResult ValidateConfiguration(WiringConfiguration config);
    List<string> ListConfigurations();
    Task DeleteAsync(string configName, CancellationToken ct = default);
}
```

From src/OpenAnima.Core/Wiring/IWiringEngine.cs (created in Plan 01):
```csharp
public interface IWiringEngine
{
    bool IsLoaded { get; }
    WiringConfiguration? GetCurrentConfiguration();
    void LoadConfiguration(WiringConfiguration config);
    Task ExecuteAsync(CancellationToken ct = default);
    void UnloadConfiguration();
}
```

From src/OpenAnima.Core/Services/ModuleService.cs (current):
```csharp
public class ModuleService : IModuleService
{
    private readonly PluginRegistry _registry;
    private readonly PluginLoader _loader;
    private readonly IEventBus _eventBus;
    // ... constructor injects these + ILogger + IHubContext
    public ModuleOperationResult LoadModule(string moduleDirectory) { ... }
    public IReadOnlyList<ModuleOperationResult> ScanAndLoadAll(string modulesPath) { ... }
    public ModuleOperationResult UnloadModule(string moduleName) { ... }
}
```

From src/OpenAnima.Core/Ports/PortDiscovery.cs:
```csharp
public class PortDiscovery
{
    public List<PortMetadata> DiscoverPorts(Type moduleType) { ... }
}
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate port discovery into ModuleService and add port cleanup on unload</name>
  <files>
    src/OpenAnima.Core/Services/ModuleService.cs
  </files>
  <action>
    Update ModuleService to inject `PortDiscovery` and `IPortRegistry` via constructor:

    1. Add constructor parameters: `PortDiscovery portDiscovery, IPortRegistry portRegistry`
    2. Store as `_portDiscovery` and `_portRegistry` fields

    3. In `LoadModule()` — after successful `_registry.Register()` and `InjectEventBus()`, add port discovery:
       ```
       var moduleType = result.Module.GetType();
       var ports = _portDiscovery.DiscoverPorts(moduleType);
       try
       {
           _portRegistry.RegisterPorts(result.Manifest.Name, ports);
           _logger.LogInformation("Registered {PortCount} ports for module {Name}",
               ports.Count, result.Manifest.Name);
       }
       catch (Exception ex)
       {
           // User decision: Skip module on port registration failure, don't block others
           _logger.LogWarning(ex, "Port registration failed for {Name}, skipping", result.Manifest.Name);
           _registry.Unregister(result.Manifest.Name);
           return new ModuleOperationResult(result.Manifest.Name, false, $"Port registration failed: {ex.Message}");
       }
       ```

    4. In `ScanAndLoadAll()` — add same port discovery pattern after each successful `_registry.Register()` + `InjectEventBus()`. Wrap in try-catch, log warning on failure, add failure result but continue loop.

    5. In `UnloadModule()` — after successful `_registry.Unregister()`, add:
       ```
       _portRegistry.UnregisterPorts(moduleName);
       ```
       This ensures ports are cleared when module is unloaded (user decision: dynamic register/unregister).
  </action>
  <verify>
    <automated>cd /home/user/OpenAnima && dotnet build src/OpenAnima.Core/ --no-restore 2>&1 | tail -5</automated>
  </verify>
  <done>ModuleService discovers and registers ports on load, unregisters on unload, port registration failure skips module with warning</done>
</task>

<task type="auto">
  <name>Task 2: Create WiringInitializationService and add last-config tracking</name>
  <files>
    src/OpenAnima.Core/Hosting/WiringInitializationService.cs
    src/OpenAnima.Core/Wiring/ConfigurationLoader.cs
    src/OpenAnima.Core/DependencyInjection/WiringServiceExtensions.cs
  </files>
  <action>
    1. Create `src/OpenAnima.Core/Hosting/WiringInitializationService.cs`:
       - Implements `IHostedService`
       - Constructor injects `IServiceProvider` and `ILogger<WiringInitializationService>` (NOT scoped services directly — singleton/scoped lifetime mismatch)
       - `StartAsync()`:
         - Read `.lastconfig` file from wiring-configs directory
         - If file doesn't exist or is empty, log info "No previous configuration found, starting empty" and return
         - Create scope via `_serviceProvider.CreateScope()`
         - Resolve `IConfigurationLoader` and `IWiringEngine` from scope
         - Try to load config via `configLoader.LoadAsync(lastConfigName, ct)`
         - Try to load into engine via `wiringEngine.LoadConfiguration(config)`
         - Catch `FileNotFoundException` → log warning, start empty
         - Catch `InvalidOperationException` → log warning (validation failed), start empty
         - Catch generic `Exception` → log error, start empty
         - Always dispose scope (`using var scope`)
       - `StopAsync()`: Log "Wiring system shutdown complete", return `Task.CompletedTask`
       - Config directory path: `Path.Combine(AppContext.BaseDirectory, "wiring-configs")` (same default as extension method)

    2. Update `src/OpenAnima.Core/Wiring/ConfigurationLoader.cs`:
       - In `SaveAsync()`, after the existing `JsonSerializer.SerializeAsync()` call, add last-config tracking:
         ```
         var lastConfigPath = Path.Combine(_configDirectory, ".lastconfig");
         await File.WriteAllTextAsync(lastConfigPath, config.Name, ct);
         ```
       - This tracks the last saved config for auto-load on next startup

    3. Update `src/OpenAnima.Core/DependencyInjection/WiringServiceExtensions.cs`:
       - Add `services.AddHostedService<WiringInitializationService>();` to the `AddWiringServices()` method
       - Add required using: `using OpenAnima.Core.Hosting;`
  </action>
  <verify>
    <automated>cd /home/user/OpenAnima && dotnet build src/OpenAnima.Core/ --no-restore 2>&1 | tail -5 && dotnet test --no-build 2>&1 | tail -10</automated>
  </verify>
  <done>WiringInitializationService exists and is registered, ConfigurationLoader writes .lastconfig on save, all existing tests pass</done>
</task>

</tasks>

<verification>
1. `dotnet build src/OpenAnima.Core/` succeeds
2. `dotnet test` — all existing tests pass
3. ModuleService.LoadModule() calls PortDiscovery.DiscoverPorts() and IPortRegistry.RegisterPorts()
4. ModuleService.UnloadModule() calls IPortRegistry.UnregisterPorts()
5. WiringInitializationService.cs exists in Hosting/ directory
6. ConfigurationLoader.SaveAsync() writes .lastconfig file
7. WiringServiceExtensions registers WiringInitializationService as hosted service
</verification>

<success_criteria>
- Port discovery integrated into both LoadModule and ScanAndLoadAll flows
- Port registration failure skips module with warning (does not block others)
- Ports cleared on module unload
- WiringInitializationService auto-loads last config on startup
- Corrupt/missing config starts empty with warning
- .lastconfig file written after every save
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/12.5-runtime-di-integration-tech-debt-fix/12.5-02-SUMMARY.md`
</output>

---
phase: 20-cli-foundation-templates
plan: 03
type: execute
wave: 2
depends_on:
  - 20-01
  - 20-02
files_modified:
  - src/OpenAnima.Cli/Commands/NewCommand.cs
  - src/OpenAnima.Cli/Commands/NewCommandOptions.cs
  - src/OpenAnima.Cli/Services/ModuleNameValidator.cs
  - tests/OpenAnima.Cli.Tests/OpenAnima.Cli.Tests.csproj
  - tests/OpenAnima.Cli.Tests/Commands/NewCommandTests.cs
  - tests/OpenAnima.Cli.Tests/Services/TemplateEngineTests.cs
autonomous: true
requirements:
  - SDK-01
  - SDK-02
  - SDK-03
  - TEMP-01
  - TEMP-02
  - TEMP-03

must_haves:
  truths:
    - "Developer can create new module project with `oani new <ModuleName>` command"
    - "Developer can specify output directory with `-o <path>` option"
    - "Developer can preview generated files with `--dry-run` option"
    - "Developer can specify module type with `--type` option"
    - "Developer can specify input ports with `--inputs` option"
    - "Developer can specify output ports with `--outputs` option"
  artifacts:
    - path: "src/OpenAnima.Cli/Commands/NewCommand.cs"
      provides: "`oani new` command implementation"
      min_lines: 100
    - path: "src/OpenAnima.Cli/Commands/NewCommandOptions.cs"
      provides: "Options model for new command"
      contains: "ModuleName|OutputPath|DryRun"
    - path: "tests/OpenAnima.Cli.Tests/Commands/NewCommandTests.cs"
      provides: "Unit tests for new command"
      min_lines: 80
  key_links:
    - from: "NewCommand"
      to: "TemplateEngine"
      via: "RenderModuleCs/RenderModuleCsproj/RenderModuleJson"
      pattern: "templateEngine\\.Render"
    - from: "NewCommand"
      to: "FileSystem"
      via: "Directory.CreateDirectory, File.WriteAllText"
      pattern: "Directory\\.Create|File\\.WriteAllText"
    - from: "Program.cs"
      to: "NewCommand"
      via: "rootCommand.Subcommands.Add"
      pattern: "newCommand"
---

<objective>
Implement the `oani new` command with full template customization options.

Purpose: Enable developers to create compilable module projects from the CLI.
Output: Working `oani new` command with all options and unit tests.
</objective>

<execution_context>
@/home/user/.claude/get-shit-done/workflows/execute-plan.md
@/home/user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-cli-foundation-templates/20-CONTEXT.md
@.planning/phases/20-cli-foundation-templates/20-RESEARCH.md
@.planning/phases/20-cli-foundation-templates/20-01-SUMMARY.md
@.planning/phases/20-cli-foundation-templates/20-02-SUMMARY.md

<interfaces>
<!-- Key types and contracts from prior plans. -->

From Plan 01 - CLI Foundation:
- ExitCodes.Success = 0, ExitCodes.GeneralError = 1, ExitCodes.ValidationError = 2
- RootCommand in Program.cs with global --verbosity option
- Console.Error.WriteLine for errors, Console.WriteLine for output

From Plan 02 - Manifest & Templates:
- TemplateEngine.RenderModuleCs(options) -> string
- TemplateEngine.RenderModuleCsproj(options) -> string
- TemplateEngine.RenderModuleJson(options) -> string
- ModuleManifest model for module.json
- ManifestValidator.Validate(manifest) -> List<string> errors

From src/OpenAnima.Contracts/Ports/PortType.cs:
```csharp
public enum PortType { Text = 0, Trigger = 1 }
```

From CONTEXT.md - Locked decisions:
- Only module name required (positional parameter)
- Parameter style: long/short forms (-t/--type, -n/--name)
- Default: generate minimal module when options not specified
- Validate parameters with friendly hints listing valid values
- Silent-first output: short confirmation "Created MyModule/"
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement NewCommand with all options</name>
  <files>src/OpenAnima.Cli/Commands/NewCommand.cs, src/OpenAnima.Cli/Commands/NewCommandOptions.cs, src/OpenAnima.Cli/Services/ModuleNameValidator.cs</files>
  <action>
Implement the `oani new` command with System.CommandLine:

1. Create `Commands/NewCommandOptions.cs`:
   - ModuleName: string (required)
   - OutputPath: DirectoryInfo (default: current directory)
   - DryRun: bool (default: false)
   - ModuleType: string (default: "standard" - only type for now)
   - Inputs: string[] (port names, default: empty)
   - Outputs: string[] (port names, default: empty)
   - Verbosity: string (from global option)

2. Create `Services/ModuleNameValidator.cs`:
   - Validate module name is valid C# identifier
   - Check for reserved names, invalid characters
   - Return friendly error messages with suggestions

3. Create `Commands/NewCommand.cs`:
   - Create Command with name "new" and description
   - Add positional argument: module name (required)
   - Add options:
     - `-o/--output`: DirectoryInfo, default current directory
     - `--dry-run`: bool, preview files without creating
     - `-t/--type`: string, default "standard"
     - `--inputs`: string[], AllowMultipleArgumentsPerToken=true
     - `--outputs`: string[], AllowMultipleArgumentsPerToken=true
   - SetAction to:
     a. Validate module name (return ValidationError if invalid)
     b. Parse port specifications (format: "Name:Type" or just "Name" defaults to Text)
     c. If --dry-run: print files to stdout, return Success
     d. Create output directory if not exists
     e. Use TemplateEngine to render all three files
     f. Write files to disk
     g. Print "Created {ModuleName}/" to stdout
     h. Return ExitCodes.Success

4. Register command in Program.cs (update the placeholder from Plan 01):
   - Instantiate NewCommand with dependencies
   - Add to rootCommand.Subcommands

Follow the exit code and stream discipline from Plan 01.
  </action>
  <verify>
    <automated>dotnet build src/OpenAnima.Cli/OpenAnima.Cli.csproj</automated>
  </verify>
  <done>
    - `oani new MyModule` creates a compilable project
    - `oani new MyModule -o ./output` creates in specified directory
    - `oani new MyModule --dry-run` prints files without creating
    - `oani new MyModule --inputs Text --outputs Result` adds port attributes
    - Invalid module name shows friendly error
    - Exit codes correct (0 success, non-0 failure)
  </done>
</task>

<task type="auto">
  <name>Task 2: Create unit tests for CLI components</name>
  <files>tests/OpenAnima.Cli.Tests/OpenAnima.Cli.Tests.csproj, tests/OpenAnima.Cli.Tests/Commands/NewCommandTests.cs, tests/OpenAnima.Cli.Tests/Services/TemplateEngineTests.cs</files>
  <action>
Create a test project for the CLI:

1. Create `tests/OpenAnima.Cli.Tests/OpenAnima.Cli.Tests.csproj`:
   - TargetFramework: net8.0
   - Reference xunit 2.9.3, Microsoft.NET.Test.Sdk 17.14.1
   - ProjectReference to OpenAnima.Cli

2. Create `tests/OpenAnima.Cli.Tests/Services/TemplateEngineTests.cs`:
   - Test RenderModuleCs produces valid C# code
   - Test RenderModuleCsproj produces valid project file
   - Test RenderModuleJson produces valid JSON
   - Test port attribute generation works
   - Test placeholder substitution is correct

3. Create `tests/OpenAnima.Cli.Tests/Commands/NewCommandTests.cs`:
   - Test valid module name passes validation
   - Test invalid module name fails with friendly error
   - Test --dry-run doesn't create files
   - Test output directory option works
   - Test port options generate correct attributes

Use xUnit with [Fact] and [Theory] attributes. Tests should be fast unit tests, not integration tests requiring actual file I/O (mock filesystem if needed).
  </action>
  <verify>
    <automated>dotnet test tests/OpenAnima.Cli.Tests/OpenAnima.Cli.Tests.csproj</automated>
  </verify>
  <done>
    - Test project compiles and runs
    - All tests pass
    - TemplateEngine tests cover rendering
    - NewCommand tests cover validation and options
  </done>
</task>

</tasks>

<verification>
1. Build all: `dotnet build`
2. Run tests: `dotnet test tests/OpenAnima.Cli.Tests`
3. Create a module: `dotnet run --project src/OpenAnima.Cli -- new TestModule -o /tmp/test-modules`
4. Verify created project compiles: `dotnet build /tmp/test-modules/TestModule/TestModule.csproj`
5. Test --dry-run: `dotnet run --project src/OpenAnima.Cli -- new TestModule --dry-run`
6. Test with ports: `dotnet run --project src/OpenAnima.Cli -- new PortedModule --inputs Text --outputs Result`
</verification>

<success_criteria>
- [ ] `oani new MyModule` creates a compilable module project
- [ ] `-o/--output` option specifies output directory
- [ ] `--dry-run` previews files without creating
- [ ] `--type` option accepts module type
- [ ] `--inputs` and `--outputs` options add port attributes
- [ ] Invalid module names show friendly errors
- [ ] All unit tests pass
- [ ] Generated project compiles with `dotnet build`
</success_criteria>

<output>
After completion, create `.planning/phases/20-cli-foundation-templates/20-03-SUMMARY.md`
</output>
---
phase: 20-cli-foundation-templates
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/OpenAnima.Cli/Models/ModuleManifest.cs
  - src/OpenAnima.Cli/Models/PortDeclaration.cs
  - src/OpenAnima.Cli/Services/ManifestValidator.cs
  - src/OpenAnima.Cli/Services/TemplateEngine.cs
  - src/OpenAnima.Cli/Templates/Module.cs.template
  - src/OpenAnima.Cli/Templates/Module.csproj.template
  - src/OpenAnima.Cli/Templates/module.json.template
autonomous: true
requirements:
  - SDK-04
  - SDK-05
  - MAN-01
  - MAN-02
  - MAN-03
  - MAN-04
  - MAN-05
  - TEMP-04
  - TEMP-05

must_haves:
  truths:
    - "Generated module project compiles without errors"
    - "Generated module implements IModule and IModuleMetadata interfaces"
    - "module.json supports id, version, name, description, author fields"
    - "module.json supports openanima version compatibility"
    - "module.json supports port declarations"
    - "Manifest validation rejects invalid JSON with clear error messages"
    - "Template generates port attributes based on specified ports"
  artifacts:
    - path: "src/OpenAnima.Cli/Models/ModuleManifest.cs"
      provides: "Manifest model for module.json"
      contains: "class ModuleManifest"
    - path: "src/OpenAnima.Cli/Services/TemplateEngine.cs"
      provides: "Template generation engine"
      min_lines: 80
    - path: "src/OpenAnima.Cli/Templates/Module.cs.template"
      provides: "C# code template"
      contains: "IModule"
    - path: "src/OpenAnima.Cli/Templates/Module.csproj.template"
      provides: "Project file template"
      contains: "ProjectReference"
    - path: "src/OpenAnima.Cli/Templates/module.json.template"
      provides: "Manifest template"
      contains: "schemaVersion"
  key_links:
    - from: "TemplateEngine"
      to: "Templates/*"
      via: "GetManifestResourceStream"
      pattern: "GetManifestResourceStream"
    - from: "Module.cs.template"
      to: "OpenAnima.Contracts"
      via: "IModule implementation"
      pattern: "IModule|IModuleMetadata"
    - from: "Module.csproj.template"
      to: "OpenAnima.Contracts"
      via: "ProjectReference"
      pattern: "ProjectReference"
---

<objective>
Create the manifest schema model and embedded templates for module project generation.

Purpose: Define the module.json schema and create compilable templates that implement IModule/IModuleMetadata.
Output: ModuleManifest model with validation, TemplateEngine service, and three embedded templates.
</objective>

<execution_context>
@/home/user/.claude/get-shit-done/workflows/execute-plan.md
@/home/user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-cli-foundation-templates/20-CONTEXT.md
@.planning/phases/20-cli-foundation-templates/20-RESEARCH.md

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From src/OpenAnima.Contracts/IModule.cs:
```csharp
public interface IModule
{
    IModuleMetadata Metadata { get; }
    Task InitializeAsync(CancellationToken cancellationToken = default);
    Task ShutdownAsync(CancellationToken cancellationToken = default);
}
```

From src/OpenAnima.Contracts/IModuleMetadata.cs:
```csharp
public interface IModuleMetadata
{
    string Name { get; }
    string Version { get; }
    string Description { get; }
}
```

From src/OpenAnima.Contracts/Ports/InputPortAttribute.cs:
```csharp
[AttributeUsage(AttributeTargets.Class, AllowMultiple = true)]
public class InputPortAttribute : Attribute
{
    public string Name { get; }
    public PortType Type { get; }
    public InputPortAttribute(string name, PortType type) { ... }
}
```

From src/OpenAnima.Contracts/Ports/PortType.cs:
```csharp
public enum PortType { Text = 0, Trigger = 1 }
```

From samples/SampleModule/SampleModule.csproj - ProjectReference pattern:
```xml
<ProjectReference Include="..\..\src\OpenAnima.Contracts\OpenAnima.Contracts.csproj">
  <Private>false</Private>
</ProjectReference>
```

From CONTEXT.md - Locked decisions:
- Single file (all code in one .cs file)
- Namespace: Project name only
- No default ports (developers add separately)
- Auto-generated metadata (name, version 1.0.0, placeholder author)
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ModuleManifest model with validation</name>
  <files>src/OpenAnima.Cli/Models/ModuleManifest.cs, src/OpenAnima.Cli/Models/PortDeclaration.cs, src/OpenAnima.Cli/Services/ManifestValidator.cs</files>
  <action>
Create the manifest model classes that map to module.json:

1. Create `Models/ModuleManifest.cs` with properties matching RESEARCH.md template:
   - SchemaVersion: string (default "1.0")
   - Id: string (required)
   - Name: string (required)
   - Version: string (default "1.0.0")
   - Description: string (default empty)
   - Author: string (default empty)
   - EntryAssembly: string (computed from name + ".dll")
   - OpenAnima: OpenAnimaCompatibility? (nullable, contains MinVersion/MaxVersion)
   - Ports: PortDeclarations (contains Inputs/Outputs arrays)

2. Create `Models/PortDeclaration.cs`:
   - Name: string
   - Type: string (Text or Trigger)

3. Create `Services/ManifestValidator.cs` with validation logic:
   - Validate required fields (id, name, version)
   - Validate port types are valid (Text, Trigger)
   - Return list of validation errors (aggregate all, per user decision)
   - Use clear, user-friendly error messages

Use System.Text.Json for serialization with JsonPropertyName attributes.
  </action>
  <verify>
    <automated>dotnet build src/OpenAnima.Cli/OpenAnima.Cli.csproj</automated>
  </verify>
  <done>
    - ModuleManifest class exists with all required fields
    - ManifestValidator.Validate() returns list of errors
    - Invalid JSON produces clear error messages
    - Required field validation works (id, name, version)
  </done>
</task>

<task type="auto">
  <name>Task 2: Create embedded templates for module generation</name>
  <files>src/OpenAnima.Cli/Templates/Module.cs.template, src/OpenAnima.Cli/Templates/Module.csproj.template, src/OpenAnima.Cli/Templates/module.json.template, src/OpenAnima.Cli/Services/TemplateEngine.cs</files>
  <action>
Create the three template files and TemplateEngine service:

1. Create `Templates/Module.cs.template`:
   - Use placeholder syntax: {{ModuleName}}, {{Namespace}}, {{PortAttributes}}
   - Include using statements for OpenAnima.Contracts and OpenAnima.Contracts.Ports
   - Implement IModule interface with Metadata property, InitializeAsync, ShutdownAsync
   - Create internal {{ModuleName}}Metadata class implementing IModuleMetadata
   - Add TODO comments for developer guidance
   - Single-file structure (all code in one file)

2. Create `Templates/Module.csproj.template`:
   - TargetFramework: net8.0
   - ImplicitUsings and Nullable enabled
   - ProjectReference to OpenAnima.Contracts with Private=false
   - Use placeholder: {{ModuleName}} for project name

3. Create `Templates/module.json.template`:
   - Include $schema reference
   - SchemaVersion: "1.0"
   - All manifest fields with placeholders
   - Empty inputs/outputs arrays

4. Create `Services/TemplateEngine.cs`:
   - Load templates as embedded resources (not file paths - see Pitfall 3 in RESEARCH.md)
   - Methods: RenderModuleCs(), RenderModuleCsproj(), RenderModuleJson()
   - Simple string.Replace() for placeholder substitution
   - Handle port attribute generation: [InputPort("Name", PortType.Text)]

5. Update OpenAnima.Cli.csproj to embed templates:
   ```xml
   <ItemGroup>
     <EmbeddedResource Include="Templates\*" />
   </ItemGroup>
   ```

The generated code MUST compile successfully when OpenAnima.Contracts is referenced correctly.
  </action>
  <verify>
    <automated>dotnet build src/OpenAnima.Cli/OpenAnima.Cli.csproj</automated>
  </verify>
  <done>
    - Three template files exist with correct placeholders
    - TemplateEngine loads templates from embedded resources
    - RenderModuleCs() produces valid C# code
    - Module.cs.template includes IModule and IModuleMetadata implementation
    - Templates embedded in assembly (not file paths)
  </done>
</task>

</tasks>

<verification>
1. Build the CLI project: `dotnet build src/OpenAnima.Cli`
2. Verify ModuleManifest can deserialize valid JSON
3. Verify ManifestValidator catches missing required fields
4. Verify TemplateEngine.RenderModuleCs("TestModule") produces compilable code
5. Verify templates are embedded (check assembly with ildasm or similar)
</verification>

<success_criteria>
- [ ] ModuleManifest.cs exists with all MAN-01 to MAN-03 fields
- [ ] ManifestValidator.cs validates required fields and provides clear errors
- [ ] Module.cs.template implements IModule and IModuleMetadata
- [ ] Module.csproj.template references OpenAnima.Contracts
- [ ] module.json.template includes schemaVersion for MAN-05
- [ ] TemplateEngine loads templates from embedded resources
- [ ] All templates compile to valid output when rendered
</success_criteria>

<output>
After completion, create `.planning/phases/20-cli-foundation-templates/20-02-SUMMARY.md`
</output>
---
phase: 12-wiring-engine-execution-orchestration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/OpenAnima.Core/Wiring/WiringConfiguration.cs
  - src/OpenAnima.Core/Wiring/ConfigurationLoader.cs
  - tests/OpenAnima.Tests/Unit/ConfigurationLoaderTests.cs
autonomous: true
requirements: [WIRE-01, WIRE-03]

must_haves:
  truths:
    - "Wiring configuration can be saved to JSON and loaded back with full topology restoration"
    - "Configuration validation rejects references to non-existent modules"
    - "Configuration validation rejects incompatible port type connections"
    - "Multiple configurations can coexist and be listed"
  artifacts:
    - path: "src/OpenAnima.Core/Wiring/WiringConfiguration.cs"
      provides: "JSON schema models for wiring configuration (nodes, connections, visual layout)"
      exports: ["WiringConfiguration", "ModuleNode", "PortConnection", "VisualPosition", "VisualSize"]
    - path: "src/OpenAnima.Core/Wiring/ConfigurationLoader.cs"
      provides: "Async save/load/validate/list operations for wiring configurations"
      exports: ["ConfigurationLoader", "SaveAsync", "LoadAsync", "ValidateAsync", "ListConfigurations"]
    - path: "tests/OpenAnima.Tests/Unit/ConfigurationLoaderTests.cs"
      provides: "Unit tests for configuration persistence and validation"
      min_lines: 60
  key_links:
    - from: "src/OpenAnima.Core/Wiring/ConfigurationLoader.cs"
      to: "src/OpenAnima.Core/Ports/PortRegistry.cs"
      via: "Module existence check during validation"
      pattern: "PortRegistry.*GetPorts"
    - from: "src/OpenAnima.Core/Wiring/ConfigurationLoader.cs"
      to: "src/OpenAnima.Core/Ports/PortTypeValidator.cs"
      via: "Port type compatibility check during validation"
      pattern: "PortTypeValidator.*ValidateConnection"
---

<objective>
Wiring configuration schema models and async persistence layer with strict validation on load.

Purpose: Enables saving/loading wiring topologies as JSON files, with validation ensuring referenced modules exist and port types match. Provides the data model that WiringEngine (Plan 03) consumes.
Output: WiringConfiguration records, ConfigurationLoader service, unit tests.
</objective>

<execution_context>
@/home/user/.claude/get-shit-done/workflows/execute-plan.md
@/home/user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-wiring-engine-execution-orchestration/12-RESEARCH.md

<interfaces>
<!-- Phase 11 types used by ConfigurationLoader for validation -->

From src/OpenAnima.Contracts/Ports/PortMetadata.cs:
```csharp
public record PortMetadata(string Name, PortType Type, PortDirection Direction, string ModuleName)
{
    public string Id => $"{ModuleName}.{Direction}.{Name}";
}
```

From src/OpenAnima.Core/Ports/PortRegistry.cs:
```csharp
public class PortRegistry
{
    public void RegisterPorts(string moduleName, List<PortMetadata> ports);
    public List<PortMetadata> GetPorts(string moduleName);
    public List<PortMetadata> GetAllPorts();
    public void UnregisterPorts(string moduleName);
}
```

From src/OpenAnima.Core/Ports/PortTypeValidator.cs:
```csharp
public class PortTypeValidator
{
    public ValidationResult ValidateConnection(PortMetadata source, PortMetadata target);
}
```

From src/OpenAnima.Core/Ports/ValidationResult.cs:
```csharp
public record ValidationResult(bool IsValid, string? ErrorMessage)
{
    public static ValidationResult Success() => new(true, null);
    public static ValidationResult Fail(string message) => new(false, message);
}
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WiringConfiguration schema models</name>
  <files>src/OpenAnima.Core/Wiring/WiringConfiguration.cs</files>
  <action>
    Create `src/OpenAnima.Core/Wiring/WiringConfiguration.cs` in namespace `OpenAnima.Core.Wiring`.

    Define immutable record types for JSON serialization:

    1. `WiringConfiguration` — top-level config:
       - string Name (config name, used as filename)
       - string Version (schema version, default "1.0")
       - List<ModuleNode> Nodes (modules in this config)
       - List<PortConnection> Connections (port-to-port connections)

    2. `ModuleNode` — a module placed in the config:
       - string ModuleId (unique identifier matching loaded module name)
       - string ModuleName (display name)
       - VisualPosition Position (for Phase 13 editor, default 0,0)
       - VisualSize Size (for Phase 13 editor, default 200x100)

    3. `PortConnection` — a connection between two ports:
       - string SourceModuleId
       - string SourcePortName
       - string TargetModuleId
       - string TargetPortName

    4. `VisualPosition` — record(double X, double Y)
    5. `VisualSize` — record(double Width, double Height)

    Use System.Text.Json attributes:
    - Add [JsonPropertyName] with camelCase names on all properties
    - Records should have parameterless constructor support for deserialization (use { get; init; } pattern)

    Per user decision: single JSON file contains both logical topology AND visual layout for Phase 13 readiness.
  </action>
  <verify>
    <automated>dotnet build src/OpenAnima.Core/ --no-restore 2>&1 | tail -5</automated>
  </verify>
  <done>WiringConfiguration and related records compile, all properties have JSON serialization attributes, visual layout fields present for Phase 13.</done>
</task>

<task type="auto">
  <name>Task 2: ConfigurationLoader with async persistence and strict validation</name>
  <files>src/OpenAnima.Core/Wiring/ConfigurationLoader.cs, tests/OpenAnima.Tests/Unit/ConfigurationLoaderTests.cs</files>
  <action>
    Create `src/OpenAnima.Core/Wiring/ConfigurationLoader.cs` in namespace `OpenAnima.Core.Wiring`.

    Constructor takes:
    - string configDirectory (base path for config files)
    - PortRegistry portRegistry (for module existence validation)
    - PortTypeValidator portTypeValidator (for connection type validation)

    Public methods:

    1. `async Task SaveAsync(WiringConfiguration config, CancellationToken ct = default)`
       - Serialize to `{configDirectory}/{config.Name}.json` using JsonSerializer.SerializeAsync
       - Use JsonSerializerOptions: WriteIndented=true, PropertyNamingPolicy=JsonNamingPolicy.CamelCase
       - Create directory if not exists

    2. `async Task<WiringConfiguration> LoadAsync(string configName, CancellationToken ct = default)`
       - Deserialize from `{configDirectory}/{configName}.json`
       - Throw FileNotFoundException if file missing
       - After deserialization, call ValidateConfiguration() — per user decision: strict validation on load

    3. `ValidationResult ValidateConfiguration(WiringConfiguration config)`
       - For each ModuleNode: check PortRegistry.GetPorts(moduleId) returns non-empty (module exists)
       - For each PortConnection: look up source and target PortMetadata from PortRegistry, call PortTypeValidator.ValidateConnection()
       - Return first failure found, or Success if all valid
       - Error messages should be descriptive: "Module '{moduleId}' not found" or "Invalid connection: {validatorMessage}"

    4. `List<string> ListConfigurations()`
       - Return filenames (without .json extension) from configDirectory
       - Return empty list if directory doesn't exist

    5. `async Task DeleteAsync(string configName, CancellationToken ct = default)`
       - Delete config file, throw if not found

    Create `tests/OpenAnima.Tests/Unit/ConfigurationLoaderTests.cs`:
    - Test save and load round-trip (serialize → deserialize → compare)
    - Test load non-existent file throws FileNotFoundException
    - Test validation rejects config with unknown module
    - Test validation rejects config with incompatible port types
    - Test ListConfigurations returns saved config names
    - Test validation passes for valid config with registered modules and compatible ports
    - Use temp directory for test isolation (clean up in Dispose)
  </action>
  <verify>
    <automated>dotnet test tests/OpenAnima.Tests/ --filter "FullyQualifiedName~ConfigurationLoader" -v normal</automated>
  </verify>
  <done>ConfigurationLoader saves/loads JSON configs with async I/O, validates module existence and port type compatibility on load, all unit tests pass.</done>
</task>

</tasks>

<verification>
dotnet test tests/OpenAnima.Tests/ --filter "FullyQualifiedName~ConfigurationLoader" -v normal
dotnet build src/OpenAnima.Core/ --no-restore
</verification>

<success_criteria>
- WiringConfiguration round-trips through JSON serialization without data loss
- ConfigurationLoader.ValidateConfiguration rejects unknown modules and incompatible port types
- Async file I/O used throughout (no synchronous File.ReadAllText)
- All unit tests pass
- Solution builds with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/12-wiring-engine-execution-orchestration/12-02-SUMMARY.md`
</output>

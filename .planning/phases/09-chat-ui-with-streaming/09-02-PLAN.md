---
phase: 09-chat-ui-with-streaming
plan: 02
type: execute
wave: 2
depends_on: [09-01]
files_modified:
  - src/OpenAnima.Core/Components/Shared/ChatPanel.razor
  - src/OpenAnima.Core/Components/Shared/ChatMessage.razor
  - src/OpenAnima.Core/Components/Shared/ChatMessage.razor.css
  - src/OpenAnima.Core/wwwroot/js/chat.js
autonomous: false
requirements: [CHAT-05, CHAT-06, CHAT-07]

must_haves:
  truths:
    - "User can copy any message content to clipboard"
    - "User can regenerate the last assistant response"
    - "User sees Markdown-formatted responses with syntax-highlighted code blocks"
  artifacts:
    - path: "src/OpenAnima.Core/Components/Shared/ChatMessage.razor"
      provides: "Copy button, Markdown rendering with MarkupString"
      contains: "MarkupString"
    - path: "src/OpenAnima.Core/Components/Shared/ChatPanel.razor"
      provides: "Regenerate last response logic"
      contains: "Regenerate"
  key_links:
    - from: "src/OpenAnima.Core/Components/Shared/ChatMessage.razor"
      to: "Markdig"
      via: "MarkdownPipeline for HTML rendering"
      pattern: "Markdig\\.Markdown\\.ToHtml"
    - from: "src/OpenAnima.Core/Components/Shared/ChatMessage.razor"
      to: "src/OpenAnima.Core/wwwroot/js/chat.js"
      via: "IJSRuntime for clipboard copy"
      pattern: "chatHelpers\\.copyToClipboard"
    - from: "src/OpenAnima.Core/Components/Shared/ChatPanel.razor"
      to: "ILLMService"
      via: "StreamAsync for regeneration"
      pattern: "StreamAsync"
---

<objective>
Add copy-to-clipboard, regenerate last response, and Markdown rendering with syntax highlighting to the chat UI.

Purpose: Complete the chat experience with essential interaction features (copy, regenerate) and proper content formatting (Markdown + code highlighting).

Output: Updated ChatMessage with copy button and Markdown rendering, updated ChatPanel with regenerate capability, enhanced chat.js with clipboard helper.
</objective>

<execution_context>
@/home/user/.claude/get-shit-done/workflows/execute-plan.md
@/home/user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-chat-ui-with-streaming/09-01-SUMMARY.md
@src/OpenAnima.Core/Components/Shared/ChatPanel.razor
@src/OpenAnima.Core/Components/Shared/ChatMessage.razor
@src/OpenAnima.Core/wwwroot/js/chat.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Markdown rendering, copy-to-clipboard, and regenerate functionality</name>
  <files>
    src/OpenAnima.Core/Components/Shared/ChatMessage.razor
    src/OpenAnima.Core/Components/Shared/ChatMessage.razor.css
    src/OpenAnima.Core/Components/Shared/ChatPanel.razor
    src/OpenAnima.Core/wwwroot/js/chat.js
  </files>
  <action>
**1. Add clipboard helper to chat.js:**
Add to the existing `window.chatHelpers` object:
```javascript
copyToClipboard: async function(text) {
    try {
        await navigator.clipboard.writeText(text);
        return true;
    } catch (err) {
        console.error('Copy failed:', err);
        return false;
    }
}
```

**2. Update ChatMessage.razor â€” Markdown rendering:**
- Add `@using Markdig` and `@using Markdown.ColorCode`
- Create a static `MarkdownPipeline` field:
  ```csharp
  private static readonly MarkdownPipeline _pipeline = new MarkdownPipelineBuilder()
      .UseAdvancedExtensions()
      .DisableHtml() // XSS prevention
      .UseColorCode(HtmlFormatterType.Style)
      .Build();
  ```
- Create `RenderContent()` method:
  - For assistant messages: convert Content to HTML via `Markdig.Markdown.ToHtml(Content, _pipeline)` and render as `@((MarkupString)html)`
  - For user messages: render as plain text (no Markdown processing)
  - During streaming (IsStreaming=true): still render Markdown but expect partial/incomplete markup â€” Markdig handles this gracefully

**3. Update ChatMessage.razor â€” Copy button:**
- Inject `IJSRuntime`
- Add a copy button (ðŸ“‹ icon or "Copy" text) that appears on hover over any message
- On click: call `chatHelpers.copyToClipboard(Content)` via JS interop (pass raw Content, not HTML)
- Show brief "Copied!" feedback â€” use a `_copied` bool that resets after 2 seconds via `Task.Delay`
- Position: top-right corner of message, semi-transparent until hover

**4. Update ChatMessage.razor.css:**
- `.copy-btn` positioned absolute top-right, opacity 0 by default, opacity 1 on `.message:hover`
- `.copied-feedback` brief green text feedback
- `.message-content` styles for rendered Markdown: style `pre`, `code`, `table`, `blockquote`, `ul`, `ol`, `h1`-`h6` elements to match dark theme
- Code blocks: dark background (slightly lighter than message bg), border-radius, padding, overflow-x auto
- Inline code: subtle background highlight

**5. Update ChatPanel.razor â€” Regenerate last response:**
- Add `RegenerateLastResponse()` method:
  1. Find the last assistant message in the list
  2. Remove it from the list
  3. Set `_isGenerating = true`
  4. Build conversation history from remaining messages
  5. Create new assistant message with IsStreaming=true
  6. Call StreamAsync with the history (same pattern as SendMessage)
  7. This effectively re-sends the conversation without the last assistant response
- Add a regenerate button (ðŸ”„ icon or "Regenerate" text) that appears below the last assistant message ONLY when:
  - Not currently streaming (`_isGenerating == false`)
  - The last message in the list is from the assistant
- Pass a `bool ShowRegenerate` parameter to the last ChatMessage, or render the button in ChatPanel directly below the last message
- The regenerate button should be subtle â€” small, muted color, left-aligned under the last assistant message

**IMPORTANT:**
- Markdown rendering during streaming: Markdig.ToHtml handles incomplete Markdown gracefully (unclosed backticks, partial lists). It won't crash.
- Copy should copy the RAW Markdown content, not the rendered HTML
- The `.DisableHtml()` pipeline option prevents XSS from user input being rendered as HTML
- Use `HtmlFormatterType.Style` for ColorCode so syntax highlighting works without external CSS
  </action>
  <verify>
    <automated>cd /home/user/OpenAnima && dotnet build src/OpenAnima.Core 2>&amp;1 | tail -5</automated>
    <manual>Run app, send a message asking for code (e.g., "Write a hello world in Python"). Verify: Markdown renders with formatting, code blocks have syntax highlighting, copy button appears on hover, regenerate button appears after response completes.</manual>
  </verify>
  <done>Assistant messages render Markdown with syntax-highlighted code blocks. Copy button on each message copies raw content to clipboard. Regenerate button below last assistant message re-sends conversation for new response.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify complete chat experience</name>
  <files>src/OpenAnima.Core/Components/Pages/Dashboard.razor</files>
  <action>
Human verification checkpoint. No automated changes â€” verify the complete chat experience built in Plan 01 and Task 1 of this plan.

What was built: Complete chat UI with streaming, Markdown rendering, copy, and regenerate.

How to verify:
1. Run: `dotnet run --project src/OpenAnima.Core`
2. Open dashboard in browser
3. Verify empty state shows welcome message
4. Type "Hello, write me a Python hello world with comments" and press Enter
5. Verify: user message appears right-aligned, assistant response streams token-by-token on the left
6. Verify: code block in response has syntax highlighting
7. Verify: auto-scroll follows the streaming response
8. Scroll up during streaming â€” verify auto-scroll pauses
9. Hover over a message â€” verify copy button appears
10. Click copy button â€” verify "Copied!" feedback and content is in clipboard
11. After response completes, verify regenerate button appears below last assistant message
12. Click regenerate â€” verify old response is replaced with new streaming response
13. Type a multi-line message with Shift+Enter â€” verify newline works
14. Verify input auto-expands for multi-line text
15. Verify input is disabled during streaming
  </action>
  <verify>Human visual and functional verification of all 15 checks above</verify>
  <done>All CHAT-01 through CHAT-07 requirements verified by human. Chat UI is complete for Phase 9.</done>
</task>

</tasks>

<verification>
1. `dotnet build src/OpenAnima.Core` compiles without errors
2. Markdown renders correctly in assistant messages (headers, lists, code blocks, inline code)
3. Code blocks have syntax highlighting via Markdown.ColorCode inline styles
4. Copy button appears on hover, copies raw Markdown to clipboard
5. Regenerate button appears after last assistant message, triggers new streaming response
6. All CHAT-01 through CHAT-07 requirements satisfied
</verification>

<success_criteria>
- Markdown rendering works for all common elements (headers, lists, code, tables)
- Code blocks have syntax highlighting
- Copy-to-clipboard works on all messages
- Regenerate replaces last assistant response with new streaming response
- Human verification confirms complete chat experience
</success_criteria>

<output>
After completion, create `.planning/phases/09-chat-ui-with-streaming/09-02-SUMMARY.md`
</output>

---
phase: 15-fix-configurationloader-key-mismatch
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/OpenAnima.Core/Wiring/ConfigurationLoader.cs
  - tests/OpenAnima.Tests/Unit/ConfigurationLoaderTests.cs
autonomous: true
gap_closure: true
requirements:
  - EDIT-05
  - WIRE-01
  - WIRE-03

must_haves:
  truths:
    - "ConfigurationLoader.ValidateConfiguration() uses ModuleName (not ModuleId) for IPortRegistry lookup"
    - "Save config then reload config round-trip completes without validation errors"
    - "Auto-load on startup restores previously saved configuration instead of starting empty"
    - "All 78 existing tests continue passing"
  artifacts:
    - path: "src/OpenAnima.Core/Wiring/ConfigurationLoader.cs"
      provides: "Fixed ValidateConfiguration with ModuleName lookup and GetModuleName helper"
      contains: "GetModuleName"
    - path: "tests/OpenAnima.Tests/Unit/ConfigurationLoaderTests.cs"
      provides: "Updated test mocks using ModuleName for registry keys + new regression test"
      contains: "ValidateConfiguration_ConnectionToNonExistentNode_ReturnsFailure"
  key_links:
    - from: "ConfigurationLoader.ValidateConfiguration()"
      to: "IPortRegistry.GetPorts()"
      via: "node.ModuleName instead of node.ModuleId"
      pattern: "_portRegistry\\.GetPorts\\(.*ModuleName"
    - from: "ConfigurationLoader.ValidateConfiguration()"
      to: "GetModuleName() helper"
      via: "connection.SourceModuleId/TargetModuleId resolved to ModuleName via node list"
      pattern: "GetModuleName\\(config,"
---

<objective>
Fix critical bug where ConfigurationLoader.ValidateConfiguration() uses ModuleId (GUID) to look up IPortRegistry keyed by ModuleName (string), breaking all config save/load flows.

Purpose: Unblock EDIT-05 (save/load round-trip), WIRE-01 (topological execution), and WIRE-03 (data routing) which all depend on successful configuration loading.
Output: Fixed ConfigurationLoader.cs with helper method, updated tests with correct registry keys, new regression test.
</objective>

<execution_context>
@/home/user/.claude/get-shit-done/workflows/execute-plan.md
@/home/user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-fix-configurationloader-key-mismatch/15-RESEARCH.md

@src/OpenAnima.Core/Wiring/ConfigurationLoader.cs
@tests/OpenAnima.Tests/Unit/ConfigurationLoaderTests.cs

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From src/OpenAnima.Core/Wiring/WiringConfiguration.cs:
```csharp
public record ModuleNode
{
    public string ModuleId { get; init; } = string.Empty;      // GUID - unique per instance
    public string ModuleName { get; init; } = string.Empty;    // Type name - registry key
    public VisualPosition Position { get; init; } = new();
    public VisualSize Size { get; init; } = new(200, 100);
}

public record PortConnection
{
    public string SourceModuleId { get; init; } = string.Empty;
    public string SourcePortName { get; init; } = string.Empty;
    public string TargetModuleId { get; init; } = string.Empty;
    public string TargetPortName { get; init; } = string.Empty;
}
```

From src/OpenAnima.Core/Ports/IPortRegistry.cs:
```csharp
public interface IPortRegistry
{
    void RegisterPorts(string moduleName, List<PortMetadata> ports);
    List<PortMetadata> GetPorts(string moduleName);  // Keyed by module name, NOT ModuleId
}
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix ValidateConfiguration ModuleId/ModuleName mismatch and update existing tests</name>
  <files>
    src/OpenAnima.Core/Wiring/ConfigurationLoader.cs
    tests/OpenAnima.Tests/Unit/ConfigurationLoaderTests.cs
  </files>
  <action>
**In `src/OpenAnima.Core/Wiring/ConfigurationLoader.cs`:**

1. Add a private helper method `GetModuleName` at the bottom of the class:

```csharp
private string GetModuleName(WiringConfiguration config, string moduleId)
{
    var node = config.Nodes.FirstOrDefault(n => n.ModuleId == moduleId);
    if (node == null)
    {
        throw new InvalidOperationException($"Module with ID '{moduleId}' not found in configuration");
    }
    return node.ModuleName;
}
```

2. In `ValidateConfiguration()`, change line 88 from:
   `var ports = _portRegistry.GetPorts(node.ModuleId);`
   to:
   `var ports = _portRegistry.GetPorts(node.ModuleName);`

3. Also update the error message on line 91 from `node.ModuleId` to `node.ModuleName`.

4. For connection validation (lines 99, 110), resolve ModuleId to ModuleName via the helper:
   - Before the source port lookup: `var sourceModuleName = GetModuleName(config, connection.SourceModuleId);`
   - Change `_portRegistry.GetPorts(connection.SourceModuleId)` to `_portRegistry.GetPorts(sourceModuleName)`
   - Update source port error message to use `sourceModuleName`
   - Before the target port lookup: `var targetModuleName = GetModuleName(config, connection.TargetModuleId);`
   - Change `_portRegistry.GetPorts(connection.TargetModuleId)` to `_portRegistry.GetPorts(targetModuleName)`
   - Update target port error message to use `targetModuleName`

**In `tests/OpenAnima.Tests/Unit/ConfigurationLoaderTests.cs`:**

5. Update ALL `_portRegistry.RegisterPorts()` calls to use `ModuleName` instead of `ModuleId` as the registry key. This makes tests match real-world behavior where registry is keyed by module type name:

   - `LoadAsync_RoundTrip_PreservesData` (line 67): Change `"module1"` to `"Module 1"` (matching the node's ModuleName). Also update the PortMetadata moduleName parameter.
   - `ValidateConfiguration_UnknownModule_ReturnsFailure` (line 94): Update the expected error message from `"Module 'unknown-module' not found"` to `"Module 'Unknown' not found"` (now uses ModuleName).
   - `ValidateConfiguration_IncompatiblePortTypes_ReturnsFailure` (lines 119-126): Change registry keys from `"module1"`/`"module2"` to `"Module 1"`/`"Module 2"`.
   - `ValidateConfiguration_ValidConfig_ReturnsSuccess` (lines 160-167): Change registry keys from `"module1"`/`"module2"` to `"Module 1"`/`"Module 2"`.
   - `LoadAsync_InvalidConfig_ThrowsInvalidOperationException` (line 230): This test expects validation failure for unknown module — update expected error message to use `ModuleName` ("Unknown") instead of `ModuleId`.

IMPORTANT: Use GUID-style strings for ModuleId in test nodes (e.g., `"node-guid-1"`) to ensure tests actually exercise the ModuleId-to-ModuleName resolution path. If ModuleId and ModuleName happen to be the same string, the bug would be masked.
  </action>
  <verify>
    <automated>cd /home/user/OpenAnima && dotnet test --filter "FullyQualifiedName~ConfigurationLoader" --no-restore -v minimal</automated>
  </verify>
  <done>
    - ValidateConfiguration uses node.ModuleName for module existence check
    - ValidateConfiguration resolves connection.SourceModuleId/TargetModuleId to ModuleName via GetModuleName helper
    - All existing ConfigurationLoader tests pass with updated registry keys
    - Test ModuleId values differ from ModuleName values to prevent masking
  </done>
</task>

<task type="auto">
  <name>Task 2: Add regression test and verify full suite</name>
  <files>
    tests/OpenAnima.Tests/Unit/ConfigurationLoaderTests.cs
  </files>
  <action>
Add a new test method `ValidateConfiguration_ConnectionToNonExistentNode_ReturnsFailure` that verifies connections referencing a ModuleId not present in the node list are rejected:

```csharp
[Fact]
public void ValidateConfiguration_ConnectionToNonExistentNode_ReturnsFailure()
{
    // Arrange - register ports for Module1
    _portRegistry.RegisterPorts("Module1", new List<PortMetadata>
    {
        new("output1", PortType.Text, PortDirection.Output, "Module1")
    });

    var config = new WiringConfiguration
    {
        Name = "orphan-connection",
        Nodes = new List<ModuleNode>
        {
            new() { ModuleId = "node-guid-1", ModuleName = "Module1" }
        },
        Connections = new List<PortConnection>
        {
            new()
            {
                SourceModuleId = "node-guid-1",
                SourcePortName = "output1",
                TargetModuleId = "non-existent-node",
                TargetPortName = "input1"
            }
        }
    };

    // Act
    var result = _loader.ValidateConfiguration(config);

    // Assert - should fail because TargetModuleId not in node list
    Assert.False(result.IsValid);
    Assert.Contains("non-existent-node", result.ErrorMessage);
}
```

After adding the test, run the FULL test suite to confirm all 78+ tests pass:

```bash
dotnet test --no-restore -v minimal
```
  </action>
  <verify>
    <automated>cd /home/user/OpenAnima && dotnet test --no-restore -v minimal</automated>
  </verify>
  <done>
    - New regression test validates that orphan connection ModuleIds are caught
    - Full test suite (78+ tests) passes with zero failures
    - No regressions in any other test class
  </done>
</task>

</tasks>

<verification>
1. `dotnet test --filter "FullyQualifiedName~ConfigurationLoader"` — all ConfigurationLoader tests pass
2. `dotnet test` — full suite (78+ tests) passes
3. Grep confirms no remaining `_portRegistry.GetPorts(node.ModuleId)` or `_portRegistry.GetPorts(connection.SourceModuleId)` patterns in ConfigurationLoader.cs
4. Grep confirms `GetModuleName` helper exists in ConfigurationLoader.cs
</verification>

<success_criteria>
- ConfigurationLoader.ValidateConfiguration() uses ModuleName for all IPortRegistry lookups
- GetModuleName helper resolves ModuleId to ModuleName via node list with clear error on missing node
- Save → Load round-trip works (LoadAsync_RoundTrip_PreservesData passes)
- Connection validation uses resolved ModuleName (not raw ModuleId)
- New regression test covers orphan connection scenario
- All 78+ existing tests pass without regression
</success_criteria>

<output>
After completion, create `.planning/phases/15-fix-configurationloader-key-mismatch/15-01-SUMMARY.md`
</output>

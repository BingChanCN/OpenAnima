---
phase: 17-e2e-module-pipeline-integration-editor-polish
plan: 02
type: execute
wave: 2
depends_on:
  - 17-01
files_modified:
  - src/OpenAnima.Core/Services/EditorStateService.cs
  - src/OpenAnima.Core/Components/Shared/NodeCard.razor
  - src/OpenAnima.Core/Components/Shared/EditorCanvas.razor
  - tests/OpenAnima.Tests/Unit/EditorStateServiceTests.cs
  - tests/OpenAnima.Tests/Integration/EditorRuntimeStatusIntegrationTests.cs
autonomous: true
requirements:
  - RTIM-01
  - RTIM-02
must_haves:
  truths:
    - "Editor node border reflects runtime status in real time: running=green, error=red, stopped/idle=gray"
    - "Running nodes show subtle pulse animation and smooth border transition"
    - "Error nodes show warning icon and expose error details via hover tooltip"
    - "Dragging incompatible port types shows explicit rejection feedback instead of silent cancel"
    - "Runtime hub events update the correct node identity in editor state"
  artifacts:
    - path: "src/OpenAnima.Core/Services/EditorStateService.cs"
      provides: "Runtime state mapping + incompatible-connection rejection signal lifecycle"
      contains: "UpdateModuleState"
    - path: "src/OpenAnima.Core/Components/Shared/NodeCard.razor"
      provides: "Status visuals, warning icon, tooltip details, running pulse"
    - path: "src/OpenAnima.Core/Components/Shared/EditorCanvas.razor"
      provides: "Consumption of rejection feedback state and runtime hub signal rendering refresh"
    - path: "tests/OpenAnima.Tests/Integration/EditorRuntimeStatusIntegrationTests.cs"
      provides: "RTIM status/error integration coverage"
      min_lines: 80
  key_links:
    - from: "RuntimeHub.ReceiveModuleStateChanged"
      to: "EditorStateService.UpdateModuleState"
      via: "SignalR handler in EditorCanvas"
      pattern: "ReceiveModuleStateChanged"
    - from: "RuntimeHub.ReceiveModuleError"
      to: "NodeCard error visuals"
      via: "EditorStateService.UpdateModuleError + NodeCard render"
      pattern: "UpdateModuleError"
    - from: "EditorStateService.EndConnectionDrag"
      to: "EditorCanvas/NodeCard rejection UI"
      via: "transient rejection state"
      pattern: "DragSourcePortType.*targetPortType"
---

<objective>
Polish editor runtime feedback so users can clearly see module state/error and incompatible connection rejection.

Purpose: Close RTIM-01 and RTIM-02 with explicit, test-backed runtime UX and remove silent failure paths in visual wiring.
Output: Runtime status visuals + rejection feedback state + tests for state mapping and UI signal flow.
</objective>

<execution_context>
@/home/user/.claude/get-shit-done/workflows/execute-plan.md
@/home/user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/home/user/OpenAnima/.planning/PROJECT.md
@/home/user/OpenAnima/.planning/ROADMAP.md
@/home/user/OpenAnima/.planning/STATE.md
@/home/user/OpenAnima/.planning/phases/17-e2e-module-pipeline-integration-editor-polish/17-CONTEXT.md
@/home/user/OpenAnima/.planning/phases/17-e2e-module-pipeline-integration-editor-polish/17-RESEARCH.md

<interfaces>
From src/OpenAnima.Core/Services/EditorStateService.cs:
```csharp
public void UpdateModuleState(string moduleId, string state);
public void UpdateModuleError(string moduleId, string errorMessage, string? stackTrace);
public ModuleRuntimeState? GetModuleState(string moduleId);
public string GetNodeBorderColor(string moduleId);
public void EndConnectionDrag(string? targetModuleId, string? targetPortName, PortType? targetPortType);
```

From src/OpenAnima.Core/Components/Shared/EditorCanvas.razor:
```csharp
_hubConnection.On<string, string>("ReceiveModuleStateChanged", ...)
_hubConnection.On<string, string, string?>("ReceiveModuleError", ...)
```

From src/OpenAnima.Core/Components/Shared/NodeCard.razor:
```csharp
private string GetBorderStroke();
private void HandleStatusClick();
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement explicit incompatible-connection rejection state and rendering hook</name>
  <files>
    src/OpenAnima.Core/Services/EditorStateService.cs
    src/OpenAnima.Core/Components/Shared/EditorCanvas.razor
    tests/OpenAnima.Tests/Unit/EditorStateServiceTests.cs
  </files>
  <action>Add transient rejection feedback state to EditorStateService (e.g., rejected source/target metadata + expires/clear mechanics) and set it in EndConnectionDrag when source/target port types mismatch. Ensure mismatch no longer silently disappears: state should be observable by UI for a short feedback window and cleared on next drag or timeout. Wire EditorCanvas to render rejection feedback while preserving existing drag throttling behavior. Add unit tests for lifecycle: mismatch sets rejection state, successful compatible drop does not set rejection, and rejection clears deterministically.</action>
  <verify>
    <automated>dotnet test /home/user/OpenAnima/tests/OpenAnima.Tests/OpenAnima.Tests.csproj --filter "FullyQualifiedName~EditorStateServiceTests" --no-build</automated>
  </verify>
  <done>Incompatible drop produces deterministic, test-covered rejection signal consumed by editor UI; silent cancel path removed.</done>
</task>

<task type="auto">
  <name>Task 2: Apply RTIM visual contract on nodes and verify SignalR-to-node mapping</name>
  <files>
    src/OpenAnima.Core/Components/Shared/NodeCard.razor
    src/OpenAnima.Core/Services/EditorStateService.cs
    tests/OpenAnima.Tests/Integration/EditorRuntimeStatusIntegrationTests.cs
  </files>
  <action>Implement locked display decisions exactly: border state colors (running green, error red, stopped gray), smooth border transitions, subtle running pulse, tooltip with status/error details, and warning icon on error nodes. Keep node card uncluttered outside error emphasis. Confirm module identity mapping from runtime events to ModuleNode.ModuleId with integration tests that simulate ReceiveModuleStateChanged/ReceiveModuleError updates and assert the intended node visual state is derived from matching IDs. Include test assertions for RTIM-01 (state updates) and RTIM-02 (error indicators/details).</action>
  <verify>
    <automated>dotnet test /home/user/OpenAnima/tests/OpenAnima.Tests/OpenAnima.Tests.csproj --filter "FullyQualifiedName~EditorRuntimeStatusIntegrationTests" --no-build</automated>
  </verify>
  <done>Runtime state/error events consistently update the correct node visuals and error affordances per context decisions.</done>
</task>

</tasks>

<verification>
- Editor state and integration tests pass for rejection feedback and runtime status/error mapping.
- Manual wiring UX now makes incompatible drops visibly rejected.
</verification>

<success_criteria>
- Users can identify running/error/stopped status from node visuals in real time.
- Users can discover module error details directly from node UI.
- Incompatible drag-and-drop attempts provide immediate visual rejection feedback.
</success_criteria>

<output>
After completion, create `/home/user/OpenAnima/.planning/phases/17-e2e-module-pipeline-integration-editor-polish/17-02-SUMMARY.md`
</output>

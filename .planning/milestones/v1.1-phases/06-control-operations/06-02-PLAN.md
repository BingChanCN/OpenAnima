---
phase: 06-control-operations
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/OpenAnima.Core/Components/Pages/Modules.razor
  - src/OpenAnima.Core/Components/Pages/Modules.razor.css
  - src/OpenAnima.Core/Components/Pages/Heartbeat.razor
  - src/OpenAnima.Core/Components/Pages/Heartbeat.razor.css
  - src/OpenAnima.Core/wwwroot/css/app.css
autonomous: true
requirements: [MOD-08, MOD-09, MOD-10, BEAT-02]

must_haves:
  truths:
    - "User can see available (not-yet-loaded) modules and click Load to load them"
    - "User can click Unload on a loaded module to remove it from runtime"
    - "User sees inline error message when a module load or unload fails"
    - "User can toggle heartbeat running state with a single button"
    - "Buttons show loading state (disabled + spinner) during async operations"
    - "Load/Unload buttons are mutually exclusive per module state"
    - "Only one module operation runs at a time (serial execution)"
  artifacts:
    - path: "src/OpenAnima.Core/Components/Pages/Modules.razor"
      provides: "Available modules list with Load buttons, loaded modules with Unload buttons, error display"
      contains: "LoadModule"
    - path: "src/OpenAnima.Core/Components/Pages/Heartbeat.razor"
      provides: "Start/Stop heartbeat toggle button with loading state"
      contains: "ToggleHeartbeat"
    - path: "src/OpenAnima.Core/wwwroot/css/app.css"
      provides: "Button loading states, spinner animation, toast/error styles"
      contains: ".btn.loading"
  key_links:
    - from: "src/OpenAnima.Core/Components/Pages/Modules.razor"
      to: "/hubs/runtime"
      via: "HubConnection.InvokeAsync for LoadModule/UnloadModule/GetAvailableModules"
      pattern: "InvokeAsync.*LoadModule"
    - from: "src/OpenAnima.Core/Components/Pages/Heartbeat.razor"
      to: "/hubs/runtime"
      via: "HubConnection.InvokeAsync for StartHeartbeat/StopHeartbeat"
      pattern: "InvokeAsync.*Heartbeat"
---

<objective>
Add interactive control UI: module load/unload buttons on Modules page, heartbeat start/stop toggle on Heartbeat page, with loading states and error display.

Purpose: Backend Hub methods exist from Plan 01. This plan wires the UI to those methods, giving users direct control over runtime operations from the dashboard.

Output: Updated Modules.razor with available/loaded sections and action buttons, updated Heartbeat.razor with toggle button, CSS for loading states and error display.
</objective>

<execution_context>
@/home/user/.claude/get-shit-done/workflows/execute-plan.md
@/home/user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-control-operations/06-01-SUMMARY.md
@src/OpenAnima.Core/Components/Pages/Modules.razor
@src/OpenAnima.Core/Components/Pages/Modules.razor.css
@src/OpenAnima.Core/Components/Pages/Heartbeat.razor
@src/OpenAnima.Core/Components/Pages/Heartbeat.razor.css
@src/OpenAnima.Core/Components/Pages/Monitor.razor.cs
@src/OpenAnima.Core/Hubs/RuntimeHub.cs
@src/OpenAnima.Core/wwwroot/css/app.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Modules page with load/unload controls and error display</name>
  <files>
    src/OpenAnima.Core/Components/Pages/Modules.razor
    src/OpenAnima.Core/Components/Pages/Modules.razor.css
  </files>
  <action>
Rewrite Modules.razor to add control operations. Follow the Monitor.razor.cs pattern for HubConnection setup. The page must implement `IAsyncDisposable`.

**Page structure (two sections):**

1. **Available Modules** section — modules in the `modules/` directory not yet loaded:
   - Each item shows module directory name + "Load" button
   - Load button disabled when any operation is in progress (serial execution per user constraint: 先串行后扩展)
   - On click: invoke Hub `LoadModule(moduleName)`, handle result
   - On success: refresh both lists via `GetAvailableModules` Hub call
   - On failure: show error toast/inline near the item

2. **Loaded Modules** section — currently loaded modules from `ModuleService.GetAllModules()`:
   - Each item shows module name, version, status indicator + "Unload" button
   - Unload button disabled when any operation is in progress
   - On click: invoke Hub `UnloadModule(moduleName)`, handle result
   - On success: module moves from loaded to available list
   - On failure: show error inline
   - Clicking module card still opens detail modal (preserve existing behavior)

**Key implementation details:**
- Add `@inject NavigationManager Navigation` and `@implements IAsyncDisposable`
- Create HubConnection in `OnInitializedAsync` pointing to `/hubs/runtime` (same URL as Monitor.razor.cs)
- Register `hubConnection.On<int>("ReceiveModuleCountChanged", ...)` to auto-refresh lists when other clients make changes
- Track `isOperating` bool (true when any load/unload is in progress) — disable ALL action buttons when true (serial execution)
- Track `Dictionary<string, string> moduleErrors` for per-module error messages
- Track `string? operatingModule` to show spinner on the specific button being operated
- Error display: show error text inline below the module item. Keep error brief (user constraint: 简短描述为主). Clear error when retrying.
- Call `GetAvailableModules` Hub method on init and after each operation to refresh available list
- Keep the existing ModuleDetailModal for viewing loaded module details

**Razor structure sketch:**
```razor
@page "/modules"
@using OpenAnima.Core.Services
@using OpenAnima.Core.Plugins
@using Microsoft.AspNetCore.SignalR.Client
@inject IModuleService ModuleService
@inject NavigationManager Navigation
@implements IAsyncDisposable

<h1 class="page-title">Modules</h1>

<!-- Available Modules Section -->
<div class="modules-section">
  <h2 class="section-title">Available</h2>
  @if (availableModules.Count == 0)
  { <p class="text-muted">No modules available. Place module folders in the modules directory.</p> }
  else
  { @foreach (var name in availableModules)
    { <div class="module-item card">
        <div class="module-item-info">
          <span class="module-item-name">@name</span>
          <span class="status-indicator available"><span class="status-dot"></span>Available</span>
        </div>
        <button class="btn btn-primary @(operatingModule == name ? "loading" : "")"
                disabled="@isOperating"
                @onclick="() => LoadModule(name)">
          @if (operatingModule == name) { <span class="spinner"></span> }
          Load
        </button>
        @if (moduleErrors.TryGetValue(name, out var err))
        { <div class="error-inline">@err</div> }
      </div>
    }
  }
</div>

<!-- Loaded Modules Section -->
<div class="modules-section">
  <h2 class="section-title">Loaded</h2>
  @if (ModuleService.Count == 0)
  { <p class="text-muted">No modules loaded.</p> }
  else
  { @foreach (var entry in ModuleService.GetAllModules())
    { var moduleName = entry.Manifest.Name;
      <div class="module-item card">
        <div class="module-item-info" @onclick="() => ShowDetails(entry)" style="cursor:pointer">
          <span class="module-item-name">@entry.Module.Metadata.Name</span>
          <span class="module-item-version">v@(entry.Module.Metadata.Version)</span>
          <span class="status-indicator loaded"><span class="status-dot"></span>Loaded</span>
        </div>
        <button class="btn btn-danger @(operatingModule == moduleName ? "loading" : "")"
                disabled="@isOperating"
                @onclick="() => UnloadModule(moduleName)">
          @if (operatingModule == moduleName) { <span class="spinner"></span> }
          Unload
        </button>
        @if (moduleErrors.TryGetValue(moduleName, out var err))
        { <div class="error-inline">@err</div> }
      </div>
    }
  }
</div>

<!-- Keep existing ModuleDetailModal -->
```

**Code-behind (@code block):**
- `HubConnection? hubConnection`
- `List<string> availableModules = new()`
- `bool isOperating = false`
- `string? operatingModule = null`
- `Dictionary<string, string> moduleErrors = new()`
- `OnInitializedAsync`: build hub connection, register `ReceiveModuleCountChanged` handler (calls `RefreshAvailableModules` + `StateHasChanged`), start connection, call `RefreshAvailableModules`
- `RefreshAvailableModules`: `availableModules = await hubConnection!.InvokeAsync<List<string>>("GetAvailableModules")`
- `LoadModule(string name)`: set `isOperating=true`, `operatingModule=name`, clear error for name, `StateHasChanged()`. Try invoke `LoadModule` Hub method. If `!result.Success`, set `moduleErrors[name] = result.Error ?? "Load failed"`. Finally: `isOperating=false`, `operatingModule=null`, `RefreshAvailableModules`, `StateHasChanged`.
- `UnloadModule(string name)`: same pattern but invoke `UnloadModule` Hub method.
- `DisposeAsync`: dispose hubConnection
- Keep `ShowDetails`/`CloseModal` and modal markup

**CSS updates (Modules.razor.css):**
- `.modules-section` with margin-bottom
- `.section-title` styling
- `.module-item` as flex row with space-between, align-items center, padding, gap
- `.module-item-info` as flex with gap for name/version/status
- `.error-inline` with red-tinted background, left border, small font (matches research pattern)
- `.status-indicator.available` with neutral/gray color
- Keep existing `.module-grid`, `.module-card` styles for backward compat but the new layout uses `.module-item` list style
  </action>
  <verify>
    Build compiles: `dotnet build src/OpenAnima.Core/`. Verify Modules.razor has HubConnection setup, LoadModule method, UnloadModule method, GetAvailableModules call, error display, IAsyncDisposable. Verify CSS has .module-item, .error-inline styles.
  </verify>
  <done>
    Modules page shows two sections: Available (with Load buttons) and Loaded (with Unload buttons). Buttons disable during operations (serial). Errors display inline per module. Module detail modal still works for loaded modules. Lists auto-refresh on changes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Heartbeat toggle button and shared control CSS</name>
  <files>
    src/OpenAnima.Core/Components/Pages/Heartbeat.razor
    src/OpenAnima.Core/Components/Pages/Heartbeat.razor.css
    src/OpenAnima.Core/wwwroot/css/app.css
  </files>
  <action>
**Heartbeat.razor** — Add start/stop toggle button and HubConnection. Page must implement `IAsyncDisposable`.

Add `@inject NavigationManager Navigation`, `@using Microsoft.AspNetCore.SignalR.Client`, `@implements IAsyncDisposable`.

**UI changes:**
- Below the existing status card, add a control section with a single toggle button
- Button text: "Start Heartbeat" when stopped, "Stop Heartbeat" when running (user constraint: 单按钮切换模式)
- Button class: `btn-primary` when stopped (start action), `btn-danger` when running (stop action)
- Button shows spinner and disables during operation (user constraint: 点击后按钮进入加载态并暂时禁用)
- If operation fails, show error inline below button (user constraint: 若停止心跳失败，保持当前运行状态)
- Also place heartbeat toggle in the status card area for prominence

**Code-behind (@code block):**
- `HubConnection? hubConnection`
- `bool isLoading = false`
- `string? errorMessage = null`
- `bool isRunning` — local state synced from HeartbeatService and Hub events
- `OnInitializedAsync`: build hub connection to `/hubs/runtime`, register `ReceiveHeartbeatStateChanged` handler (updates `isRunning`, clears error, calls `InvokeAsync(StateHasChanged)`), register `ReceiveHeartbeatTick` to update tick/latency display, start connection, set `isRunning = HeartbeatService.IsRunning`
- `ToggleHeartbeat`: set `isLoading=true`, `errorMessage=null`, `StateHasChanged()`. If running, invoke `StopHeartbeat`; else invoke `StartHeartbeat`. If result is false, set `errorMessage = "Operation failed. Please try again."`. On exception, set `errorMessage = "Connection error. Please refresh."`. Finally: `isLoading=false`, `StateHasChanged()`.
- `DisposeAsync`: dispose hubConnection

**Important:** The heartbeat status display should now use the local `isRunning` state (updated via SignalR) instead of directly reading `HeartbeatService.IsRunning`, so it stays in sync with real-time pushes. Also update tick count and latency from Hub events (like Monitor page does) so the stats are live.

**Heartbeat.razor.css** — Add:
- `.control-section` with margin-top, centered
- `.error-message` styling (red tint, left border)

**app.css** — Add shared button and loading state styles (used by both pages):
```css
/* Control buttons */
.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    padding: 8px 16px;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    min-width: 80px;
}

.btn-primary {
    background-color: var(--accent-color);
    color: var(--text-primary);
}

.btn-primary:hover:not(:disabled) {
    background-color: var(--accent-hover);
}

.btn-danger {
    background-color: var(--error-color, #ef4444);
    color: #fff;
}

.btn-danger:hover:not(:disabled) {
    opacity: 0.9;
}

.btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.btn.loading {
    color: transparent;
}

.btn.loading .spinner {
    position: absolute;
}

.spinner {
    width: 16px;
    height: 16px;
    border: 2px solid currentColor;
    border-top-color: transparent;
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}
```

Check existing app.css first — if any of these classes already exist, extend rather than duplicate. Use existing CSS custom properties (--accent-color, --text-primary, etc.) from the dark theme established in Phase 4.

Also add `.error-inline` as a global style in app.css:
```css
.error-inline {
    margin-top: 6px;
    padding: 6px 10px;
    background-color: rgba(248, 113, 113, 0.1);
    border-left: 3px solid var(--error-color, #ef4444);
    color: var(--error-color, #ef4444);
    font-size: 13px;
    border-radius: 0 4px 4px 0;
    width: 100%;
}
```
  </action>
  <verify>
    Build compiles: `dotnet build src/OpenAnima.Core/`. Verify Heartbeat.razor has toggle button with ToggleHeartbeat method, HubConnection, loading state, error display, IAsyncDisposable. Verify app.css has .btn, .btn-primary, .btn-danger, .btn.loading, .spinner, .error-inline styles.
  </verify>
  <done>
    Heartbeat page has a toggle button that starts/stops the heartbeat loop. Button shows correct label based on state, disables during operation, shows spinner while loading. Error displays inline on failure. Stats update in real-time via SignalR. Shared button/spinner/error CSS available globally for both pages.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build src/OpenAnima.Core/` compiles without errors
2. Modules page shows "Available" section with Load buttons and "Loaded" section with Unload buttons
3. Clicking Load invokes Hub LoadModule, updates lists on success, shows error on failure
4. Clicking Unload invokes Hub UnloadModule, removes from loaded list, shows error on failure
5. All buttons disable during any module operation (serial execution)
6. Heartbeat page has toggle button showing "Start Heartbeat" / "Stop Heartbeat"
7. Toggle button disables and shows spinner during operation
8. Failed operations show inline error, state remains consistent
9. Both pages use HubConnection for real-time state sync
</verification>

<success_criteria>
- User can load available modules from dashboard via Load button
- User can unload loaded modules from dashboard via Unload button
- User sees error message when module operation fails
- User can start and stop heartbeat from dashboard via toggle button
- All buttons show loading states during async operations
- Only one operation runs at a time (serial execution)
- Pages auto-update when state changes (via SignalR push)
</success_criteria>

<output>
After completion, create `.planning/phases/06-control-operations/06-02-SUMMARY.md`
</output>

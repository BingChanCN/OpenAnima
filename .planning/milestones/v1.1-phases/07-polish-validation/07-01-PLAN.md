---
phase: 07-polish-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/OpenAnima.Core/Components/Shared/ConfirmDialog.razor
  - src/OpenAnima.Core/Components/Shared/ConfirmDialog.razor.css
  - src/OpenAnima.Core/Components/Shared/ConnectionStatus.razor
  - src/OpenAnima.Core/Components/Shared/ConnectionStatus.razor.css
  - src/OpenAnima.Core/Components/Layout/MainLayout.razor
  - src/OpenAnima.Core/Components/Pages/Modules.razor
  - src/OpenAnima.Core/Components/Pages/Heartbeat.razor
autonomous: true
requirements: []

must_haves:
  truths:
    - "User sees confirmation dialog before unloading a module"
    - "User sees confirmation dialog before stopping the heartbeat"
    - "User sees global connection status indicator on every page"
    - "Connection indicator reflects Connected/Reconnecting/Disconnected states"
  artifacts:
    - path: "src/OpenAnima.Core/Components/Shared/ConfirmDialog.razor"
      provides: "Reusable confirmation dialog component"
      min_lines: 15
    - path: "src/OpenAnima.Core/Components/Shared/ConnectionStatus.razor"
      provides: "Global SignalR connection status indicator"
      min_lines: 20
    - path: "src/OpenAnima.Core/Components/Layout/MainLayout.razor"
      provides: "Layout with ConnectionStatus integrated"
      contains: "ConnectionStatus"
  key_links:
    - from: "src/OpenAnima.Core/Components/Pages/Modules.razor"
      to: "ConfirmDialog"
      via: "Component parameter binding"
      pattern: "ConfirmDialog"
    - from: "src/OpenAnima.Core/Components/Pages/Heartbeat.razor"
      to: "ConfirmDialog"
      via: "Component parameter binding"
      pattern: "ConfirmDialog"
    - from: "src/OpenAnima.Core/Components/Layout/MainLayout.razor"
      to: "ConnectionStatus"
      via: "Component embedding"
      pattern: "ConnectionStatus"
---

<objective>
Add UX polish: reusable confirmation dialog for destructive operations, global connection status indicator in MainLayout, and wire both into existing pages.

Purpose: Prevent accidental destructive operations (module unload, heartbeat stop) and give users persistent visibility into SignalR circuit health across all pages.
Output: ConfirmDialog.razor, ConnectionStatus.razor components; updated Modules.razor, Heartbeat.razor, MainLayout.razor
</objective>

<execution_context>
@/home/user/.claude/get-shit-done/workflows/execute-plan.md
@/home/user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-control-operations/06-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ConfirmDialog and ConnectionStatus shared components</name>
  <files>
    src/OpenAnima.Core/Components/Shared/ConfirmDialog.razor
    src/OpenAnima.Core/Components/Shared/ConfirmDialog.razor.css
    src/OpenAnima.Core/Components/Shared/ConnectionStatus.razor
    src/OpenAnima.Core/Components/Shared/ConnectionStatus.razor.css
  </files>
  <action>
Create ConfirmDialog.razor — a reusable modal confirmation dialog:
- Parameters: bool IsVisible, string Title, string Message, string ConfirmText (default "Confirm"), string ConfirmButtonClass (default "btn-danger"), EventCallback OnConfirm, EventCallback OnCancel
- Renders modal backdrop (click to cancel) with dialog box (stopPropagation)
- Shows Title, Message, Confirm button (styled with ConfirmButtonClass), Cancel button
- Only renders when IsVisible is true
- CSS: modal-backdrop with semi-transparent overlay, centered dialog box, action buttons row

Create ConnectionStatus.razor — a global SignalR connection indicator:
- Inject NavigationManager, implement IAsyncDisposable
- Create HubConnection to /hubs/runtime with WithAutomaticReconnect()
- Track HubConnectionState via Reconnecting/Reconnected/Closed events
- Render a small status dot with text: green "Connected", yellow pulsing "Reconnecting...", red "Disconnected"
- CSS: inline-flex layout, small colored dot (8px), status text, pulse animation for reconnecting
- Use the same ConnectionClass/ConnectionTitle pattern already proven in Monitor.razor.cs
  </action>
  <verify>
dotnet build src/OpenAnima.Core/ compiles without errors.
Grep confirms ConfirmDialog.razor has IsVisible, OnConfirm, OnCancel parameters.
Grep confirms ConnectionStatus.razor has HubConnection setup and IAsyncDisposable.
  </verify>
  <done>
ConfirmDialog.razor exists with modal overlay, confirm/cancel buttons, and parameterized title/message.
ConnectionStatus.razor exists with HubConnection tracking Connected/Reconnecting/Disconnected states.
Both have scoped CSS files.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire ConfirmDialog into Modules and Heartbeat pages, add ConnectionStatus to MainLayout</name>
  <files>
    src/OpenAnima.Core/Components/Pages/Modules.razor
    src/OpenAnima.Core/Components/Pages/Heartbeat.razor
    src/OpenAnima.Core/Components/Layout/MainLayout.razor
  </files>
  <action>
Update Modules.razor:
- Add ConfirmDialog component at bottom of page (before the existing ModuleDetailModal)
- Add state: bool showUnloadConfirm, string? moduleToUnload
- Change UnloadModule(name) to set moduleToUnload=name, showUnloadConfirm=true (show dialog instead of immediate unload)
- Add ConfirmUnload() method: sets showUnloadConfirm=false, then runs existing unload logic (the current UnloadModule body)
- Add CancelUnload() method: sets showUnloadConfirm=false, moduleToUnload=null
- ConfirmDialog binds: IsVisible=showUnloadConfirm, Title="Unload Module", Message="Are you sure you want to unload {moduleToUnload}? This will stop all module operations.", ConfirmText="Unload", OnConfirm=ConfirmUnload, OnCancel=CancelUnload

Update Heartbeat.razor:
- Add ConfirmDialog component
- Add state: bool showStopConfirm
- When user clicks toggle and heartbeat IS running (stop action): set showStopConfirm=true instead of calling Hub
- Start action (when stopped) proceeds immediately without confirmation (starting is not destructive)
- Add ConfirmStop() method: sets showStopConfirm=false, then runs existing stop logic
- Add CancelStop() method: sets showStopConfirm=false
- ConfirmDialog binds: IsVisible=showStopConfirm, Title="Stop Heartbeat", Message="Are you sure you want to stop the heartbeat loop?", ConfirmText="Stop", OnConfirm=ConfirmStop, OnCancel=CancelStop

Update MainLayout.razor:
- Add ConnectionStatus component in the sidebar-header area, after the logo-area div and before the sidebar-toggle button
- Only show when sidebar is NOT collapsed (same pattern as logo-text)
  </action>
  <verify>
dotnet build src/OpenAnima.Core/ compiles without errors.
Grep confirms Modules.razor contains "ConfirmDialog" and "showUnloadConfirm".
Grep confirms Heartbeat.razor contains "ConfirmDialog" and "showStopConfirm".
Grep confirms MainLayout.razor contains "ConnectionStatus".
  </verify>
  <done>
Unloading a module shows confirmation dialog before proceeding.
Stopping heartbeat shows confirmation dialog before proceeding.
Starting heartbeat proceeds immediately (not destructive).
ConnectionStatus indicator visible in sidebar on all pages.
Project builds without errors.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build src/OpenAnima.Core/` — zero errors
2. ConfirmDialog.razor has parameters: IsVisible, Title, Message, ConfirmText, OnConfirm, OnCancel
3. ConnectionStatus.razor has HubConnection with WithAutomaticReconnect and state tracking
4. Modules.razor shows ConfirmDialog before unload operations
5. Heartbeat.razor shows ConfirmDialog before stop operations (not start)
6. MainLayout.razor includes ConnectionStatus component
</verification>

<success_criteria>
- Confirmation dialogs prevent accidental destructive operations (unload module, stop heartbeat)
- Connection status indicator shows SignalR circuit health globally
- All existing functionality preserved (loading states, error handling, serial execution)
- Project compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/07-polish-validation/07-01-SUMMARY.md`
</output>

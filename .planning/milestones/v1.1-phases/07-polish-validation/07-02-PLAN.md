---
phase: 07-polish-validation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/OpenAnima.Tests/OpenAnima.Tests.csproj
  - tests/OpenAnima.Tests/MemoryLeakTests.cs
  - tests/OpenAnima.Tests/PerformanceTests.cs
  - tests/OpenAnima.Tests/TestHelpers/ModuleTestHarness.cs
autonomous: true
requirements: []

must_haves:
  truths:
    - "Memory leak test loads and unloads modules 100 times and verifies contexts are collected"
    - "Performance test loads 20+ modules and validates sustained heartbeat operation"
    - "Test project compiles and tests can be discovered by dotnet test"
  artifacts:
    - path: "tests/OpenAnima.Tests/OpenAnima.Tests.csproj"
      provides: "xUnit test project with references to Core and Contracts"
      contains: "xunit"
    - path: "tests/OpenAnima.Tests/MemoryLeakTests.cs"
      provides: "100-cycle load/unload memory leak verification"
      contains: "WeakReference"
    - path: "tests/OpenAnima.Tests/PerformanceTests.cs"
      provides: "20+ module sustained operation validation"
      contains: "20"
    - path: "tests/OpenAnima.Tests/TestHelpers/ModuleTestHarness.cs"
      provides: "Helper for creating test module assemblies at runtime"
      contains: "ModuleTestHarness"
  key_links:
    - from: "tests/OpenAnima.Tests/MemoryLeakTests.cs"
      to: "src/OpenAnima.Core/Plugins/PluginLoadContext.cs"
      via: "WeakReference tracking of PluginLoadContext"
      pattern: "PluginLoadContext"
    - from: "tests/OpenAnima.Tests/PerformanceTests.cs"
      to: "src/OpenAnima.Core/Services/HeartbeatService.cs"
      via: "HeartbeatLoop sustained operation"
      pattern: "HeartbeatService\\|HeartbeatLoop"
---

<objective>
Create xUnit test project with memory leak and performance validation tests for the OpenAnima runtime.

Purpose: Validate production stability — memory doesn't leak during module load/unload cycles, and heartbeat maintains performance with 20+ modules loaded.
Output: tests/OpenAnima.Tests/ project with MemoryLeakTests.cs, PerformanceTests.cs, and ModuleTestHarness.cs
</objective>

<execution_context>
@/home/user/.claude/get-shit-done/workflows/execute-plan.md
@/home/user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/OpenAnima.Core/Plugins/PluginLoadContext.cs
@src/OpenAnima.Core/Plugins/PluginRegistry.cs
@src/OpenAnima.Core/Plugins/PluginLoader.cs
@src/OpenAnima.Core/Services/HeartbeatService.cs
@src/OpenAnima.Core/Services/IHeartbeatService.cs
@src/OpenAnima.Core/Services/ModuleService.cs
@src/OpenAnima.Contracts/IModule.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create xUnit test project with ModuleTestHarness</name>
  <files>
    tests/OpenAnima.Tests/OpenAnima.Tests.csproj
    tests/OpenAnima.Tests/TestHelpers/ModuleTestHarness.cs
  </files>
  <action>
Create the test project:
- Run `dotnet new xunit -n OpenAnima.Tests -o tests/OpenAnima.Tests`
- Add project references: `dotnet add tests/OpenAnima.Tests reference src/OpenAnima.Core/OpenAnima.Core.csproj src/OpenAnima.Contracts/OpenAnima.Contracts.csproj`
- Note: There is no .sln file, so skip `dotnet sln add`

Create TestHelpers/ModuleTestHarness.cs:
- Static helper class that creates minimal test module assemblies at runtime using System.Reflection.Emit or by compiling simple C# code
- Method: CreateTestModuleDirectory(string basePath, string moduleName) that:
  1. Creates a subdirectory under basePath with the module name
  2. Creates a minimal module.json manifest file (Name, Version, EntryAssembly)
  3. Creates a minimal .NET assembly DLL that implements IModule (using Roslyn CSharpCompilation or a pre-built template DLL approach)
  4. Returns the path to the module directory
- Alternative simpler approach: Use a pre-built SampleModule if one exists in the project. Check for existing test modules first.
- If no pre-built module exists, create a method that generates a minimal DLL using System.Reflection.Emit with AssemblyBuilder (simpler than Roslyn, no extra dependency)
- The generated module must implement OpenAnima.Contracts.IModule with stub methods

IMPORTANT: Check what PluginLoader.LoadModule actually expects (manifest format, assembly structure) and match that exactly. Read PluginLoader.cs and PluginManifest.cs to understand the loading contract.
  </action>
  <verify>
dotnet build tests/OpenAnima.Tests/ compiles without errors.
File tests/OpenAnima.Tests/TestHelpers/ModuleTestHarness.cs exists and contains ModuleTestHarness class.
  </verify>
  <done>
xUnit test project exists with references to Core and Contracts.
ModuleTestHarness can create test module directories matching PluginLoader's expected format.
Project compiles.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement memory leak and performance validation tests</name>
  <files>
    tests/OpenAnima.Tests/MemoryLeakTests.cs
    tests/OpenAnima.Tests/PerformanceTests.cs
  </files>
  <action>
Create MemoryLeakTests.cs:
- Class with [Fact] test: UnloadModule_ReleasesMemory_After100Cycles
- Uses ModuleTestHarness to create a test module directory
- Loop 100 times: create PluginLoadContext, load assembly, create WeakReference to context, call context.Unload()
- After loop: call GC.Collect() + GC.WaitForPendingFinalizers() 3 times with 100ms delays
- Assert: fewer than 10 WeakReferences still alive (< 10% leak rate)
- Use [Trait("Category", "Integration")] for test categorization
- Handle the case where PluginLoadContext needs a real DLL path — use ModuleTestHarness output

Create PerformanceTests.cs:
- Class with [Fact] test: HeartbeatLoop_MaintainsPerformance_With20Modules
- Create HeartbeatLoop instance directly (it's in OpenAnima.Core.Runtime namespace)
- Create ModuleService or PluginRegistry and load 20 test modules via ModuleTestHarness
- Start heartbeat, run for 10 seconds (shorter than research suggested 30s — sufficient for validation)
- Collect LastTickLatencyMs samples every 200ms
- Stop heartbeat
- Assert: average latency < 50ms, max latency < 200ms (generous thresholds for CI)
- Use [Trait("Category", "Integration")] for test categorization
- Clean up: unload all modules, dispose resources

IMPORTANT: These are integration tests that exercise real runtime components. They should work without a web host — instantiate HeartbeatLoop and PluginRegistry directly. Check constructors to understand required dependencies and create them manually or with minimal mocking.
  </action>
  <verify>
dotnet build tests/OpenAnima.Tests/ compiles without errors.
dotnet test tests/OpenAnima.Tests/ --list-tests shows both test methods.
  </verify>
  <done>
MemoryLeakTests.cs has 100-cycle load/unload test with WeakReference verification.
PerformanceTests.cs has 20-module sustained heartbeat test with latency assertions.
Both tests compile and are discoverable by test runner.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build tests/OpenAnima.Tests/` — zero errors
2. `dotnet test tests/OpenAnima.Tests/ --list-tests` — shows MemoryLeakTests and PerformanceTests
3. MemoryLeakTests.cs contains WeakReference, 100 iterations, GC.Collect
4. PerformanceTests.cs contains 20 modules, latency measurement, performance assertions
5. ModuleTestHarness.cs creates valid test module directories
</verification>

<success_criteria>
- Test project compiles with references to OpenAnima.Core and OpenAnima.Contracts
- Memory leak test exercises 100 load/unload cycles with WeakReference verification
- Performance test loads 20+ modules and validates sustained heartbeat latency
- Tests are discoverable by `dotnet test --list-tests`
</success_criteria>

<output>
After completion, create `.planning/phases/07-polish-validation/07-02-SUMMARY.md`
</output>

@page "/modules"
@using OpenAnima.Core.Services
@using OpenAnima.Core.Plugins
@using Microsoft.AspNetCore.SignalR.Client
@inject IModuleService ModuleService
@inject NavigationManager Navigation
@implements IAsyncDisposable

<h1 class="page-title">Modules</h1>

<!-- Available Modules Section -->
<div class="modules-section">
    <h2 class="section-title">Available</h2>
    @if (availableModules.Count == 0)
    {
        <p class="text-muted">No modules available. Place module folders in the modules directory.</p>
    }
    else
    {
        @foreach (var name in availableModules)
        {
            <div class="module-item card">
                <div class="module-item-info">
                    <span class="module-item-name">@name</span>
                    <span class="status-indicator available"><span class="status-dot"></span>Available</span>
                </div>
                <button class="btn btn-primary @(operatingModule == name ? "loading" : "")"
                        disabled="@isOperating"
                        @onclick="() => LoadModule(name)">
                    @if (operatingModule == name) { <span class="spinner"></span> }
                    Load
                </button>
                @if (moduleErrors.TryGetValue(name, out var availErr))
                {
                    <div class="error-inline">@availErr</div>
                }
            </div>
        }
    }
</div>

<!-- Loaded Modules Section -->
<div class="modules-section">
    <h2 class="section-title">Loaded</h2>
    @if (ModuleService.Count == 0)
    {
        <p class="text-muted">No modules loaded.</p>
    }
    else
    {
        @foreach (var entry in ModuleService.GetAllModules())
        {
            var moduleName = entry.Manifest.Name;
            <div class="module-item card">
                <div class="module-item-info" @onclick="() => ShowDetails(entry)" style="cursor:pointer">
                    <span class="module-item-name">@entry.Module.Metadata.Name</span>
                    <span class="module-item-version">v@(entry.Module.Metadata.Version)</span>
                    <span class="status-indicator loaded"><span class="status-dot"></span>Loaded</span>
                </div>
                <button class="btn btn-danger @(operatingModule == moduleName ? "loading" : "")"
                        disabled="@isOperating"
                        @onclick="() => UnloadModule(moduleName)">
                    @if (operatingModule == moduleName) { <span class="spinner"></span> }
                    Unload
                </button>
                @if (moduleErrors.TryGetValue(moduleName, out var loadedErr))
                {
                    <div class="error-inline">@loadedErr</div>
                }
            </div>
        }
    }
</div>

<!-- Confirmation Dialog -->
<ConfirmDialog IsVisible="@showUnloadConfirm"
               Title="Unload Module"
               Message="@($"Are you sure you want to unload {moduleToUnload}? This will stop all module operations.")"
               ConfirmText="Unload"
               ConfirmButtonClass="btn-danger"
               OnConfirm="@ConfirmUnload"
               OnCancel="@CancelUnload" />

<!-- Keep existing ModuleDetailModal -->
<ModuleDetailModal IsVisible="@showModal"
                   Title="@(selectedModule?.Module.Metadata.Name ?? "")"
                   OnClose="@CloseModal">
    @if (selectedModule != null)
    {
        <div class="detail-grid">
            <div class="detail-row">
                <span class="detail-label">Version</span>
                <span class="detail-value">@selectedModule.Module.Metadata.Version</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Description</span>
                <span class="detail-value">@(selectedModule.Module.Metadata.Description ?? "No description")</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Loaded At</span>
                <span class="detail-value mono">@selectedModule.LoadedAt.ToString("yyyy-MM-dd HH:mm:ss")</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Assembly</span>
                <span class="detail-value mono">@selectedModule.Manifest.EntryAssembly</span>
            </div>
        </div>
    }
</ModuleDetailModal>

@code {
    private HubConnection? hubConnection;
    private List<string> availableModules = new();
    private bool isOperating = false;
    private string? operatingModule = null;
    private Dictionary<string, string> moduleErrors = new();
    private PluginRegistryEntry? selectedModule;
    private bool showModal;
    private bool showUnloadConfirm = false;
    private string? moduleToUnload = null;

    protected override async Task OnInitializedAsync()
    {
        hubConnection = new HubConnectionBuilder()
            .WithUrl(Navigation.ToAbsoluteUri("/hubs/runtime"))
            .WithAutomaticReconnect()
            .Build();

        hubConnection.On<int>("ReceiveModuleCountChanged", async (count) =>
        {
            await RefreshAvailableModules();
            await InvokeAsync(StateHasChanged);
        });

        await hubConnection.StartAsync();
        await RefreshAvailableModules();
    }

    private async Task RefreshAvailableModules()
    {
        if (hubConnection != null)
            availableModules = await hubConnection.InvokeAsync<List<string>>("GetAvailableModules");
    }

    private async Task LoadModule(string name)
    {
        isOperating = true;
        operatingModule = name;
        moduleErrors.Remove(name);
        StateHasChanged();

        try
        {
            var result = await hubConnection!.InvokeAsync<ModuleOperationResult>("LoadModule", name);
            if (!result.Success)
            {
                moduleErrors[name] = result.Error ?? "Load failed";
            }
        }
        catch (Exception ex)
        {
            moduleErrors[name] = $"Connection error: {ex.Message}";
        }
        finally
        {
            isOperating = false;
            operatingModule = null;
            await RefreshAvailableModules();
            StateHasChanged();
        }
    }

    private async Task UnloadModule(string name)
    {
        moduleToUnload = name;
        showUnloadConfirm = true;
    }

    private async Task ConfirmUnload()
    {
        showUnloadConfirm = false;
        if (moduleToUnload == null) return;

        var name = moduleToUnload;
        moduleToUnload = null;

        isOperating = true;
        operatingModule = name;
        moduleErrors.Remove(name);
        StateHasChanged();

        try
        {
            var result = await hubConnection!.InvokeAsync<ModuleOperationResult>("UnloadModule", name);
            if (!result.Success)
            {
                moduleErrors[name] = result.Error ?? "Unload failed";
            }
        }
        catch (Exception ex)
        {
            moduleErrors[name] = $"Connection error: {ex.Message}";
        }
        finally
        {
            isOperating = false;
            operatingModule = null;
            await RefreshAvailableModules();
            StateHasChanged();
        }
    }

    private void CancelUnload()
    {
        showUnloadConfirm = false;
        moduleToUnload = null;
    }

    private void ShowDetails(PluginRegistryEntry entry)
    {
        selectedModule = entry;
        showModal = true;
    }

    private void CloseModal()
    {
        showModal = false;
    }

    public async ValueTask DisposeAsync()
    {
        if (hubConnection is not null)
            await hubConnection.DisposeAsync();
    }
}

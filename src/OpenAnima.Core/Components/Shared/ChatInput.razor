@implements IDisposable

<div class="chat-input-container">
    <textarea
        id="chat-input"
        rows="1"
        placeholder="Type a message..."
        @oninput="OnInput"
        disabled="@IsDisabled">
    </textarea>
    <button class="send-btn" @onclick="OnClickSend" disabled="@(_isEmpty || IsDisabled)">
        â–¶
    </button>
</div>

@code {
    [Inject]
    private IJSRuntime JS { get; set; } = default!;

    [Parameter]
    public EventCallback<string> OnSend { get; set; }

    [Parameter]
    public bool IsDisabled { get; set; }

    private bool _isEmpty = true;
    private DotNetObjectReference<ChatInput>? _dotNetRef;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _dotNetRef = DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("chatHelpers.setupEnterHandler", "chat-input", _dotNetRef);
        }
    }

    private void OnInput(ChangeEventArgs e)
    {
        _isEmpty = string.IsNullOrWhiteSpace(e.Value?.ToString());
    }

    [JSInvokable]
    public async Task SendFromJs()
    {
        await DoSend();
    }

    private async Task OnClickSend()
    {
        await DoSend();
    }

    private async Task DoSend()
    {
        if (IsDisabled) return;

        var text = await JS.InvokeAsync<string>("chatHelpers.getTextareaValue", "chat-input");
        if (string.IsNullOrWhiteSpace(text)) return;

        _isEmpty = true;
        await JS.InvokeVoidAsync("chatHelpers.resetTextarea", "chat-input");
        StateHasChanged();
        await OnSend.InvokeAsync(text.Trim());
    }

    public void Dispose()
    {
        _dotNetRef?.Dispose();
    }
}

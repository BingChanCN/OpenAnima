@using OpenAnima.Core.Services
@using OpenAnima.Core.Wiring
@using OpenAnima.Core.Ports
@using OpenAnima.Contracts.Ports
@inject IPortRegistry _portRegistry
@inject EditorStateService _editorState

<g transform="translate(@Node.Position.X, @Node.Position.Y)" @onmousedown:stopPropagation>
    <!-- Background card -->
    <rect x="0" y="0"
          width="@_nodeWidth"
          height="@_nodeHeight"
          rx="8"
          fill="#1c1e2e"
          stroke="@GetBorderStroke()"
          stroke-width="@(IsSelected ? 2 : 1)"
          @onclick="HandleCardClick"
          style="cursor: pointer;" />

    <!-- Title bar -->
    <rect x="0" y="0"
          width="@_nodeWidth"
          height="@_titleHeight"
          rx="8"
          fill="#161822"
          @onmousedown="HandleTitleBarMouseDown"
          @onmousedown:preventDefault
          style="cursor: move;" />

    <!-- Title text -->
    @((MarkupString)$"<text x=\"{_nodeWidth / 2}\" y=\"{_titleHeight / 2 + 4}\" fill=\"#e4e6f0\" font-size=\"13\" font-family=\"var(--font-family)\" text-anchor=\"middle\" font-weight=\"500\" style=\"pointer-events: none\">{Node.ModuleName}</text>")

    <!-- Status indicator (dynamic color based on module runtime state) -->
    <circle cx="@(_nodeWidth - 12)" cy="@(_titleHeight / 2)" r="4"
            fill="@_editorState.GetNodeBorderColor(Node.ModuleId)"
            @onclick="HandleStatusClick" @onclick:stopPropagation
            style="cursor: pointer;" />

    <!-- Error popup overlay -->
    @if (_showErrorPopup && _errorState != null)
    {
        <foreignObject x="10" y="@(_titleHeight + 4)" width="@(_nodeWidth - 20)" height="120">
            <div xmlns="http://www.w3.org/1999/xhtml"
                 style="background: #2a1015; border: 1px solid #ff0000; border-radius: 6px; padding: 8px; font-size: 11px; color: #e4e6f0; overflow-y: auto; max-height: 112px; font-family: var(--font-family);">
                <div style="font-weight: 600; color: #ff6b6b; margin-bottom: 4px;">Error: @Node.ModuleName</div>
                <div style="color: #ccc; margin-bottom: 4px;">@_errorState.ErrorMessage</div>
                @if (_errorState.StackTrace != null)
                {
                    <div style="color: #888; font-size: 10px; white-space: pre-wrap; word-break: break-all;">@_errorState.StackTrace</div>
                }
                <div style="text-align: right; margin-top: 4px;">
                    <span @onclick="CloseErrorPopup" @onclick:stopPropagation
                          style="cursor: pointer; color: #6c8cff; font-size: 10px;">Close</span>
                </div>
            </div>
        </foreignObject>
    }

    <!-- Input ports (left side) -->
    @foreach (var (port, index) in _inputPorts.Select((p, i) => (p, i)))
    {
        var portY = _titleHeight + index * _portSpacing + _portOffsetY;

        <!-- Port circle -->
        <circle cx="0" cy="@portY" r="6"
                fill="@PortColors.GetHex(port.Type)"
                @onmouseup="@(() => HandlePortMouseUp(port))"
                style="cursor: crosshair;" />

        <!-- Port label -->
        @((MarkupString)$"<text x=\"14\" y=\"{portY + 4}\" fill=\"#8b8fa3\" font-size=\"11\" font-family=\"var(--font-family)\" style=\"pointer-events: none\">{port.Name}</text>")
    }

    <!-- Output ports (right side) -->
    @foreach (var (port, index) in _outputPorts.Select((p, i) => (p, i)))
    {
        var portY = _titleHeight + index * _portSpacing + _portOffsetY;

        <!-- Port circle -->
        <circle cx="@_nodeWidth" cy="@portY" r="6"
                fill="@PortColors.GetHex(port.Type)"
                @onmousedown="@(() => HandlePortMouseDown(port))"
                @onmousedown:preventDefault
                style="cursor: crosshair;" />

        <!-- Port label -->
        @((MarkupString)$"<text x=\"{_nodeWidth - 14}\" y=\"{portY + 4}\" fill=\"#8b8fa3\" font-size=\"11\" font-family=\"var(--font-family)\" text-anchor=\"end\" style=\"pointer-events: none\">{port.Name}</text>")
    }
</g>

@code {
    [Parameter, EditorRequired]
    public ModuleNode Node { get; set; } = null!;

    [Parameter]
    public bool IsSelected { get; set; }

    private const double _nodeWidth = 200;
    private const double _titleHeight = 28;
    private const double _portSpacing = 24;
    private const double _portOffsetY = 12;
    private const double _minNodeHeight = 80;

    private List<PortMetadata> _inputPorts = new();
    private List<PortMetadata> _outputPorts = new();
    private double _nodeHeight;
    private bool _showErrorPopup;
    private EditorStateService.ModuleRuntimeState? _errorState;

    protected override void OnParametersSet()
    {
        // Get ports for this module
        var allPorts = _portRegistry.GetPorts(Node.ModuleName);
        _inputPorts = allPorts.Where(p => p.Direction == PortDirection.Input).ToList();
        _outputPorts = allPorts.Where(p => p.Direction == PortDirection.Output).ToList();

        // Calculate node height based on port count
        var maxPorts = Math.Max(_inputPorts.Count, _outputPorts.Count);
        _nodeHeight = Math.Max(_minNodeHeight, _titleHeight + maxPorts * _portSpacing + _portOffsetY);
    }

    private void HandleTitleBarMouseDown(MouseEventArgs e)
    {
        // Convert screen coordinates to canvas coordinates
        var (canvasX, canvasY) = _editorState.ScreenToCanvas(e.ClientX, e.ClientY);
        _editorState.StartNodeDrag(Node.ModuleId, canvasX, canvasY);
    }

    private void HandleCardClick(MouseEventArgs e)
    {
        // Select node on click (shift-click for multi-select)
        _editorState.SelectNode(Node.ModuleId, e.ShiftKey);
    }

    private void HandlePortMouseDown(PortMetadata port)
    {
        // Start connection drag from output port
        var portPos = _editorState.GetPortPosition(Node.ModuleId, port.Name, port.Direction);
        _editorState.StartConnectionDrag(Node.ModuleId, port.Name, port.Type, portPos.X, portPos.Y);
    }

    private void HandlePortMouseUp(PortMetadata port)
    {
        // End connection drag on input port
        if (_editorState.IsDraggingConnection)
        {
            _editorState.EndConnectionDrag(Node.ModuleId, port.Name, port.Type);
        }
    }

    private string GetBorderStroke()
    {
        if (IsSelected) return "#6c8cff";
        var stateColor = _editorState.GetNodeBorderColor(Node.ModuleId);
        return stateColor != "#808080" ? stateColor : "#2a2d3e";
    }

    private void HandleStatusClick()
    {
        var moduleState = _editorState.GetModuleState(Node.ModuleId);
        if (moduleState?.State == "Error")
        {
            _errorState = moduleState;
            _showErrorPopup = !_showErrorPopup;
        }
    }

    private void CloseErrorPopup()
    {
        _showErrorPopup = false;
    }
}

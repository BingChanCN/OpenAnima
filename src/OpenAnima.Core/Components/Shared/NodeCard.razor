@using OpenAnima.Core.Services
@using OpenAnima.Core.Wiring
@using OpenAnima.Core.Ports
@using OpenAnima.Contracts.Ports
@inject IPortRegistry _portRegistry
@inject EditorStateService _editorState

<g transform="translate(@Node.Position.X, @Node.Position.Y)" @onmousedown:stopPropagation>
    <!-- Background card -->
    <rect x="0" y="0"
          width="@_nodeWidth"
          height="@_nodeHeight"
          rx="8"
          fill="#1c1e2e"
          stroke="@(IsSelected ? "#6c8cff" : "#2a2d3e")"
          stroke-width="@(IsSelected ? 2 : 1)" />

    <!-- Title bar -->
    <rect x="0" y="0"
          width="@_nodeWidth"
          height="@_titleHeight"
          rx="8"
          fill="#161822"
          @onmousedown="HandleTitleBarMouseDown"
          style="cursor: move;" />

    <!-- Title text -->
    @((MarkupString)$"<text x=\"{_nodeWidth / 2}\" y=\"{_titleHeight / 2 + 4}\" fill=\"#e4e6f0\" font-size=\"13\" font-family=\"var(--font-family)\" text-anchor=\"middle\" font-weight=\"500\">{Node.ModuleName}</text>")

    <!-- Status indicator (placeholder for Phase 14) -->
    <circle cx="@(_nodeWidth - 12)" cy="@(_titleHeight / 2)" r="4" fill="#555" />

    <!-- Input ports (left side) -->
    @foreach (var (port, index) in _inputPorts.Select((p, i) => (p, i)))
    {
        var portY = _titleHeight + index * _portSpacing + _portOffsetY;

        <!-- Port circle -->
        <circle cx="0" cy="@portY" r="6"
                fill="@PortColors.GetHex(port.Type)"
                @onmouseup="@(() => HandlePortMouseUp(port))"
                style="cursor: crosshair;" />

        <!-- Port label -->
        @((MarkupString)$"<text x=\"14\" y=\"{portY + 4}\" fill=\"#8b8fa3\" font-size=\"11\" font-family=\"var(--font-family)\">{port.Name}</text>")
    }

    <!-- Output ports (right side) -->
    @foreach (var (port, index) in _outputPorts.Select((p, i) => (p, i)))
    {
        var portY = _titleHeight + index * _portSpacing + _portOffsetY;

        <!-- Port circle -->
        <circle cx="@_nodeWidth" cy="@portY" r="6"
                fill="@PortColors.GetHex(port.Type)"
                @onmousedown="@(() => HandlePortMouseDown(port))"
                style="cursor: crosshair;" />

        <!-- Port label -->
        @((MarkupString)$"<text x=\"{_nodeWidth - 14}\" y=\"{portY + 4}\" fill=\"#8b8fa3\" font-size=\"11\" font-family=\"var(--font-family)\" text-anchor=\"end\">{port.Name}</text>")
    }
</g>

@code {
    [Parameter, EditorRequired]
    public ModuleNode Node { get; set; } = null!;

    [Parameter]
    public bool IsSelected { get; set; }

    private const double _nodeWidth = 200;
    private const double _titleHeight = 28;
    private const double _portSpacing = 24;
    private const double _portOffsetY = 12;
    private const double _minNodeHeight = 80;

    private List<PortMetadata> _inputPorts = new();
    private List<PortMetadata> _outputPorts = new();
    private double _nodeHeight;

    protected override void OnParametersSet()
    {
        // Get ports for this module
        var allPorts = _portRegistry.GetPorts(Node.ModuleName);
        _inputPorts = allPorts.Where(p => p.Direction == PortDirection.Input).ToList();
        _outputPorts = allPorts.Where(p => p.Direction == PortDirection.Output).ToList();

        // Calculate node height based on port count
        var maxPorts = Math.Max(_inputPorts.Count, _outputPorts.Count);
        _nodeHeight = Math.Max(_minNodeHeight, _titleHeight + maxPorts * _portSpacing + _portOffsetY);
    }

    private void HandleTitleBarMouseDown(MouseEventArgs e)
    {
        // Convert screen coordinates to canvas coordinates
        var (canvasX, canvasY) = _editorState.ScreenToCanvas(e.ClientX, e.ClientY);
        _editorState.StartNodeDrag(Node.ModuleId, canvasX, canvasY);
    }

    private void HandlePortMouseDown(PortMetadata port)
    {
        // Start connection drag from output port
        var portPos = _editorState.GetPortPosition(Node.ModuleId, port.Name, port.Direction);
        _editorState.StartConnectionDrag(Node.ModuleId, port.Name, port.Type, portPos.X, portPos.Y);
    }

    private void HandlePortMouseUp(PortMetadata port)
    {
        // End connection drag on input port
        if (_editorState.IsDraggingConnection)
        {
            _editorState.EndConnectionDrag(Node.ModuleId, port.Name, port.Type);
        }
    }
}
